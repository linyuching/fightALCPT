<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALCPT英語能力模擬測驗</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .screen {
            display: none;
        }
        .active-screen {
            display: flex;
        }
        .progress-bar-inner {
            transition: width 0.5s ease-in-out;
        }
        .correct-answer {
            background-color: #10B981 !important; /* Green-500 */
            border-color: #059669 !important;
        }
        .incorrect-answer {
            background-color: #EF4444 !important; /* Red-500 */
            border-color: #DC2626 !important;
        }
        .selected-answer {
             background-color: #3B82F6; /* Blue-500 */
             border-color: #2563EB;
        }
        #favorites-card, #exit-confirm-card {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        #favorites-card.active, #exit-confirm-card.active {
            transform: scale(1);
            opacity: 1;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #FCD34D;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* 發音按鈕強化 */
        .speaker-btn {
            background-color: #3B82F6;
            color: white;
            border-radius: 50%;
            padding: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .speaker-btn:hover {
            background-color: #2563EB;
            transform: scale(1.1);
        }
        .speaker-btn svg {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-2 sm:p-4">

    <div class="w-full max-w-3xl mx-auto">

        <!-- Screen 0: Loading -->
        <div id="loading-screen" class="screen active-screen flex-col items-center text-center p-6 sm:p-8 bg-gray-800 rounded-2xl shadow-2xl">
            <h1 class="text-3xl sm:text-4xl font-bold text-yellow-400 mb-6">ECL 模擬測驗系統</h1>
            <div class="spinner mb-4"></div>
            <p id="loading-text" class="text-base sm:text-lg text-gray-300">正在同步雲端資料...</p>
        </div>

        <!-- Screen 1: Welcome -->
        <div id="welcome-screen" class="screen flex-col items-center text-center p-6 sm:p-8 bg-gray-800 rounded-2xl shadow-2xl">
            <h1 class="text-3xl sm:text-4xl font-bold text-yellow-400 mb-4">ECL 英語能力測驗</h1>
            <p class="text-base sm:text-lg text-gray-300 mb-8 leading-relaxed">
                請選擇測驗題庫。通過標準為 <span class="text-yellow-400 font-bold text-xl">80%</span>。<br>
                所有題目提供全選項解析及發音功能。
            </p>
            
            <div class="space-y-4 w-full max-w-sm">
                <button id="btn-quiz1" onclick="startQuiz('quiz1')" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-lg text-lg transition duration-300 transform hover:scale-105">
                    題庫 (一)：詞彙與片語 (30題)
                </button>
                <button id="btn-quiz2" onclick="startQuiz('quiz2')" class="w-full bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-3 px-6 rounded-lg text-lg transition duration-300 transform hover:scale-105">
                    題庫 (二)：文法結構 (20題)
                </button>
                <button id="btn-quiz3" onclick="startQuiz('quiz3')" class="w-full bg-teal-500 hover:bg-teal-600 text-gray-900 font-bold py-3 px-6 rounded-lg text-lg transition duration-300 transform hover:scale-105">
                    題庫 (三)：模擬聽力腳本 (20題)
                </button>
            </div>
            
            <hr class="border-gray-600 my-6 w-full max-w-sm">
            
            <div class="space-y-4 w-full max-w-sm">
                <button onclick="showFavoritesModal()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300">
                    查看我的最愛 (雲端複習)
                </button>
            </div>
             <p class="text-sm text-gray-400 mt-8 italic">堅持練習是通往成功的唯一道路！</p>
        </div>

        <!-- Screen 2: Test -->
        <div id="test-screen" class="screen flex-col w-full">
            <div class="bg-gray-800 rounded-2xl shadow-2xl p-4 sm:p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="test-title" class="text-xl sm:text-2xl font-bold text-yellow-400"></h2>
                    <div class="flex items-center space-x-2 sm:space-x-4">
                        <div id="question-counter" class="text-sm sm:text-lg text-gray-400 font-mono"></div>
                        <button onclick="pauseTest()" class="text-purple-300 hover:text-purple-200 flex items-center space-x-1 p-2 bg-gray-700 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg>
                            <span class="text-sm sm:text-lg font-mono">複習</span>
                        </button>
                        <div id="timer" class="text-base sm:text-xl font-mono bg-gray-700 px-3 sm:px-4 py-2 rounded-lg">--:--</div>
                    </div>
                </div>
                
                <div class="w-full bg-gray-700 rounded-full h-4 mb-6">
                    <div id="progress-bar" class="bg-green-500 h-4 rounded-full progress-bar-inner" style="width: 0%"></div>
                </div>

                <div id="question-container" class="text-left">
                    <div id="question-text" class="text-lg sm:text-xl mb-6 text-gray-200 min-h-[60px]"></div>
                    <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    <div id="post-answer-actions" class="mt-6 flex flex-wrap gap-2"></div>
                    <div id="post-answer-display" class="mt-4"></div>
                    <div id="keywords-display" class="mt-4"></div>
                </div>
                
                <div class="mt-8 flex justify-between items-center">
                    <button onclick="requestExitConfirmation()" class="bg-gray-700 hover:bg-gray-600 text-gray-300 font-bold py-2 px-6 rounded-lg transition duration-300">
                        &larr; 放棄測驗
                    </button>
                    <button id="next-button" onclick="nextQuestion()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-10 rounded-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        下一題
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Screen 3: Practice Complete -->
        <div id="practice-complete-screen" class="screen flex-col items-center text-center p-6 sm:p-8 bg-gray-800 rounded-2xl shadow-2xl">
            <h2 id="module-complete-title" class="text-2xl sm:text-3xl font-bold text-green-400 mb-4">測驗完成！</h2>
            <p id="module-complete-message" class="text-base sm:text-lg text-gray-300 mb-6"></p>
            <div class="text-lg sm:text-xl mb-8 p-4 bg-gray-700 rounded-lg">本次得分 / Score: <span id="module-score" class="text-xl sm:text-2xl font-bold text-yellow-400"></span></div>
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                <button onclick="backToWelcome()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                    回題庫選單
                </button>
                <button onclick="restartMission()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                    重置所有進度與收藏
                </button>
            </div>
        </div>

    </div>
    
    <!-- Favorites Modal -->
    <div id="favorites-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4" style="display: none; z-index: 998;">
        <div class="bg-gray-800 border-2 border-purple-400 rounded-2xl shadow-2xl p-6 sm:p-8 text-left transform transition-all scale-95 opacity-0 w-full max-w-2xl" id="favorites-card">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-purple-300">我的最愛單字簿</h3>
                <button onclick="hideFavoritesModal()" class="text-gray-300 hover:text-white text-3xl font-bold">&times;</button>
            </div>
            <div id="favorites-list" class="max-h-[60vh] overflow-y-auto space-y-3 p-1"></div>
        </div>
    </div>

    <!-- Exit Confirmation Modal -->
    <div id="exit-confirm-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4" style="display: none; z-index: 999;">
        <div class="bg-gray-800 border-2 border-red-500 rounded-2xl shadow-2xl p-6 sm:p-8 text-center transform transition-all scale-95 opacity-0 w-full max-w-md" id="exit-confirm-card">
            <h3 class="text-2xl font-bold text-red-400 mb-4">確定要放棄嗎？</h3>
            <p class="text-lg text-gray-300 mb-6">
                目前的測驗進度將不會被儲存。<br>
                <span class="text-yellow-400 mt-2 block font-bold">再堅持一下，您一定可以通過的！</span>
            </p>
            <div class="flex flex-col space-y-3">
                <button onclick="cancelExit()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                    繼續挑戰 (不放棄)
                </button>
                <button onclick="confirmExit()" class="bg-gray-600 hover:bg-gray-500 text-gray-300 font-bold py-2 px-6 rounded-lg transition duration-300">
                    放棄本次測驗並返回
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, collection, onSnapshot, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 全域變數 ---
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let favoriteKeywords = [];
        let currentTest = '';
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let timerInterval;
        let currentTimerValue = 0;
        let isTestPaused = false;
        let quizPassStatus = { quiz1: false, quiz2: false, quiz3: false };
        let firestoreUnsubscribe = null;

        // 題庫資料
        const alcptQuizBanks = {
            'quiz1': [
                { type: 'reading', question: "The officer wants to ____ the security procedures.", translation: "軍官想要____安全程序。", options: ["review", "remove", "reverse", "receive"], answer: 0, all_keywords: [
                    { word: 'review', translation: '複查；審查', example: 'We must review the plan.', example_translation: '我們必須審查這項計畫。' },
                    { word: 'remove', translation: '移除', example: 'Remove the battery.', example_translation: '移除電池。' },
                    { word: 'reverse', translation: '反轉；倒車', example: 'Reverse the car.', example_translation: '將車倒退。' },
                    { word: 'receive', translation: '接收', example: 'I received the signal.', example_translation: '我收到了訊號。' }
                ]},
                { type: 'reading', question: "He has a very ____ schedule this week.", translation: "他這週的行程非常____。", options: ["thick", "tight", "thin", "tidy"], answer: 1, all_keywords: [
                    { word: 'thick', translation: '厚的', example: 'a thick book', example_translation: '一本厚書。' },
                    { word: 'tight', translation: '緊湊的；緊的', example: 'I have a tight schedule.', example_translation: '我的行程很緊湊。' },
                    { word: 'thin', translation: '薄的；瘦的', example: 'a thin layer', example_translation: '薄薄的一層。' },
                    { word: 'tidy', translation: '整潔的', example: 'Keep your room tidy.', example_translation: '保持房間整潔。' }
                ]},
                { type: 'reading', question: "The mechanic said the engine is beyond ____.", translation: "技工說這引擎已經無法____了。", options: ["report", "repeat", "repair", "reply"], answer: 2, all_keywords: [
                    { word: 'report', translation: '報告', example: 'Report to your post.', example_translation: '回到你的崗位報到。' },
                    { word: 'repeat', translation: '重複', example: 'Repeat the instruction.', example_translation: '重複指令。' },
                    { word: 'repair', translation: '修理', example: 'It is beyond repair.', example_translation: '它已無法修理。' },
                    { word: 'reply', translation: '回覆', example: 'Reply to the message.', example_translation: '回覆訊息。' }
                ]},
                { type: 'reading', question: "We need to ____ the problem immediately.", translation: "我們需要立即____這個問題。", options: ["adjust", "advise", "advance", "address"], answer: 3, all_keywords: [
                    { word: 'adjust', translation: '調整', example: 'Adjust your seat.', example_translation: '調整你的座位。' },
                    { word: 'advise', translation: '建議', example: 'I advise you to wait.', example_translation: '我建議你等待。' },
                    { word: 'advance', translation: '前進；提前', example: 'They advanced slowly.', example_translation: '他們緩慢前進。' },
                    { word: 'address', translation: '處理(問題)；地址', example: 'Address the issue now.', example_translation: '現在處理這項議題。' }
                ]},
                { type: 'reading', question: "The commander will ____ the soldier's complaint.", translation: "指揮官將會____這名士兵的投訴。", options: ["look into", "look over", "look up to", "look down on"], answer: 0, all_keywords: [
                    { word: 'look into', translation: '調查', example: 'We will look into the matter.', example_translation: '我們會調查這件事。' },
                    { word: 'look over', translation: '快速瀏覽', example: 'Please look over this report.', example_translation: '請快速看一下這份報告。' },
                    { word: 'look up to', translation: '尊敬', example: 'He looks up to his father.', example_translation: '他尊敬他的父親。' },
                    { word: 'look down on', translation: '輕視', example: 'You should not look down on anyone.', example_translation: '你不應該輕視任何人。' }
                ]},
                { type: 'reading', question: "They had to ____ the exercise due to the storm.", translation: "由於暴風雨，他們不得不____演習。", options: ["call on", "call off", "call for", "call out"], answer: 1, all_keywords: [
                    { word: 'call on', translation: '拜訪；呼籲', example: 'He called on me yesterday.', example_translation: '他昨天拜訪了我。' },
                    { word: 'call off', translation: '取消', example: 'They called off the meeting.', example_translation: '他們取消了會議。' },
                    { word: 'call for', translation: '要求；需要', example: 'The job calls for patience.', example_translation: '這份工作需要耐心。' },
                    { word: 'call out', translation: '大喊；召集', example: 'He called out my name.', example_translation: '他大喊我的名字。' }
                ]},
                { type: 'reading', question: "I cannot ____ this noise any longer.", translation: "我再也無法____這種噪音了。", options: ["put on", "put off", "put up with", "put out"], answer: 2, all_keywords: [
                    { word: 'put on', translation: '穿上', example: 'Put on your jacket.', example_translation: '穿上你的夾克。' },
                    { word: 'put off', translation: '延期', example: 'Don\'t put off your homework.', example_translation: '不要拖延你的作業。' },
                    { word: 'put up with', translation: '忍受', example: 'I can\'t put up with his attitude.', example_translation: '我無法忍受他的態度。' },
                    { word: 'put out', translation: '熄滅', example: 'Put out the fire.', example_translation: '熄滅火。' }
                ]},
                { type: 'reading', question: "The patrol is in danger of ____ ammunition.", translation: "巡邏隊有____彈藥的危險。", options: ["running into", "running over", "running away", "running out of"], answer: 3, all_keywords: [
                    { word: 'running into', translation: '偶然遇見', example: 'I ran into him at the store.', example_translation: '我在商店偶然遇見他。' },
                    { word: 'running over', translation: '輾過', example: 'The car ran over a can.', example_translation: '車子輾過一個罐子。' },
                    { word: 'running away', translation: '逃跑', example: 'The thief ran away.', example_translation: '小偷跑走了。' },
                    { word: 'running out of', translation: '用完', example: 'We are running out of time.', example_translation: '我們的時間快用完了。' }
                ]},
                { type: 'reading', question: "Our vehicle ____ in the middle of the desert.", translation: "我們的車輛在沙漠中央____了。", options: ["broke down", "broke into", "broke up", "broke out"], answer: 0, all_keywords: [
                    { word: 'broke down', translation: '故障 (break down的過去式)', example: 'My car broke down.', example_translation: '我的車拋錨了。' },
                    { word: 'broke into', translation: '闖入', example: 'Someone broke into my house.', example_translation: '有人闖入我的房子。' },
                    { word: 'broke up', translation: '分手；解散', example: 'The band broke up last year.', example_translation: '那個樂團去年解散了。' },
                    { word: 'broke out', translation: '爆發', example: 'A fire broke out in the building.', example_translation: '大樓爆發了火災。' }
                ]},
                { type: 'reading', question: "The soldiers were ordered to ____ the mission at dawn.", translation: "士兵們被命令在黎明時____任務。", options: ["carry on", "carry out", "carry off", "carry over"], answer: 1, all_keywords: [
                    { word: 'carry on', translation: '繼續', example: 'Carry on with your work.', example_translation: '繼續你的工作。' },
                    { word: 'carry out', translation: '執行', example: 'They will carry out the plan.', example_translation: '他們將執行這項計畫。' },
                    { word: 'carry off', translation: '成功完成(困難的事)', example: 'She carried off the speech well.', example_translation: '她成功地完成了演講。' },
                    { word: 'carry over', translation: '延續', example: 'The meeting will carry over to tomorrow.', example_translation: '會議將延續到明天。' }
                ]},
                { type: 'reading', question: "What is the ____ of rank for that officer?", translation: "那位軍官的軍階____是什麼？", options: ["grade", "graph", "group", "ground"], answer: 0, all_keywords: [
                    { word: 'grade', translation: '等級；階級', example: 'He is a high-grade officer.', example_translation: '他是一名高級軍官。' },
                    { word: 'graph', translation: '圖表', example: 'Draw a graph.', example_translation: '畫一張圖表。' },
                    { word: 'group', translation: '團體', example: 'A group of soldiers.', example_translation: '一群士兵。' },
                    { word: 'ground', translation: '地面', example: 'Sit on the ground.', example_translation: '坐在地上。' }
                ]},
                { type: 'reading', question: "The General is very ____; he expects everyone to obey.", translation: "將軍非常____；他要求每個人都要服從。", options: ["strong", "strict", "strange", "straight"], answer: 1, all_keywords: [
                    { word: 'strong', translation: '強壯的', example: 'a strong man', example_translation: '強壯的男人。' },
                    { word: 'strict', translation: '嚴格的', example: 'He is a strict teacher.', example_translation: '他是一位嚴格的老師。' },
                    { word: 'strange', translation: '奇怪的', example: 'a strange noise', example_translation: '奇怪的噪音。' },
                    { word: 'straight', translation: '筆直的', example: 'a straight line', example_translation: '一條直線。' }
                ]},
                { type: 'reading', question: "Please ____ your seatbelt before the flight.", translation: "請在飛行前____您的安全帶。", options: ["finish", "follow", "fasten", "forget"], answer: 2, all_keywords: [
                    { word: 'finish', translation: '完成', example: 'Finish your meal.', example_translation: '吃完你的飯。' },
                    { word: 'follow', translation: '跟隨', example: 'Follow me.', example_translation: '跟我來。' },
                    { word: 'fasten', translation: '繫緊', example: 'Fasten your seatbelt.', example_translation: '繫好安全帶。' },
                    { word: 'forget', translation: '忘記', example: 'Don\'t forget.', example_translation: '別忘了。' }
                ]},
                { type: 'reading', question: "The new equipment is very ____ to use.", translation: "這台新設備用起來非常____。", options: ["hard", "high", "hot", "handy"], answer: 3, all_keywords: [
                    { word: 'hard', translation: '硬的；困難的', example: 'It is hard work.', example_translation: '這是辛苦的工作。' },
                    { word: 'high', translation: '高的', example: 'a high mountain', example_translation: '一座高山。' },
                    { word: 'hot', translation: '熱的', example: 'hot water', example_translation: '熱水。' },
                    { word: 'handy', translation: '便利的；手邊的', example: 'It is very handy.', example_translation: '這非常方便。' }
                ]},
                { type: 'reading', question: "The troops had to ____ their positions at night.", translation: "部隊必須在夜間____他們的陣地。", options: ["abandon", "accept", "admire", "advise"], answer: 0, all_keywords: [
                    { word: 'abandon', translation: '放棄；拋棄', example: 'They abandoned the ship.', example_translation: '他們棄船了。' },
                    { word: 'accept', translation: '接受', example: 'Accept the offer.', example_translation: '接受提議。' },
                    { word: 'admire', translation: '欽佩', example: 'I admire your courage.', example_translation: '我欽佩你的勇氣。' },
                    { word: 'advise', translation: '建議', example: 'Advise the commander.', example_translation: '建議指揮官。' }
                ]},
                { type: 'reading', question: "The map showed an ____ path through the woods.", options: ["old", "alternative", "easy", "long"], answer: 1, all_keywords: [
                    { word: 'old', translation: '舊的', example: 'old clothes', example_translation: '舊衣服。' },
                    { word: 'alternative', translation: '替代的', example: 'an alternative route', example_translation: '一條替代路線。' },
                    { word: 'easy', translation: '容易的', example: 'an easy task', example_translation: '一項容易的任務。' },
                    { word: 'long', translation: '長的', example: 'a long road', example_translation: '一條長路。' }
                ]},
                { type: 'reading', question: "The medicine will ____ your pain.", options: ["help", "hurt", "hinder", "handle"], answer: 0, all_keywords: [
                    { word: 'help', translation: '幫助', example: 'Can you help me?', example_translation: '你能幫我嗎？' },
                    { word: 'hurt', translation: '受傷；疼痛', example: 'My leg hurts.', example_translation: '我的腳痛。' },
                    { word: 'hinder', translation: '阻礙', example: 'Nothing can hinder us.', example_translation: '沒什麼能阻礙我們。' },
                    { word: 'handle', translation: '處理', example: 'Handle with care.', example_translation: '小心輕放。' }
                ]},
                { type: 'reading', question: "He is a very ____ student; he always studies hard.", options: ["lazy", "diligent", "noisy", "fast"], answer: 1, all_keywords: [
                    { word: 'lazy', translation: '懶惰的', example: 'Don\'t be lazy.', example_translation: '不要懶惰。' },
                    { word: 'diligent', translation: '勤勉的', example: 'a diligent worker', example_translation: '一名勤奮的工人。' },
                    { word: 'noisy', translation: '吵鬧的', example: 'a noisy room', example_translation: '一個吵鬧的房間。' },
                    { word: 'fast', translation: '快的', example: 'a fast car', example_translation: '一輛快車。' }
                ]},
                { type: 'reading', question: "The noise ____ the entire neighborhood.", options: ["disturbed", "delivered", "destroyed", "discussed"], answer: 0, all_keywords: [
                    { word: 'disturbed', translation: '打擾', example: 'The noise disturbed him.', example_translation: '噪音打擾了他。' },
                    { word: 'delivered', translation: '運送', example: 'He delivered the mail.', example_translation: '他送了信。' },
                    { word: 'destroyed', translation: '摧毀', example: 'The fire destroyed the house.', example_translation: '火災摧毀了房子。' },
                    { word: 'discussed', translation: '討論', example: 'They discussed the plan.', example_translation: '他們討論了計畫。' }
                ]},
                { type: 'reading', question: "It is ____ to see a rainbow after the rain.", options: ["rare", "right", "common", "correct"], answer: 2, all_keywords: [
                    { word: 'rare', translation: '稀有的', example: 'a rare bird', example_translation: '一隻稀有的鳥。' },
                    { word: 'right', translation: '正確的；右邊', example: 'the right answer', example_translation: '正確答案。' },
                    { word: 'common', translation: '常見的', example: 'a common mistake', example_translation: '一個常見的錯誤。' },
                    { word: 'correct', translation: '正確的', example: 'Is this correct?', example_translation: '這正確嗎？' }
                ]}
            ],
            'quiz2': [
                { type: 'reading', question: "If the reinforcements ____ on time, we would have won.", translation: "如果援軍準時____，我們本來會贏的。", options: ["have arrived", "arrived", "had arrived", "would arrive"], answer: 2, all_keywords: [
                    { word: 'have arrived', translation: '已經到達 (現在完成式)', example: 'They have arrived now.', example_translation: '他們現在到了。' },
                    { word: 'arrived', translation: '到達 (過去式)', example: 'They arrived late.', example_translation: '他們遲到了。' },
                    { word: 'had arrived', translation: '已經到達 (過去完成式)', example: 'If he had arrived earlier...', example_translation: '如果他早點到...' },
                    { word: 'would arrive', translation: '將會到達 (假設)', example: 'They said they would arrive.', example_translation: '他們說他們會到。' }
                ]},
                { type: 'reading', question: "The General ordered the supplies ____ immediately.", translation: "將軍下令補給品要立即____。", options: ["sent", "to be sent", "send", "sending"], answer: 1, all_keywords: [
                    { word: 'sent', translation: '送 (過去式)', example: 'I sent the mail.', example_translation: '我寄了信。' },
                    { word: 'to be sent', translation: '被送出 (不定詞被動)', example: 'I ordered it to be sent.', example_translation: '我下令將它送出。' },
                    { word: 'send', translation: '送 (原形)', example: 'Please send help.', example_translation: '請送援。' },
                    { word: 'sending', translation: '正在送', example: 'He is sending it.', example_translation: '他正在送。' }
                ]}
            ],
            'quiz3': [
                { type: 'listening', question: "Man: Is the fuel truck ready?\nWoman: Not yet, it's being inspected.\n\n(Narrator): What is happening to the truck?", translation: "男：油罐車準備好了嗎？\n女：還沒，正在接受檢查。\n\n(旁白)：這輛卡車正在發生什麼事？", options: ["(A) It is being filled.", "(B) It is being checked.", "(C) It is being washed.", "(D) It is being driven."], answer: 1, all_keywords: [
                    { word: 'inspected', translation: '檢查', example: 'The site was inspected.', example_translation: '現場被視察了。' },
                    { word: 'checked', translation: '檢查', example: 'Check your gear.', example_translation: '檢查裝備。' }
                ]}
            ]
        };

        const synth = new Tone.Synth().toDestination();

        // --- Core Functions ---
        async function initializeAppFirebase() {
            try {
                const userProvidedConfig = {
                    apiKey: "AIzaSyDQSAW63lnKd3aCCiCt7pSmRa6ZPqOiIZI",
                    authDomain: "alcpt-f9d8d.firebaseapp.com",
                    projectId: "alcpt-f9d8d",
                    storageBucket: "alcpt-f9d8d.firebasestorage.app",
                    messagingSenderId: "885828022963",
                    appId: "1:885828022963:web:b18d3e49a19d3840d5b6c6"
                };

                const config = (typeof __firebase_config !== 'undefined' && __firebase_config) 
                    ? JSON.parse(__firebase_config) 
                    : userProvidedConfig;

                app = initializeApp(config);
                db = getFirestore(app);
                auth = getAuth(app);
                const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'github-ecl-app';

                await signInAnonymously(auth);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        loadFavoriteKeywords(currentAppId, userId);
                        showScreen('welcome-screen');
                    }
                });

            } catch (error) {
                console.error("Firebase Init Error:", error);
                document.getElementById('loading-text').innerHTML = `載入失敗，請確認 Firebase 設定。<br><small>${error.message}</small>`;
            }
        }

        function loadFavoriteKeywords(id, uid) {
            if (firestoreUnsubscribe) firestoreUnsubscribe();
            const colRef = collection(db, 'artifacts', id, 'users', uid, 'favorites');
            firestoreUnsubscribe = onSnapshot(colRef, (snap) => {
                favoriteKeywords = snap.docs.map(doc => doc.data());
                // 如果複習視窗開著，即時更新
                if (document.getElementById('favorites-modal').style.display === 'flex') showFavoritesModal();
                // 如果測驗解析開著，即時更新愛心
                const kwDisp = document.getElementById('keywords-display');
                if (kwDisp && kwDisp.innerHTML !== '') {
                    const currentQ = currentQuestions[currentQuestionIndex];
                    if (currentQ) renderKeywords(currentQ.all_keywords);
                }
            });
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => {
                s.style.display = 'none';
                s.classList.remove('active-screen');
            });
            const target = document.getElementById(id);
            if (target) {
                target.style.display = 'flex';
                target.classList.add('active-screen');
            }
        }

        function startQuiz(quizId) {
            if (!isAuthReady) return;
            currentTest = quizId;
            currentQuestionIndex = 0;
            score = 0;
            currentQuestions = [...alcptQuizBanks[quizId]].sort(() => Math.random() - 0.5);
            
            const titles = { quiz1: '題庫(一): 詞彙片語', quiz2: '題庫(二): 文法結構', quiz3: '題庫(三): 聽力腳本' };
            document.getElementById('test-title').textContent = titles[quizId];
            
            loadQuestion();
            startTimer(currentQuestions.length * 45);
            showScreen('test-screen');
        }

        function loadQuestion() {
            document.getElementById('next-button').disabled = true;
            document.getElementById('options-container').innerHTML = '';
            document.getElementById('post-answer-actions').innerHTML = '';
            document.getElementById('post-answer-display').innerHTML = '';
            document.getElementById('keywords-display').innerHTML = '';
            
            const q = currentQuestions[currentQuestionIndex];
            const progress = (currentQuestionIndex / currentQuestions.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('question-counter').textContent = `Q: ${currentQuestionIndex + 1}/${currentQuestions.length}`;
            
            document.getElementById('question-text').innerHTML = q.question.replace(/\n/g, '<br>');
            
            q.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = 'w-full p-4 text-left bg-gray-700 hover:bg-gray-600 rounded-lg border-2 border-gray-600 transition duration-200';
                btn.textContent = opt;
                btn.onclick = () => selectAnswer(idx);
                document.getElementById('options-container').appendChild(btn);
            });
        }

        function selectAnswer(idx) {
            const q = currentQuestions[currentQuestionIndex];
            const isCorrect = idx === q.answer;
            if (isCorrect) score++;
            
            const btns = document.getElementById('options-container').querySelectorAll('button');
            btns.forEach((b, i) => {
                b.disabled = true;
                if (i === q.answer) b.classList.add('correct-answer');
                else if (i === idx) b.classList.add('incorrect-answer');
            });

            const correctText = q.options[q.answer];
            const ttsText = q.type === 'listening' ? q.question.split('(Narrator):')[1]?.trim() || q.question : q.question.replace('____', correctText);
            const escapedTTS = ttsText.replace(/'/g, "\\'").replace(/\n/g, ' ');

            // 發音按鈕更顯眼
            document.getElementById('post-answer-display').innerHTML = `
                <div class="p-4 bg-gray-900 rounded-xl border border-gray-700">
                    <div class="flex justify-between items-center mb-3">
                         <p class="font-bold text-yellow-400">正確答案解答：</p>
                         <button onclick="speak('${escapedTTS}')" class="speaker-btn" title="聽發音">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072M20 4a9 9 0 010 16M4 4a9 9 0 0116 0" /></svg>
                         </button>
                    </div>
                    <p class="text-gray-300 italic mb-2">${q.type === 'listening' ? q.question.replace(/\n/g, '<br>') : q.question.replace('____', `<span class='text-yellow-400 font-bold underline'>${correctText}</span>`)}</p>
                    <button onclick="this.nextElementSibling.classList.toggle('hidden')" class="text-xs text-cyan-400 underline">顯示翻譯</button>
                    <p class="hidden text-gray-400 mt-2 text-sm">${q.translation ? q.translation.replace('____', correctText) : '暫無翻譯'}</p>
                </div>
            `;

            const kwBtn = document.createElement('button');
            kwBtn.className = 'bg-teal-600 hover:bg-teal-500 text-white font-bold py-2 px-6 rounded-lg transition shadow-lg';
            kwBtn.textContent = '查看全選項解析';
            kwBtn.onclick = () => renderKeywords(q.all_keywords);
            document.getElementById('post-answer-actions').appendChild(kwBtn);

            document.getElementById('next-button').disabled = false;
            playSound(isCorrect ? 'correct' : 'incorrect');
        }

        function renderKeywords(keywords) {
            if (!keywords) return;
            let html = '<div class="space-y-3 mt-4 animate-fade-in">';
            keywords.forEach(kw => {
                const isFav = favoriteKeywords.some(f => f.word === kw.word);
                const kwJSON = JSON.stringify(kw).replace(/'/g, "\\'");
                html += `
                    <div class="p-4 bg-gray-700 rounded-lg border border-gray-600 flex justify-between items-center shadow-md">
                        <div class="flex-grow">
                            <div class="flex items-center space-x-3">
                                <span class="text-teal-300 font-bold text-lg">${kw.word}</span>
                                <button onclick="speak('${kw.word.replace(/'/g, "\\'")}')" class="speaker-btn p-1 h-8 w-8" title="單字發音">
                                    <svg fill="currentColor" viewBox="0 0 20 20"><path d="M11 5L6 9H2v2h4l5 4V5z"/></svg>
                                </button>
                                <span class="text-gray-300 font-medium">${kw.translation}</span>
                            </div>
                            <p class="text-xs text-gray-400 mt-1 italic">${kw.example}</p>
                            <p class="text-xs text-gray-500">${kw.example_translation}</p>
                        </div>
                        <button onclick='toggleFavorite(${kwJSON})' class="ml-2 hover:scale-110 transition p-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 ${isFav?'text-red-500':'text-gray-500 opacity-50'}" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>
                `;
            });
            html += '</div>';
            document.getElementById('keywords-display').innerHTML = html;
        }

        async function toggleFavorite(kw) {
            const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'github-ecl-app';
            // 檔名/ID 安全化
            const docId = kw.word.replace(/[\/ \(\)']/g, '_');
            const docRef = doc(db, 'artifacts', currentAppId, 'users', userId, 'favorites', docId);
            
            const isAlreadyFav = favoriteKeywords.some(f => f.word === kw.word);
            
            try {
                if (isAlreadyFav) {
                    await deleteDoc(docRef);
                } else {
                    await setDoc(docRef, kw);
                }
                // renderKeywords 會由 loadFavoriteKeywords 的 onSnapshot 自動觸發重新渲染
            } catch (err) {
                console.error("收藏失敗:", err);
            }
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < currentQuestions.length) loadQuestion();
            else finishQuiz();
        }

        function finishQuiz() {
            clearInterval(timerInterval);
            const accuracy = Math.round((score / currentQuestions.length) * 100);
            const isPassed = accuracy >= 80;
            if (isPassed) quizPassStatus[currentTest] = true;

            const allPassed = quizPassStatus.quiz1 && quizPassStatus.quiz2 && quizPassStatus.quiz3;
            
            const titleEl = document.getElementById('module-complete-title');
            const msgEl = document.getElementById('module-complete-message');
            
            titleEl.textContent = isPassed ? "測驗通過！(Passed)" : "未通過 (Failed)";
            titleEl.className = `text-2xl sm:text-3xl font-bold mb-4 ${isPassed?'text-green-400':'text-red-400'}`;
            
            let finalMsg = `得分率：${accuracy}%. (${score}/${currentQuestions.length} 題)`;
            if (isPassed) {
                finalMsg += `<br><span class="text-green-300 font-bold">恭喜！您已達標。</span>`;
                if (allPassed) {
                    finalMsg += `<br><br><div class="p-4 bg-yellow-900 border border-yellow-500 rounded-lg text-yellow-200 font-bold shadow-xl">恭喜通過本日所有 ECL 練習！不要忘記到「我的最愛」區複習喔！</div>`;
                }
                playSound('success');
            } else {
                finalMsg += `<br><span class="text-red-300 font-bold">很遺憾，ECL 標準需達 80%。<br>請再測驗一次 加強練習！</span>`;
            }
            msgEl.innerHTML = finalMsg;
            document.getElementById('module-score').textContent = `${accuracy}%`;
            showScreen('practice-complete-screen');
        }

        function startTimer(sec) {
            currentTimerValue = sec;
            updateTimerUI();
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (!isTestPaused) {
                    currentTimerValue--;
                    updateTimerUI();
                    if (currentTimerValue <= 0) { clearInterval(timerInterval); finishQuiz(); }
                }
            }, 1000);
        }

        function updateTimerUI() {
            const m = Math.floor(currentTimerValue / 60);
            const s = currentTimerValue % 60;
            document.getElementById('timer').textContent = `${m}:${s < 10 ? '0' + s : s}`;
        }

        function pauseTest() { isTestPaused = true; showFavoritesModal(); }
        
        function requestExitConfirmation() {
            isTestPaused = true;
            document.getElementById('exit-confirm-modal').style.display = 'flex';
            setTimeout(() => document.getElementById('exit-confirm-card').classList.add('active'), 10);
        }

        function cancelExit() {
            document.getElementById('exit-confirm-card').classList.remove('active');
            setTimeout(() => { document.getElementById('exit-confirm-modal').style.display = 'none'; isTestPaused = false; }, 300);
        }

        function confirmExit() {
            clearInterval(timerInterval);
            document.getElementById('exit-confirm-modal').style.display = 'none';
            backToWelcome();
        }

        function backToWelcome() {
            const updateBtn = (id, passed) => {
                const btn = document.getElementById(id);
                if (passed) {
                    btn.className = `w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300`;
                    if (!btn.textContent.includes('(已通過)')) btn.textContent += ' (已通過)';
                }
            };
            updateBtn('btn-quiz1', quizPassStatus.quiz1);
            updateBtn('btn-quiz2', quizPassStatus.quiz2);
            updateBtn('btn-quiz3', quizPassStatus.quiz3);
            showScreen('welcome-screen');
        }

        async function restartMission() {
            const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'github-ecl-app';
            const snaps = await getDocs(collection(db, 'artifacts', currentAppId, 'users', userId, 'favorites'));
            const batch = writeBatch(db);
            snaps.forEach(d => batch.delete(d.ref));
            await batch.commit();
            location.reload();
        }

        function speak(txt) {
            if (!txt) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(txt);
            u.lang = 'en-US';
            u.rate = 0.85;
            window.speechSynthesis.speak(u);
        }

        function playSound(type) {
            try {
                if (type === 'correct') synth.triggerAttackRelease("C5", "8n");
                else if (type === 'incorrect') synth.triggerAttackRelease("A3", "8n");
                else if (type === 'success') {
                    const now = Tone.now();
                    synth.triggerAttackRelease("C4", "8n", now);
                    synth.triggerAttackRelease("E4", "8n", now + 0.1);
                    synth.triggerAttackRelease("G4", "8n", now + 0.2);
                }
            } catch(e) {}
        }

        function showFavoritesModal() {
            const list = document.getElementById('favorites-list');
            list.innerHTML = favoriteKeywords.length === 0 ? '<p class="text-gray-500 text-center py-10">尚無收藏單字</p>' : '';
            favoriteKeywords.forEach(kw => {
                const item = document.createElement('div');
                item.className = 'p-4 bg-gray-900 rounded-lg border border-gray-700 mb-2 flex justify-between items-center';
                item.innerHTML = `
                    <div>
                        <div class="flex items-center space-x-2">
                            <p class="text-teal-300 font-bold">${kw.word}</p>
                            <button onclick="speak('${kw.word.replace(/'/g, "\\'")}')" class="text-blue-400"><svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20"><path d="M11 5L6 9H2v2h4l5 4V5z"/></svg></button>
                        </div>
                        <p class="text-gray-400 text-sm">${kw.translation}</p>
                    </div>
                    <button onclick='toggleFavorite(${JSON.stringify(kw).replace(/'/g, "\\'")})' class="text-red-500 font-bold px-3 py-1 bg-red-900 bg-opacity-30 rounded hover:bg-opacity-50">移除</button>`;
                list.appendChild(item);
            });
            document.getElementById('favorites-modal').style.display = 'flex';
            setTimeout(() => document.getElementById('favorites-card').classList.add('active'), 10);
        }

        function hideFavoritesModal() {
            document.getElementById('favorites-card').classList.remove('active');
            setTimeout(() => { 
                document.getElementById('favorites-modal').style.display = 'none'; 
                isTestPaused = false; 
            }, 300);
        }

        // Global exports
        window.startQuiz = startQuiz;
        window.nextQuestion = nextQuestion;
        window.backToWelcome = backToWelcome;
        window.restartMission = restartMission;
        window.speak = speak;
        window.showFavoritesModal = showFavoritesModal;
        window.hideFavoritesModal = hideFavoritesModal;
        window.toggleFavorite = toggleFavorite;
        window.pauseTest = pauseTest;
        window.requestExitConfirmation = requestExitConfirmation;
        window.cancelExit = cancelExit;
        window.confirmExit = confirmExit;

        // 啟動應用
        window.onload = initializeAppFirebase;
    </script>
</body>
</html>
