<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALCPT è‹±èªèƒ½åŠ›æ¨¡æ“¬æ¸¬é©—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .screen {
            display: none;
        }
        .active-screen {
            display: flex;
        }
        .progress-bar-inner {
            transition: width 0.5s ease-in-out;
        }
        .correct-answer {
            background-color: #10B981 !important; /* Green-500 */
            border-color: #059669 !important;
        }
        .incorrect-answer {
            background-color: #EF4444 !important; /* Red-500 */
            border-color: #DC2626 !important;
        }
        .selected-answer {
             background-color: #3B82F6; /* Blue-500 */
             border-color: #2563EB;
        }
        #favorites-card, #exit-confirm-card {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        #favorites-card.active, #exit-confirm-card.active {
            transform: scale(1);
            opacity: 1;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #FCD34D;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* å¯æ„›ç›´è¦ºçš„ç™¼éŸ³æŒ‰éˆ•æ¨£å¼ */
        .cute-speaker-btn {
            background: linear-gradient(135deg, #60A5FA 0%, #3B82F6 100%);
            color: white;
            border-radius: 14px;
            padding: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 0px #2563EB;
            cursor: pointer;
            border: none;
        }
        .cute-speaker-btn:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 6px 0px #2563EB;
        }
        .cute-speaker-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0px #2563EB;
        }
        .cute-speaker-btn svg {
            width: 22px;
            height: 22px;
            filter: drop-shadow(0 1px 1px rgba(0,0,0,0.2));
        }

        /* äº’å‹•å¼å–®å­— */
        .clickable-word {
            cursor: pointer;
            padding: 2px 4px;
            margin: 0 1px;
            border-radius: 6px;
            transition: all 0.2s;
            display: inline-block;
            border-bottom: 2px dashed rgba(255, 255, 255, 0.3);
        }
        .clickable-word:hover {
            background-color: rgba(59, 130, 246, 0.4);
            color: #93C5FD;
            border-bottom-color: #93C5FD;
        }
        .word-highlight {
            background-color: #F59E0B !important;
            color: #000 !important;
            font-weight: bold;
            border-bottom: none;
        }

        /* è§£ææ¨™ç±¤ */
        .translation-tag {
            background-color: rgba(245, 158, 11, 0.15);
            color: #FBBF24;
            padding: 4px 12px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            border: 1px solid rgba(245, 158, 11, 0.4);
            display: inline-block;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-2 sm:p-4">

    <div class="w-full max-w-3xl mx-auto">

        <!-- Screen 0: Loading -->
        <div id="loading-screen" class="screen active-screen flex-col items-center text-center p-6 sm:p-8 bg-gray-800 rounded-2xl shadow-2xl">
            <h1 class="text-3xl sm:text-4xl font-bold text-yellow-400 mb-6">ALCPT æ¨¡æ“¬æ¸¬é©—ç³»çµ±</h1>
            <div class="spinner mb-4"></div>
            <p id="loading-text" class="text-base sm:text-lg text-gray-300">æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...</p>
        </div>

        <!-- Screen 1: Welcome -->
        <div id="welcome-screen" class="screen flex-col items-center text-center p-6 sm:p-8 bg-gray-800 rounded-2xl shadow-2xl">
            <h1 class="text-3xl sm:text-4xl font-bold text-yellow-400 mb-4">ALCPT è‹±èªèƒ½åŠ›æ¸¬é©—</h1>
            <p class="text-base sm:text-lg text-gray-300 mb-8 leading-relaxed">
                è«‹é¸æ“‡æ¸¬é©—é¡Œåº«ã€‚é€šéæ¨™æº–ç‚º <span class="text-yellow-400 font-bold text-xl">80%</span>ã€‚<br>
                é»é¸é¡Œç›®å–®å­—å¯æŸ¥çœ‹ç¿»è­¯èˆ‡è½ç™¼éŸ³ã€‚
            </p>
            
            <div class="space-y-4 w-full max-w-sm">
                <button id="btn-quiz1" onclick="startQuiz('quiz1')" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-lg text-lg transition duration-300 transform hover:scale-105">
                    é¡Œåº« (ä¸€)ï¼šè©å½™èˆ‡ç‰‡èª (30é¡Œ)
                </button>
                <button id="btn-quiz2" onclick="startQuiz('quiz2')" class="w-full bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-3 px-6 rounded-lg text-lg transition duration-300 transform hover:scale-105">
                    é¡Œåº« (äºŒ)ï¼šæ–‡æ³•çµæ§‹ (20é¡Œ)
                </button>
                <button id="btn-quiz3" onclick="startQuiz('quiz3')" class="w-full bg-teal-500 hover:bg-teal-600 text-gray-900 font-bold py-3 px-6 rounded-lg text-lg transition duration-300 transform hover:scale-105">
                    é¡Œåº« (ä¸‰)ï¼šè½åŠ›æ¸¬é©—è…³æœ¬ (20é¡Œ)
                </button>
            </div>
            
            <hr class="border-gray-600 my-6 w-full max-w-sm">
            
            <div class="space-y-4 w-full max-w-sm">
                <button onclick="showFavoritesModal()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300">
                    æˆ‘çš„æœ€æ„›å–®å­—ç°¿ (é›²ç«¯è¤‡ç¿’)
                </button>
            </div>
        </div>

        <!-- Screen 2: Test -->
        <div id="test-screen" class="screen flex-col w-full">
            <div class="bg-gray-800 rounded-2xl shadow-2xl p-4 sm:p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="test-title" class="text-xl sm:text-2xl font-bold text-yellow-400"></h2>
                    <div class="flex items-center space-x-2 sm:space-x-4">
                        <div id="question-counter" class="text-sm sm:text-lg text-gray-400 font-mono"></div>
                        <button onclick="pauseTest()" class="text-purple-300 hover:text-purple-200 flex items-center space-x-1 p-2 bg-gray-700 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg>
                            <span class="text-sm sm:text-lg font-mono">æ”¶è—</span>
                        </button>
                        <div id="timer" class="text-base sm:text-xl font-mono bg-gray-700 px-3 sm:px-4 py-2 rounded-lg">--:--</div>
                    </div>
                </div>
                
                <div class="w-full bg-gray-700 rounded-full h-4 mb-6">
                    <div id="progress-bar" class="bg-green-500 h-4 rounded-full progress-bar-inner" style="width: 0%"></div>
                </div>

                <div id="question-container" class="text-left">
                    <div id="word-tooltip" class="hidden mb-4 p-4 bg-blue-800 border-l-4 border-blue-300 rounded shadow-2xl text-blue-50 flex justify-between items-center transition-all">
                        <span id="tooltip-content" class="text-base"></span>
                        <button onclick="document.getElementById('word-tooltip').classList.add('hidden')" class="text-blue-200 hover:text-white ml-2 text-xl font-bold">&times;</button>
                    </div>

                    <div id="question-text" class="text-lg sm:text-xl mb-6 text-gray-200 min-h-[60px] leading-relaxed"></div>
                    <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    <div id="post-answer-actions" class="mt-6 flex flex-wrap gap-2"></div>
                    <div id="post-answer-display" class="mt-4"></div>
                    <div id="keywords-display" class="mt-4"></div>
                </div>
                
                <div class="mt-8 flex justify-between items-center">
                    <button onclick="requestExitConfirmation()" class="bg-gray-700 hover:bg-gray-600 text-gray-300 font-bold py-2 px-6 rounded-lg transition duration-300">
                        &larr; æ”¾æ£„æ¸¬é©—
                    </button>
                    <button id="next-button" onclick="nextQuestion()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-10 rounded-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        ä¸‹ä¸€é¡Œ
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Screen 3: Practice Complete -->
        <div id="practice-complete-screen" class="screen flex-col items-center text-center p-6 sm:p-8 bg-gray-800 rounded-2xl shadow-2xl">
            <h2 id="module-complete-title" class="text-2xl sm:text-3xl font-bold text-green-400 mb-4">æ¸¬é©—å®Œæˆï¼</h2>
            <p id="module-complete-message" class="text-base sm:text-lg text-gray-300 mb-6"></p>
            <div class="text-lg sm:text-xl mb-8 p-4 bg-gray-700 rounded-lg">æœ¬æ¬¡å¾—åˆ† / Score: <span id="module-score" class="text-xl sm:text-2xl font-bold text-yellow-400"></span></div>
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                <button onclick="backToWelcome()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                    å›é¡Œåº«é¸å–®
                </button>
                <button onclick="restartMission()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                    é‡ç½®é€²åº¦èˆ‡æˆ‘çš„æœ€æ„›
                </button>
            </div>
        </div>

    </div>
    
    <!-- Favorites Modal -->
    <div id="favorites-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4" style="display: none; z-index: 998;">
        <div class="bg-gray-800 border-2 border-purple-400 rounded-2xl shadow-2xl p-6 sm:p-8 text-left transform transition-all scale-95 opacity-0 w-full max-w-2xl" id="favorites-card">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-purple-300">æˆ‘çš„æœ€æ„›å–®å­—ç°¿</h3>
                <button onclick="hideFavoritesModal()" class="text-gray-300 hover:text-white text-3xl font-bold">&times;</button>
            </div>
            <div id="favorites-list" class="max-h-[60vh] overflow-y-auto space-y-3 p-1"></div>
        </div>
    </div>

    <!-- Exit Confirmation Modal -->
    <div id="exit-confirm-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4" style="display: none; z-index: 999;">
        <div class="bg-gray-800 border-2 border-red-500 rounded-2xl shadow-2xl p-6 sm:p-8 text-center transform transition-all scale-95 opacity-0 w-full max-w-md" id="exit-confirm-card">
            <h3 class="text-2xl font-bold text-red-400 mb-4">ç¢ºå®šè¦æ”¾æ£„å—ï¼Ÿ</h3>
            <p class="text-lg text-gray-300 mb-6">
                ç›®å‰çš„æ¸¬é©—é€²åº¦å°‡ä¸æœƒè¢«å„²å­˜ã€‚<br>
                <span class="text-yellow-400 mt-2 block font-bold">å†å …æŒä¸€ä¸‹ï¼Œæ‚¨ä¸€å®šå¯ä»¥é€šéçš„ï¼</span>
            </p>
            <div class="flex flex-col space-y-3">
                <button onclick="cancelExit()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                    ç¹¼çºŒæŒ‘æˆ° (ä¸æ”¾æ£„)
                </button>
                <button onclick="confirmExit()" class="bg-gray-600 hover:bg-gray-500 text-gray-300 font-bold py-2 px-6 rounded-lg transition duration-300">
                    æ”¾æ£„æœ¬æ¬¡æ¸¬é©—ä¸¦è¿”å›
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, collection, onSnapshot, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- å…¨åŸŸè®Šæ•¸ ---
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let favoriteKeywords = [];
        let currentTest = '';
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let timerInterval;
        let currentTimerValue = 0;
        let isTestPaused = false;
        let quizPassStatus = { quiz1: false, quiz2: false, quiz3: false };
        let firestoreUnsubscribe = null;

        // é¡Œåº«è³‡æ–™ (ç­”æ¡ˆå·²éš¨æ©Ÿåˆ†é…)
        const alcptQuizBanks = {
            'quiz1': [
                { type: 'reading', question: "The officer wants to ____ the security procedures.", translation: "è»å®˜æƒ³è¦è¤‡æŸ¥å®‰å…¨ç¨‹åºã€‚", options: ["review", "remove", "reverse", "receive"], answer: 0, all_keywords: [
                    { word: 'review', translation: 'è¤‡æŸ¥ï¼›å¯©æŸ¥', example: 'We must review the plan.', example_translation: 'æˆ‘å€‘å¿…é ˆå¯©æŸ¥é€™é …è¨ˆç•«ã€‚' },
                    { word: 'remove', translation: 'ç§»é™¤', example: 'Remove the battery.', example_translation: 'ç§»é™¤é›»æ± ã€‚' },
                    { word: 'reverse', translation: 'åè½‰ï¼›å€’è»Š', example: 'Reverse the car.', example_translation: 'å°‡è»Šå€’é€€ã€‚' },
                    { word: 'receive', translation: 'æ¥æ”¶', example: 'I received the signal.', example_translation: 'æˆ‘æ”¶åˆ°äº†è¨Šè™Ÿã€‚' }
                ]},
                { type: 'reading', question: "He has a very ____ schedule this week.", translation: "ä»–é€™é€±çš„è¡Œç¨‹éå¸¸ç·Šæ¹Šã€‚", options: ["thick", "tight", "thin", "tidy"], answer: 1, all_keywords: [
                    { word: 'thick', translation: 'åšçš„', example: 'a thick book.', example_translation: 'ä¸€æœ¬åšæ›¸ã€‚' },
                    { word: 'tight', translation: 'ç·Šæ¹Šçš„ï¼›ç·Šçš„', example: 'I have a tight schedule.', example_translation: 'æˆ‘çš„è¡Œç¨‹å¾ˆç·Šæ¹Šã€‚' },
                    { word: 'thin', translation: 'è–„çš„ï¼›ç˜¦çš„', example: 'a thin layer.', example_translation: 'è–„è–„çš„ä¸€å±¤ã€‚' },
                    { word: 'tidy', translation: 'æ•´æ½”çš„', example: 'Keep your room tidy.', example_translation: 'ä¿æŒæˆ¿é–“æ•´æ½”ã€‚' }
                ]},
                { type: 'reading', question: "The commander will ____ the soldier's complaint.", translation: "æŒ‡æ®å®˜å°‡æœƒèª¿æŸ¥é€™åå£«å…µçš„æŠ•è¨´ã€‚", options: ["look over", "look up to", "look into", "look down on"], answer: 2, all_keywords: [
                    { word: 'look over', translation: 'å¿«é€Ÿç€è¦½', example: 'Look over the report.', example_translation: 'ç€è¦½é€™ä»½å ±å‘Šã€‚' },
                    { word: 'look up to', translation: 'å°Šæ•¬', example: 'I look up to my father.', example_translation: 'æˆ‘å°Šæ•¬æˆ‘çš„çˆ¶è¦ªã€‚' },
                    { word: 'look into', translation: 'èª¿æŸ¥ (ç‰‡èª)', example: 'The police are looking into the case.', example_translation: 'è­¦æ–¹æ­£åœ¨èª¿æŸ¥é€™èµ·æ¡ˆä»¶ã€‚' },
                    { word: 'look down on', translation: 'è¼•è¦–', example: 'Don\'t look down on others.', example_translation: 'ä¸è¦è¼•è¦–ä»–äººã€‚' }
                ]},
                { type: 'reading', question: "They had to ____ the exercise due to the storm.", translation: "ç”±æ–¼æš´é¢¨é›¨ï¼Œä»–å€‘ä¸å¾—ä¸å–æ¶ˆæ¼”ç¿’ã€‚", options: ["call off", "call on", "call for", "call out"], answer: 0, all_keywords: [
                    { word: 'call off', translation: 'å–æ¶ˆ (ç‰‡èª)', example: 'The game was called off.', example_translation: 'æ¯”è³½è¢«å–æ¶ˆäº†ã€‚' },
                    { word: 'call on', translation: 'æ‹œè¨ªï¼›å‘¼ç±²', example: 'He called on me yesterday.', example_translation: 'ä»–æ˜¨å¤©æ‹œè¨ªäº†æˆ‘ã€‚' },
                    { word: 'call for', translation: 'è¦æ±‚ï¼›éœ€è¦', example: 'This situation calls for action.', example_translation: 'é€™ç¨®æƒ…æ³éœ€è¦æ¡å–è¡Œå‹•ã€‚' },
                    { word: 'call out', translation: 'å¤§å–Šï¼›å¬é›†', example: 'He called out my name.', example_translation: 'ä»–å¤§å–Šæˆ‘çš„åå­—ã€‚' }
                ]},
                { type: 'reading', question: "I cannot ____ this noise any longer.", translation: "æˆ‘å†ä¹Ÿç„¡æ³•å¿å—é€™ç¨®å™ªéŸ³äº†ã€‚", options: ["put on", "put up with", "put off", "put out"], answer: 1, all_keywords: [
                    { word: 'put on', translation: 'ç©¿ä¸Šï¼›å¢åŠ ', example: 'Put on your coat.', example_translation: 'ç©¿ä¸Šä½ çš„å¤–å¥—ã€‚' },
                    { word: 'put up with', translation: 'å¿å— (ç‰‡èª)', example: 'I can\'t put up with it.', example_translation: 'æˆ‘ç„¡æ³•å¿å—é€™ä»¶äº‹ã€‚' },
                    { word: 'put off', translation: 'å»¶æœŸ', example: 'Don\'t put off your study.', example_translation: 'ä¸è¦å»¶é²ä½ çš„å­¸ç¿’ã€‚' },
                    { word: 'put out', translation: 'ç†„æ»…', example: 'Put out the fire.', example_translation: 'ç†„æ»…ç«ã€‚' }
                ]},
                { type: 'reading', question: "The patrol is in danger of ____ ammunition.", translation: "å·¡é‚éšŠæœ‰è€—ç›¡å½ˆè—¥çš„å±éšªã€‚", options: ["running into", "running over", "running out of", "running away"], answer: 2, all_keywords: [
                    { word: 'running into', translation: 'å¶ç„¶é‡è¦‹', example: 'I ran into Tom today.', example_translation: 'æˆ‘ä»Šå¤©å·§é‡æ¹¯å§†ã€‚' },
                    { word: 'running over', translation: 'è¼¾é', example: 'The car ran over a can.', example_translation: 'è»Šå­è¼¾éä¸€å€‹ç½å­ã€‚' },
                    { word: 'running out of', translation: 'ç”¨å®Œ (ç‰‡èª)', example: 'We are running out of time.', example_translation: 'æˆ‘å€‘çš„æ™‚é–“å¿«ç”¨å®Œäº†ã€‚' },
                    { word: 'running away', translation: 'é€ƒè·‘', example: 'The thief ran away.', example_translation: 'å°å·è·‘èµ°äº†ã€‚' }
                ]},
                { type: 'reading', question: "The soldiers were ordered to ____ the mission at dawn.", translation: "å£«å…µå€‘è¢«å‘½ä»¤åœ¨é»æ˜æ™‚åŸ·è¡Œä»»å‹™ã€‚", options: ["carry on", "carry out", "carry off", "carry over"], answer: 1, all_keywords: [
                    { word: 'carry on', translation: 'ç¹¼çºŒ', example: 'Carry on with your work.', example_translation: 'ç¹¼çºŒä½ çš„å·¥ä½œã€‚' },
                    { word: 'carry out', translation: 'åŸ·è¡Œ (ç‰‡èª)', example: 'Carry out the order.', example_translation: 'åŸ·è¡Œå‘½ä»¤ã€‚' },
                    { word: 'carry off', translation: 'æˆåŠŸå®Œæˆ', example: 'She carried off the win.', example_translation: 'å¥¹æˆåŠŸå¥ªå† ã€‚' },
                    { word: 'carry over', translation: 'å»¶çºŒ', example: 'The meeting carried over.', example_translation: 'æœƒè­°å»¶çºŒäº†ã€‚' }
                ]},
                { type: 'reading', question: "We need to ____ the security at the front gate.", translation: "æˆ‘å€‘éœ€è¦åŠ å¼·å‰é–€çš„å®‰å…¨ã€‚", options: ["back down", "break in", "blow up", "beef up"], answer: 3, all_keywords: [
                    { word: 'back down', translation: 'é€€è®“', example: 'He never backs down.', example_translation: 'ä»–å¾ä¸é€€è®“ã€‚' },
                    { word: 'break in', translation: 'é—–å…¥', example: 'Try to break in.', example_translation: 'è©¦åœ–é—–å…¥ã€‚' },
                    { word: 'blow up', translation: 'çˆ†ç‚¸', example: 'The bridge blew up.', example_translation: 'æ©‹çˆ†ç‚¸äº†ã€‚' },
                    { word: 'beef up', translation: 'åŠ å¼· (ç‰‡èª)', example: 'We need to beef up security.', example_translation: 'æˆ‘å€‘éœ€è¦åŠ å¼·å®‰ä¿ã€‚' }
                ]},
                { type: 'reading', question: "The supplies will ____ by tomorrow.", translation: "ç‰©è³‡å°‡åœ¨æ˜å¤©ç”¨å®Œã€‚", options: ["run out", "go on", "run in", "go back"], answer: 0, all_keywords: [
                    { word: 'run out', translation: 'ç”¨å®Œ (ç‰‡èª)', example: 'Supplies are running out.', example_translation: 'ç‰©è³‡å¿«ç”¨å®Œäº†ã€‚' },
                    { word: 'go on', translation: 'ç¹¼çºŒ', example: 'Go on with your story.', example_translation: 'ç¹¼çºŒä½ çš„æ•…äº‹ã€‚' },
                    { word: 'run in', translation: 'è·‘é€²', example: 'Run in the rain.', example_translation: 'åœ¨é›¨ä¸­è·‘æ­¥ã€‚' },
                    { word: 'go back', translation: 'å›å»', example: 'Go back home.', example_translation: 'å›å®¶å§ã€‚' }
                ]},
                { type: 'reading', question: "We should ____ the meeting until Monday.", translation: "æˆ‘å€‘æ‡‰è©²å°‡æœƒè­°å»¶æœŸåˆ°é€±ä¸€ã€‚", options: ["put on", "put out", "put away", "put off"], answer: 3, all_keywords: [
                    { word: 'put on', translation: 'ç©¿ä¸Š', example: 'Put on your shoes.', example_translation: 'ç©¿é‹ã€‚' },
                    { word: 'put out', translation: 'ç†„æ»…', example: 'Put out the light.', example_translation: 'é—œç‡ˆã€‚' },
                    { word: 'put away', translation: 'æ”¶å¥½', example: 'Put away your toys.', example_translation: 'æŠŠç©å…·æ”¶å¥½ã€‚' },
                    { word: 'put off', translation: 'å»¶æœŸ (ç‰‡èª)', example: 'Don\'t put off the task.', example_translation: 'åˆ¥å»¶èª¤ä»»å‹™ã€‚' }
                ]},
                { type: 'reading', question: "He finally ____ a good idea.", translation: "ä»–çµ‚æ–¼æƒ³å‡ºäº†ä¸€å€‹å¥½ä¸»æ„ã€‚", options: ["came up with", "came across", "came back", "came on"], answer: 0, all_keywords: [
                    { word: 'came up with', translation: 'æƒ³å‡º (ç‰‡èª)', example: 'He came up with a plan.', example_translation: 'ä»–æƒ³å‡ºäº†ä¸€å€‹è¨ˆç•«ã€‚' },
                    { word: 'came across', translation: 'å¶ç„¶ç™¼ç¾', example: 'I came across a photo.', example_translation: 'æˆ‘å¶ç„¶ç™¼ç¾ä¸€å¼µç…§ç‰‡ã€‚' },
                    { word: 'came back', translation: 'å›ä¾†', example: 'Come back soon.', example_translation: 'å¿«é»å›ä¾†ã€‚' },
                    { word: 'came on', translation: 'åŠ æ²¹', example: 'Come on!', example_translation: 'åŠ æ²¹ï¼' }
                ]}
                // ... (å…¶é¤˜ 19 é¡Œæ“´å……ç•¥ï¼Œçµæ§‹èˆ‡ä¸Šè¿°ä¸€è‡´ï¼Œç­”æ¡ˆ A-D éš¨æ©Ÿåˆ†é…)
            ],
            'quiz2': [
                { type: 'reading', question: "The General ordered the supplies ____ immediately.", translation: "å°‡è»ä¸‹ä»¤è£œçµ¦å“è¦ç«‹å³è¢«é€å‡ºã€‚", options: ["sent", "to be sent", "send", "sending"], answer: 1, all_keywords: [
                    { word: 'sent', translation: 'é€ (éå»åˆ†è©)', example: 'I sent the mail.', example_translation: 'æˆ‘å¯„äº†ä¿¡ã€‚' },
                    { word: 'to be sent', translation: 'è¢«é€å‡º (ä¸å®šè©è¢«å‹•)', example: 'I ordered it to be sent.', example_translation: 'æˆ‘ä¸‹ä»¤å°‡å®ƒé€å‡ºã€‚' },
                    { word: 'send', translation: 'é€ (åŸå½¢)', example: 'Please send help.', example_translation: 'è«‹é€æ´ã€‚' },
                    { word: 'sending', translation: 'æ­£åœ¨é€', example: 'He is sending it.', example_translation: 'ä»–æ­£åœ¨é€ã€‚' }
                ]},
                { type: 'reading', question: "If he ____ the map, he wouldn't have gotten lost.", translation: "å¦‚æœä»–ç•¶æ™‚æœ‰çœ‹åœ°åœ–ï¼Œä»–å°±ä¸æœƒè¿·è·¯äº†ã€‚", options: ["checked", "checks", "had checked", "would check"], answer: 2, all_keywords: [
                    { word: 'checked', translation: 'æª¢æŸ¥ (éå»å¼)', example: 'He checked his bag.', example_translation: 'ä»–æª¢æŸ¥äº†åŒ…åŒ…ã€‚' },
                    { word: 'checks', translation: 'æª¢æŸ¥ (ç¾åœ¨å¼)', example: 'He checks daily.', example_translation: 'ä»–æ¯å¤©æª¢æŸ¥ã€‚' },
                    { word: 'had checked', translation: 'æœ‰æª¢æŸ¥é (éå»å®Œæˆå¼)', example: 'If I had checked...', example_translation: 'å¦‚æœæˆ‘ç•¶æ™‚æœ‰æª¢æŸ¥...' },
                    { word: 'would check', translation: 'å°‡æœƒæª¢æŸ¥', example: 'He would check later.', example_translation: 'ä»–ç¨å¾Œæœƒæª¢æŸ¥ã€‚' }
                ]},
                { type: 'reading', question: "The mechanic ____ the engine since early this morning.", translation: "æŠ€å·¥å¾ä»Šå¤©ä¸€å¤§æ—©å°±ä¸€ç›´åœ¨ä¿®ç†å¼•æ“ã€‚", options: ["has been repairing", "repaired", "repairs", "is repairing"], answer: 0, all_keywords: [
                    { word: 'has been repairing', translation: 'ä¸€ç›´ä¿®ç† (ç¾åœ¨å®Œæˆé€²è¡Œå¼)', example: 'I have been working.', example_translation: 'æˆ‘ä¸€ç›´åœ¨å·¥ä½œã€‚' },
                    { word: 'repaired', translation: 'ä¿®ç†é', example: 'He repaired it.', example_translation: 'ä»–ä¿®å¥½äº†ã€‚' },
                    { word: 'repairs', translation: 'ä¿®ç† (ç¾ä¸‰å–®)', example: 'He repairs cars.', example_translation: 'ä»–ä¿®ç†è»Šè¼›ã€‚' },
                    { word: 'is repairing', translation: 'æ­£åœ¨ä¿®ç†', example: 'He is repairing it now.', example_translation: 'ä»–ç¾åœ¨æ­£åœ¨ä¿®ã€‚' }
                ]},
                { type: 'reading', question: "Neither the captain nor the soldiers ____ prepared for the attack.", translation: "ä¸è«–æ˜¯ä¸Šå°‰é‚„æ˜¯å£«å…µå€‘ï¼Œéƒ½æ²’æœ‰å°é€™æ¬¡æ”»æ“Šåšå¥½æº–å‚™ã€‚", options: ["is", "was", "were", "be"], answer: 2, all_keywords: [
                    { word: 'is', translation: 'æ˜¯ (å–®æ•¸)', example: 'He is here.', example_translation: 'ä»–åœ¨é€™ã€‚' },
                    { word: 'was', translation: 'æ˜¯ (å–®æ•¸éå»)', example: 'It was late.', example_translation: 'é‚£æ™‚æ™šäº†ã€‚' },
                    { word: 'were', translation: 'æ˜¯ (è¤‡æ•¸éå»)', example: 'They were ready.', example_translation: 'ä»–å€‘æº–å‚™å¥½äº†ã€‚' },
                    { word: 'be', translation: 'æ˜¯ (åŸå½¢)', example: 'To be or not to be.', example_translation: 'ç”Ÿå­˜æˆ–æ¯€æ»…ã€‚' }
                ]},
                { type: 'reading', question: "By the time the convoy arrived, the sun ____.", translation: "ç•¶è»ŠéšŠåˆ°é”æ™‚ï¼Œå¤ªé™½å·²ç¶“ä¸‹å±±äº†ã€‚", options: ["sets", "was setting", "has set", "had set"], answer: 3, all_keywords: [
                    { word: 'sets', translation: 'ä¸‹å±± (ç¾åœ¨å¼)', example: 'The sun sets west.', example_translation: 'å¤ªé™½å¾è¥¿é‚Šè½ä¸‹ã€‚' },
                    { word: 'was setting', translation: 'æ­£åœ¨ä¸‹å±±', example: 'The sun was setting.', example_translation: 'å¤ªé™½ç•¶æ™‚æ­£åœ¨è½ä¸‹ã€‚' },
                    { word: 'has set', translation: 'å·²ç¶“ä¸‹å±±', example: 'It has set.', example_translation: 'å®ƒå·²ç¶“è½ä¸‹äº†ã€‚' },
                    { word: 'had set', translation: 'å·²ç¶“ä¸‹å±± (éå»å®Œæˆ)', example: 'It had set before we arrived.', example_translation: 'åœ¨æˆ‘å€‘åˆ°é”å‰å®ƒå°±å·²ç¶“è½ä¸‹äº†ã€‚' }
                ]},
                { type: 'reading', question: "This is the officer ____ I told you about.", translation: "é€™å°±æ˜¯æˆ‘è·Ÿä½ æéçš„é‚£ä½è»å®˜ã€‚", options: ["whom", "who", "which", "whose"], answer: 0, all_keywords: [
                    { word: 'whom', translation: 'èª° (å—æ ¼é—œä¿‚ä»£åè©)', example: 'The man whom I saw.', example_translation: 'æˆ‘çœ‹åˆ°çš„é‚£å€‹äººã€‚' },
                    { word: 'who', translation: 'èª° (ä¸»æ ¼)', example: 'Who is he?', example_translation: 'ä»–æ˜¯èª°ï¼Ÿ' },
                    { word: 'which', translation: 'å“ªå€‹', example: 'Which one?', example_translation: 'å“ªä¸€å€‹ï¼Ÿ' },
                    { word: 'whose', translation: 'èª°çš„', example: 'Whose bag is this?', example_translation: 'é€™æ˜¯èª°çš„åŒ…åŒ…ï¼Ÿ' }
                ]},
                { type: 'reading', question: "The soldiers finished ____ the trenches before noon.", translation: "å£«å…µå€‘åœ¨ä¸­åˆå‰å®Œæˆäº†æˆ°å£•çš„æŒ–æ˜å·¥ä½œã€‚", options: ["to dig", "digging", "dig", "dug"], answer: 1, all_keywords: [
                    { word: 'to dig', translation: 'å»æŒ–', example: 'I want to dig.', example_translation: 'æˆ‘æƒ³æŒ–ã€‚' },
                    { word: 'digging', translation: 'æŒ–æ˜ (å‹•åè©)', example: 'He likes digging.', example_translation: 'ä»–å–œæ­¡æŒ–æ˜ã€‚' },
                    { word: 'dig', translation: 'æŒ– (åŸå½¢)', example: 'Dig a hole.', example_translation: 'æŒ–å€‹æ´ã€‚' },
                    { word: 'dug', translation: 'æŒ– (éå»å¼)', example: 'He dug it.', example_translation: 'ä»–æŒ–å¥½äº†ã€‚' }
                ]},
                { type: 'reading', question: "I am looking forward to ____ the training session.", translation: "æˆ‘å¾ˆæœŸå¾…åƒåŠ é€™å ´è¨“ç·´èª²ç¨‹ã€‚", options: ["joining", "join", "joined", "to join"], answer: 0, all_keywords: [
                    { word: 'joining', translation: 'åƒåŠ  (å‹•åè©)', example: 'Looking forward to joining.', example_translation: 'æœŸå¾…åƒåŠ ã€‚' },
                    { word: 'join', translation: 'åƒåŠ ', example: 'Join us.', example_translation: 'åŠ å…¥æˆ‘å€‘ã€‚' },
                    { word: 'joined', translation: 'åƒåŠ é', example: 'He joined.', example_translation: 'ä»–åƒåŠ äº†ã€‚' },
                    { word: 'to join', translation: 'å»åƒåŠ ', example: 'Wait to join.', example_translation: 'ç­‰å¾…åƒåŠ ã€‚' }
                ]},
                { type: 'reading', question: "You ____ have reported the loss as soon as it happened.", translation: "ä½ ç•¶æ™‚åœ¨æå¤±ç™¼ç”Ÿæ™‚å°±æ‡‰è©²ç«‹åˆ»å›å ±çš„ã€‚", options: ["might", "must", "should", "could"], answer: 2, all_keywords: [
                    { word: 'might', translation: 'å¯èƒ½', example: 'It might rain.', example_translation: 'å¯èƒ½æœƒä¸‹é›¨ã€‚' },
                    { word: 'must', translation: 'å¿…é ˆ', example: 'Must go.', example_translation: 'å¿…é ˆå»ã€‚' },
                    { word: 'should', translation: 'æ‡‰è©² (éå»æ‡‰è©²åšè€Œæœªåš)', example: 'Should have gone.', example_translation: 'ç•¶æ™‚æ‡‰è©²å»çš„ã€‚' },
                    { word: 'could', translation: 'å¯ä»¥ï¼›èƒ½å¤ ', example: 'I could fly.', example_translation: 'æˆ‘èƒ½é£›ã€‚' }
                ]},
                { type: 'reading', question: "The pilot is ____ than the new trainee.", translation: "é€™ä½é£›è¡Œå“¡æ¯”é‚£ä½æ–°å­¸å“¡æ›´æœ‰ç¶“é©—ã€‚", options: ["more experienced", "experienced", "most experienced", "as experienced"], answer: 0, all_keywords: [
                    { word: 'more experienced', translation: 'æ›´æœ‰ç¶“é©—çš„ (æ¯”è¼ƒç´š)', example: 'He is more experienced.', example_translation: 'ä»–æ›´æœ‰ç¶“é©—ã€‚' },
                    { word: 'experienced', translation: 'æœ‰ç¶“é©—çš„', example: 'An experienced pilot.', example_translation: 'ä¸€ä½è³‡æ·±çš„é£›è¡Œå“¡ã€‚' },
                    { word: 'most experienced', translation: 'æœ€æœ‰ç¶“é©—çš„', example: 'The most experienced one.', example_translation: 'æœ€æœ‰ç¶“é©—çš„é‚£ä½ã€‚' },
                    { word: 'as experienced', translation: 'ä¸€æ¨£æœ‰ç¶“é©—', example: 'As experienced as him.', example_translation: 'è·Ÿä»–ä¸€æ¨£æœ‰ç¶“é©—ã€‚' }
                ]},
                { type: 'reading', question: "The instructor explained the mission ____ to the troops.", translation: "æ•™å®˜å‘éƒ¨éšŠéå¸¸æ¸…æ¥šåœ°è§£é‡‹äº†ä»»å‹™ã€‚", options: ["clearly", "clear", "clearness", "clearing"], answer: 0, all_keywords: [
                    { word: 'clearly', translation: 'æ¸…æ¥šåœ° (å‰¯è©)', example: 'Explain clearly.', example_translation: 'æ¸…æ¥šåœ°è§£é‡‹ã€‚' },
                    { word: 'clear', translation: 'æ¸…æ¥šçš„', example: 'It is clear.', example_translation: 'é€™å¾ˆæ¸…æ¥šã€‚' },
                    { word: 'clearness', translation: 'æ¸…æ™°åº¦', example: 'Lack of clearness.', example_translation: 'ç¼ºä¹æ¸…æ™°åº¦ã€‚' },
                    { word: 'clearing', translation: 'ç©ºåœ°ï¼›æ¸…é™¤', example: 'A clearing in forest.', example_translation: 'æ£®æ—ä¸­çš„ç©ºåœ°ã€‚' }
                ]},
                { type: 'reading', question: "Please remain ____ until the alarm stops.", translation: "è«‹ä¿æŒå†·éœç›´åˆ°è­¦å ±åœæ­¢ã€‚", options: ["calmly", "calm", "calming", "calmed"], answer: 1, all_keywords: [
                    { word: 'calmly', translation: 'å†·éœåœ°', example: 'He spoke calmly.', example_translation: 'ä»–å†·éœåœ°èªªè©±ã€‚' },
                    { word: 'calm', translation: 'å†·éœçš„ (å½¢å®¹è©)', example: 'Stay calm.', example_translation: 'ä¿æŒå†·éœã€‚' },
                    { word: 'calming', translation: 'ä»¤äººå†·éœçš„', example: 'Calming music.', example_translation: 'ä»¤äººå†·éœçš„éŸ³æ¨‚ã€‚' },
                    { word: 'calmed', translation: 'ä½¿å†·éœ (éå»å¼)', example: 'He calmed down.', example_translation: 'ä»–å†·éœä¸‹ä¾†äº†ã€‚' }
                ]},
                { type: 'reading', question: "____ it was late, the sergeant finished the task.", translation: "é›–ç„¶é‚£æ™‚å·²ç¶“æ™šäº†ï¼Œä¸­å£«é‚„æ˜¯å®Œæˆäº†ä»»å‹™ã€‚", options: ["Because", "So", "But", "Although"], answer: 3, all_keywords: [
                    { word: 'Because', translation: 'å› ç‚º', example: 'Because it rained.', example_translation: 'å› ç‚ºä¸‹é›¨äº†ã€‚' },
                    { word: 'So', translation: 'æ‰€ä»¥', example: 'So I went.', example_translation: 'æ‰€ä»¥æˆ‘å»äº†ã€‚' },
                    { word: 'But', translation: 'ä½†æ˜¯', example: 'Cold but nice.', example_translation: 'å¾ˆå†·ä½†å¾ˆæ£’ã€‚' },
                    { word: 'Although', translation: 'é›–ç„¶ (å¼•å°è®“æ­¥å­å¥)', example: 'Although he is old...', example_translation: 'é›–ç„¶ä»–è€äº†...' }
                ]},
                { type: 'reading', question: "The commander made the soldiers ____ for two hours.", translation: "æŒ‡æ®å®˜è®“å£«å…µå€‘ç«™äº†å…©å€‹å°æ™‚ã€‚", options: ["to stand", "stand", "standing", "stood"], answer: 1, all_keywords: [
                    { word: 'to stand', translation: 'å»ç«™', example: 'Want to stand.', example_translation: 'æƒ³ç«™è‘—ã€‚' },
                    { word: 'stand', translation: 'ç«™ç«‹ (ä½¿å½¹å‹•è©æ¥åŸå½¢)', example: 'Make him stand.', example_translation: 'è®“ä»–ç«™è‘—ã€‚' },
                    { word: 'standing', translation: 'æ­£åœ¨ç«™', example: 'Standing there.', example_translation: 'ç«™åœ¨é‚£è£¡ã€‚' },
                    { word: 'stood', translation: 'ç«™ç«‹ (éå»å¼)', example: 'He stood up.', example_translation: 'ä»–ç«™èµ·ä¾†äº†ã€‚' }
                ]},
                { type: 'reading', question: "You had better ____ the equipment before using it.", translation: "åœ¨ä½¿ç”¨è¨­å‚™å‰ï¼Œä½ æœ€å¥½æª¢æŸ¥ä¸€ä¸‹ã€‚", options: ["checking", "to check", "check", "checked"], answer: 2, all_keywords: [
                    { word: 'checking', translation: 'æª¢æŸ¥ä¸­', example: 'Still checking.', example_translation: 'ä»åœ¨æª¢æŸ¥ã€‚' },
                    { word: 'to check', translation: 'å»æª¢æŸ¥', example: 'Need to check.', example_translation: 'éœ€è¦æª¢æŸ¥ã€‚' },
                    { word: 'check', translation: 'æª¢æŸ¥ (had betteræ¥åŸå½¢)', example: 'You had better check.', example_translation: 'ä½ æœ€å¥½æª¢æŸ¥ä¸€ä¸‹ã€‚' },
                    { word: 'checked', translation: 'æª¢æŸ¥é', example: 'He checked.', example_translation: 'ä»–æª¢æŸ¥éäº†ã€‚' }
                ]},
                { type: 'reading', question: "The mission failed because there were ____ many errors.", translation: "ä»»å‹™å¤±æ•—äº†ï¼Œå› ç‚ºéŒ¯èª¤å¤ªå¤šäº†ã€‚", options: ["too", "to", "two", "tough"], answer: 0, all_keywords: [
                    { word: 'too', translation: 'å¤ª (ä¿®é£¾å½¢å®¹è©æˆ–å‰¯è©)', example: 'Too many.', example_translation: 'å¤ªå¤šã€‚' },
                    { word: 'to', translation: 'åˆ°ï¼›å»', example: 'Go to bed.', example_translation: 'å»ç¡è¦ºã€‚' },
                    { word: 'two', translation: 'äºŒ', example: 'Two books.', example_translation: 'å…©æœ¬æ›¸ã€‚' },
                    { word: 'tough', translation: 'è‰±é›£çš„', example: 'Tough guy.', example_translation: 'ç¡¬æ¼¢ã€‚' }
                ]},
                { type: 'reading', question: "If I ____ the Colonel, I would ask for a promotion.", translation: "å¦‚æœæˆ‘æ˜¯ä¸Šæ ¡ï¼Œæˆ‘å°±æœƒè¦æ±‚æ™‰å‡ã€‚", options: ["am", "was", "were", "be"], answer: 2, all_keywords: [
                    { word: 'am', translation: 'æ˜¯ (ç¬¬ä¸€äººç¨±)', example: 'I am.', example_translation: 'æˆ‘æ˜¯ã€‚' },
                    { word: 'was', translation: 'æ˜¯ (éå»å–®æ•¸)', example: 'I was happy.', example_translation: 'æˆ‘é‚£æ™‚å¾ˆå¿«æ¨‚ã€‚' },
                    { word: 'were', translation: 'æ˜¯ (å‡è¨­èªæ°£)', example: 'If I were you...', example_translation: 'å¦‚æœæˆ‘æ˜¯ä½ ...' },
                    { word: 'be', translation: 'æ˜¯', example: 'Just be.', example_translation: 'å°±é€™æ¨£å§ã€‚' }
                ]},
                { type: 'reading', question: "The troops arrived ____ 0800 hours precisely.", translation: "éƒ¨éšŠåœ¨ 0800 æ™‚æº–ç¢ºåˆ°é”ã€‚", options: ["at", "on", "in", "by"], answer: 0, all_keywords: [
                    { word: 'at', translation: 'åœ¨ (ç²¾ç¢ºæ™‚é–“é»)', example: 'At noon.', example_translation: 'åœ¨ä¸­åˆã€‚' },
                    { word: 'on', translation: 'åœ¨ (æ˜ŸæœŸæˆ–æ—¥æœŸ)', example: 'On Monday.', example_translation: 'åœ¨é€±ä¸€ã€‚' },
                    { word: 'in', translation: 'åœ¨ (æœˆä»½ã€å­£ç¯€ã€å¹´ä»½)', example: 'In May.', example_translation: 'åœ¨äº”æœˆã€‚' },
                    { word: 'by', translation: 'ä¸æ™šæ–¼', example: 'By 5 PM.', example_translation: 'ä¸‹åˆ 5 é»å‰ã€‚' }
                ]},
                { type: 'reading', question: "The truck is parked ____ the hangar.", translation: "å¡è»Šåœåœ¨é£›æ©Ÿæ£šå‰é¢ã€‚", options: ["in front of", "on top of", "between", "among"], answer: 0, all_keywords: [
                    { word: 'in front of', translation: 'åœ¨...å‰é¢', example: 'In front of house.', example_translation: 'åœ¨æˆ¿å­å‰ã€‚' },
                    { word: 'on top of', translation: 'åœ¨...é ‚ç«¯', example: 'On top of hill.', example_translation: 'åœ¨å±±é ‚ã€‚' },
                    { word: 'between', translation: 'åœ¨å…©è€…ä¹‹é–“', example: 'Between A and B.', example_translation: 'åœ¨ A èˆ‡ B ä¹‹é–“ã€‚' },
                    { word: 'among', translation: 'åœ¨ä¸‰è€…ä»¥ä¸Šä¹‹é–“', example: 'Among friends.', example_translation: 'åœ¨æœ‹å‹ä¹‹é–“ã€‚' }
                ]},
                { type: 'reading', question: "The General ____ to visit the base tomorrow morning.", translation: "å°‡è»é å®šæ–¼æ˜å¤©æ—©ä¸Šè¨ªå•åŸºåœ°ã€‚", options: ["expecting", "is expected", "expects", "expected"], answer: 1, all_keywords: [
                    { word: 'expecting', translation: 'æ­£åœ¨æœŸå¾…', example: 'I am expecting.', example_translation: 'æˆ‘æ­£æœŸå¾…è‘—ã€‚' },
                    { word: 'is expected', translation: 'è¢«é æœŸ (è¢«å‹•é å®š)', example: 'It is expected.', example_translation: 'é€™æ˜¯é æ–™ä¸­çš„ã€‚' },
                    { word: 'expects', translation: 'æœŸå¾… (ä¸‰å–®)', example: 'He expects help.', example_translation: 'ä»–æœŸå¾…å¹«åŠ©ã€‚' },
                    { word: 'expected', translation: 'é æœŸçš„ (éå»å¼)', example: 'He expected win.', example_translation: 'ä»–é æ–™æœƒè´ã€‚' }
                ]}
            ],
            'quiz3': [
                { type: 'listening', question: "Man: Is the fuel truck ready?\nWoman: Not yet, it's being inspected.\n\n(Narrator): What is happening to the truck?", translation: "ç”·ï¼šæ²¹ç½è»Šæº–å‚™å¥½äº†å—ï¼Ÿ\nå¥³ï¼šé‚„æ²’ï¼Œæ­£åœ¨æ¥å—æª¢æŸ¥ã€‚\n\n(æ—ç™½)ï¼šé€™è¼›å¡è»Šæ­£åœ¨ç™¼ç”Ÿä»€éº¼äº‹ï¼Ÿ", options: ["(A) It is being filled.", "(B) It is being checked.", "(C) It is being washed.", "(D) It is being driven."], answer: 1, all_keywords: [
                    { word: 'inspected', translation: 'æª¢æŸ¥ (å–®å­—)', example: 'The car was inspected.', example_translation: 'è»Šå­å—æª¢äº†ã€‚' },
                    { word: 'checked', translation: 'æ ¸å° (å–®å­—)', example: 'Check the list.', example_translation: 'æ ¸å°æ¸…å–®ã€‚' }
                ]}
                // ... (å…¶é¤˜ 19 é¡Œè½åŠ›æ“´å……ï¼Œç­”æ¡ˆ A-D éš¨æ©Ÿåˆ†é…)
            ]
        };

        const synth = new Tone.Synth().toDestination();

        // --- Core Functions ---
        async function initializeAppFirebase() {
            try {
                const userProvidedConfig = {
                    apiKey: "AIzaSyDQSAW63lnKd3aCCiCt7pSmRa6ZPqOiIZI",
                    authDomain: "alcpt-f9d8d.firebaseapp.com",
                    projectId: "alcpt-f9d8d",
                    storageBucket: "alcpt-f9d8d.firebasestorage.app",
                    messagingSenderId: "885828022963",
                    appId: "1:885828022963:web:b18d3e49a19d3840d5b6c6"
                };
                const config = (typeof __firebase_config !== 'undefined' && __firebase_config) 
                    ? JSON.parse(__firebase_config) : userProvidedConfig;

                app = initializeApp(config);
                db = getFirestore(app);
                auth = getAuth(app);
                const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'github-ALCPT-app';

                await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        loadFavoriteKeywords(currentAppId, userId);
                        showScreen('welcome-screen');
                    }
                });
            } catch (error) {
                console.error("Firebase Init Error:", error);
                document.getElementById('loading-text').innerHTML = `è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª Firebase è¨­å®šã€‚<br><small>${error.message}</small>`;
            }
        }

        function loadFavoriteKeywords(id, uid) {
            if (firestoreUnsubscribe) firestoreUnsubscribe();
            const colRef = collection(db, 'artifacts', id, 'users', uid, 'favorites');
            firestoreUnsubscribe = onSnapshot(colRef, (snap) => {
                favoriteKeywords = snap.docs.map(doc => doc.data());
                const currentQ = currentQuestions[currentQuestionIndex];
                if (currentQ && document.getElementById('keywords-display').innerHTML !== '') {
                    renderKeywords(currentQ.all_keywords);
                }
                if (document.getElementById('favorites-modal').style.display === 'flex') showFavoritesModal();
            });
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => {
                s.style.display = 'none';
                s.classList.remove('active-screen');
            });
            const target = document.getElementById(id);
            if (target) {
                target.style.display = 'flex';
                target.classList.add('active-screen');
            }
        }

        function startQuiz(quizId) {
            if (!isAuthReady) return;
            currentTest = quizId;
            currentQuestionIndex = 0;
            score = 0;
            currentQuestions = [...alcptQuizBanks[quizId]].sort(() => Math.random() - 0.5);
            document.getElementById('test-title').textContent = { quiz1: 'é¡Œåº«(ä¸€): è©å½™ç‰‡èª', quiz2: 'é¡Œåº«(äºŒ): æ–‡æ³•çµæ§‹', quiz3: 'é¡Œåº«(ä¸‰): è½åŠ›æ¸¬é©—è…³æœ¬' }[quizId];
            loadQuestion();
            startTimer(currentQuestions.length * 45);
            showScreen('test-screen');
        }

        function wrapWords(text) {
            return text.split(' ').map(word => {
                const cleanWord = word.replace(/[.,!?;:()]/g, "").toLowerCase();
                return `<span class="clickable-word" data-word="${cleanWord}" onclick="handleWordClick(this, '${cleanWord}')">${word}</span>`;
            }).join(' ');
        }

        function handleWordClick(element, word) {
            document.querySelectorAll('.clickable-word').forEach(el => el.classList.remove('word-highlight'));
            element.classList.add('word-highlight');
            const tooltip = document.getElementById('word-tooltip');
            const content = document.getElementById('tooltip-content');
            const currentQ = currentQuestions[currentQuestionIndex];
            let found = currentQ.all_keywords?.find(kw => kw.word.toLowerCase() === word);
            if (!found) found = currentQ.all_keywords?.find(kw => kw.word.toLowerCase().includes(word));
            if (found) {
                content.innerHTML = `<span class="bg-yellow-400 text-black px-2 py-0.5 rounded-md font-bold mr-2">æ„æ€</span> <strong>${found.word}</strong>: ${found.translation}`;
            } else {
                content.innerHTML = `<strong>${word}</strong>: (é»é¸ä¸‹æ–¹ã€Œè§£æã€ç²å–å®Œæ•´å…§å®¹)`;
            }
            tooltip.classList.remove('hidden');
            speak(word); 
        }

        function loadQuestion() {
            document.getElementById('next-button').disabled = true;
            document.getElementById('options-container').innerHTML = '';
            document.getElementById('post-answer-actions').innerHTML = '';
            document.getElementById('post-answer-display').innerHTML = '';
            document.getElementById('keywords-display').innerHTML = '';
            document.getElementById('word-tooltip').classList.add('hidden');
            
            const q = currentQuestions[currentQuestionIndex];
            document.getElementById('progress-bar').style.width = `${(currentQuestionIndex / currentQuestions.length) * 100}%`;
            document.getElementById('question-counter').textContent = `Q: ${currentQuestionIndex + 1}/${currentQuestions.length}`;
            document.getElementById('question-text').innerHTML = wrapWords(q.question).replace(/\n/g, '<br>');
            
            q.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = 'w-full p-4 text-left bg-gray-700 hover:bg-gray-600 rounded-xl border-2 border-gray-600 transition duration-200';
                btn.textContent = opt;
                btn.onclick = () => selectAnswer(idx);
                document.getElementById('options-container').appendChild(btn);
            });
        }

        function selectAnswer(idx) {
            const q = currentQuestions[currentQuestionIndex];
            const isCorrect = idx === q.answer;
            if (isCorrect) score++;
            const btns = document.getElementById('options-container').querySelectorAll('button');
            btns.forEach((b, i) => {
                b.disabled = true;
                if (i === q.answer) b.classList.add('correct-answer');
                else if (i === idx) b.classList.add('incorrect-answer');
            });
            const correctText = q.options[q.answer];
            const ttsText = q.type === 'listening' ? q.question.split('(Narrator):')[1]?.trim() || q.question : q.question.replace('____', correctText);
            const escapedTTS = ttsText.replace(/'/g, "\\'").replace(/\n/g, ' ');

            document.getElementById('post-answer-display').innerHTML = `
                <div class="p-5 bg-gray-900 rounded-2xl border border-gray-700 shadow-xl">
                    <div class="flex justify-between items-center mb-4">
                         <p class="font-bold text-yellow-400 text-lg">è§£ç­”è§£æï¼š</p>
                         <button onclick="speak('${escapedTTS}')" class="cute-speaker-btn" title="è½å…¨å¥ç™¼éŸ³">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072M20 4a9 9 0 010 16M4 4a9 9 0 0116 0" /></svg>
                         </button>
                    </div>
                    <p class="text-gray-300 italic mb-4 leading-relaxed">${q.type === 'listening' ? q.question.replace(/\n/g, '<br>') : q.question.replace('____', `<span class='text-yellow-400 font-bold underline px-1'>${correctText}</span>`)}</p>
                    <button onclick="this.nextElementSibling.classList.toggle('hidden')" class="text-sm text-cyan-400 font-bold hover:underline mb-2 block">ğŸ” é¡¯ç¤ºå…¨å¥ç¿»è­¯</button>
                    <p class="hidden text-gray-400 text-sm bg-gray-800 p-3 rounded-lg border border-gray-700 mb-2">${q.translation ? q.translation.replace('____', correctText) : 'æš«ç„¡ç¿»è­¯è³‡æ–™'}</p>
                </div>
            `;
            const kwBtn = document.createElement('button');
            kwBtn.className = 'bg-teal-600 hover:bg-teal-500 text-white font-bold py-3 px-8 rounded-xl transition shadow-lg mt-4';
            kwBtn.textContent = 'æŸ¥çœ‹å…¨é¸é …å–®å­—è§£æ';
            kwBtn.onclick = () => renderKeywords(q.all_keywords);
            document.getElementById('post-answer-actions').appendChild(kwBtn);
            document.getElementById('next-button').disabled = false;
            playSound(isCorrect ? 'correct' : 'incorrect');
        }

        function renderKeywords(keywords) {
            if (!keywords) return;
            let html = '<div class="space-y-4 mt-6 animate-fade-in">';
            keywords.forEach(kw => {
                const isFav = favoriteKeywords.some(f => f.word === kw.word);
                const kwJSON = JSON.stringify(kw).replace(/'/g, "\\'");
                const escapedWord = kw.word.replace(/'/g, "\\'");
                const escapedExample = kw.example.replace(/'/g, "\\'");
                html += `
                    <div class="p-5 bg-gray-700 rounded-2xl border border-gray-600 shadow-lg">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex flex-col gap-2">
                                <div class="flex items-center space-x-3">
                                    <span class="text-white font-bold text-xl">${kw.word}</span>
                                    <button onclick="speak('${escapedWord}')" class="cute-speaker-btn p-1 h-8 w-8" title="å–®å­—ç™¼éŸ³">
                                        <svg fill="currentColor" viewBox="0 0 20 20"><path d="M11 5L6 9H2v2h4l5 4V5z"/></svg>
                                    </button>
                                </div>
                                <div class="translation-tag">æ„æ€ï¼š${kw.translation}</div>
                            </div>
                            <button onclick='toggleFavorite(${kwJSON})' class="hover:scale-125 transition p-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 ${isFav?'text-red-500':'text-gray-500 opacity-40'}" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                        </div>
                        <div class="bg-gray-800 bg-opacity-50 p-3 rounded-xl border border-gray-600">
                            <div class="flex items-center space-x-3 mb-1">
                                <p class="text-sm text-gray-300 italic flex-grow">${kw.example}</p>
                                <button onclick="speak('${escapedExample}')" class="cute-speaker-btn h-8 w-8 p-0" title="ä¾‹å¥ç™¼éŸ³">
                                    <svg fill="currentColor" viewBox="0 0 20 20" class="w-4 h-4"><path d="M11 5L6 9H2v2h4l5 4V5z"/></svg>
                                </button>
                            </div>
                            <p class="text-sm text-gray-500 font-medium">ç¿»è­¯ï¼š${kw.example_translation}</p>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            document.getElementById('keywords-display').innerHTML = html;
            document.getElementById('keywords-display').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        async function toggleFavorite(kw) {
            const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'github-ALCPT-app';
            const docId = kw.word.replace(/[^a-zA-Z0-9]/g, '_');
            const docRef = doc(db, 'artifacts', currentAppId, 'users', userId, 'favorites', docId);
            const isAlreadyFav = favoriteKeywords.some(f => f.word === kw.word);
            try {
                if (isAlreadyFav) await deleteDoc(docRef);
                else await setDoc(docRef, kw);
            } catch (err) { console.error("Favorite Error:", err); }
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < currentQuestions.length) loadQuestion();
            else finishQuiz();
        }

        function finishQuiz() {
            clearInterval(timerInterval);
            const accuracy = Math.round((score / currentQuestions.length) * 100);
            if (accuracy >= 80) quizPassStatus[currentTest] = true;
            const allPassed = quizPassStatus.quiz1 && quizPassStatus.quiz2 && quizPassStatus.quiz3;
            const titleEl = document.getElementById('module-complete-title');
            const msgEl = document.getElementById('module-complete-message');
            titleEl.textContent = accuracy >= 80 ? "æ¸¬é©—é€šéï¼(Passed)" : "æœªé€šé (Failed)";
            titleEl.className = `text-2xl sm:text-3xl font-bold mb-4 ${accuracy >= 80?'text-green-400':'text-red-400'}`;
            let finalMsg = `å¾—åˆ†ç‡ï¼š${accuracy}%. (${score}/${currentQuestions.length} é¡Œ)`;
            if (accuracy >= 80) {
                finalMsg += `<br><span class="text-green-300 font-bold">æ­å–œï¼æ‚¨å·²é”æ¨™ã€‚</span>`;
                if (allPassed) finalMsg += `<br><br><div class="p-4 bg-yellow-900 border border-yellow-500 rounded-2xl text-yellow-200 font-bold shadow-2xl">æ­å–œé€šéæœ¬æ—¥æ‰€æœ‰ ALCPT ç·´ç¿’ï¼ä¸è¦å¿˜è¨˜åˆ°ã€Œæˆ‘çš„æœ€æ„›ã€è¤‡ç¿’å–”ï¼</div>`;
                playSound('success');
            } else {
                finalMsg += `<br><span class="text-red-300 font-bold">å¾ˆéºæ†¾ï¼ŒALCPT æ¨™æº–éœ€é” 80%ã€‚<br>è«‹å†æ¸¬é©—ä¸€æ¬¡ åŠ å¼·ç·´ç¿’ï¼</span>`;
            }
            msgEl.innerHTML = finalMsg;
            document.getElementById('module-score').textContent = `${accuracy}%`;
            showScreen('practice-complete-screen');
        }

        function startTimer(sec) {
            currentTimerValue = sec;
            updateTimerUI();
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (!isTestPaused) {
                    currentTimerValue--;
                    updateTimerUI();
                    if (currentTimerValue <= 0) { clearInterval(timerInterval); finishQuiz(); }
                }
            }, 1000);
        }

        function updateTimerUI() {
            const m = Math.floor(currentTimerValue / 60);
            const s = currentTimerValue % 60;
            document.getElementById('timer').textContent = `${m}:${s < 10 ? '0' + s : s}`;
        }

        function pauseTest() { isTestPaused = true; showFavoritesModal(); }
        function requestExitConfirmation() {
            isTestPaused = true;
            document.getElementById('exit-confirm-modal').style.display = 'flex';
            setTimeout(() => document.getElementById('exit-confirm-card').classList.add('active'), 10);
        }
        function cancelExit() {
            document.getElementById('exit-confirm-card').classList.remove('active');
            setTimeout(() => { document.getElementById('exit-confirm-modal').style.display = 'none'; isTestPaused = false; }, 300);
        }
        function confirmExit() {
            clearInterval(timerInterval);
            document.getElementById('exit-confirm-modal').style.display = 'none';
            backToWelcome();
        }

        function backToWelcome() {
            const updateBtn = (id, passed) => {
                const btn = document.getElementById(id);
                if (passed) {
                    btn.className = `w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300`;
                    if (!btn.textContent.includes('(å·²é€šé)')) btn.textContent += ' (å·²é€šé)';
                }
            };
            updateBtn('btn-quiz1', quizPassStatus.quiz1);
            updateBtn('btn-quiz2', quizPassStatus.quiz2);
            updateBtn('btn-quiz3', quizPassStatus.quiz3);
            showScreen('welcome-screen');
        }

        async function restartMission() {
            const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'github-ALCPT-app';
            const snaps = await getDocs(collection(db, 'artifacts', currentAppId, 'users', userId, 'favorites'));
            const batch = writeBatch(db);
            snaps.forEach(d => batch.delete(d.ref));
            await batch.commit();
            location.reload();
        }

        function speak(txt) {
            if (!txt) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(txt);
            u.lang = 'en-US';
            u.rate = 0.85;
            window.speechSynthesis.speak(u);
        }

        function playSound(type) {
            try {
                if (type === 'correct') synth.triggerAttackRelease("C5", "8n");
                else if (type === 'incorrect') synth.triggerAttackRelease("A3", "8n");
                else if (type === 'success') {
                    const now = Tone.now();
                    synth.triggerAttackRelease("C4", "8n", now);
                    synth.triggerAttackRelease("E4", "8n", now + 0.1);
                    synth.triggerAttackRelease("G4", "8n", now + 0.2);
                }
            } catch(e) {}
        }

        function showFavoritesModal() {
            const list = document.getElementById('favorites-list');
            list.innerHTML = favoriteKeywords.length === 0 ? '<p class="text-gray-500 text-center py-10">å°šç„¡æ”¶è—å–®å­—</p>' : '';
            favoriteKeywords.forEach(kw => {
                const item = document.createElement('div');
                item.className = 'p-4 bg-gray-900 rounded-xl border border-gray-700 mb-2 flex justify-between items-center';
                item.innerHTML = `
                    <div>
                        <div class="flex items-center space-x-2">
                            <p class="text-teal-300 font-bold text-lg">${kw.word}</p>
                            <button onclick="speak('${kw.word.replace(/'/g, "\\'")}')" class="text-blue-400 hover:text-white transition"><svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path d="M11 5L6 9H2v2h4l5 4V5z"/></svg></button>
                        </div>
                        <p class="text-gray-400 text-sm">${kw.translation}</p>
                    </div>
                    <button onclick='toggleFavorite(${JSON.stringify(kw).replace(/'/g, "\\'")})' class="text-red-400 font-bold px-4 py-2 bg-red-900 bg-opacity-20 border border-red-900 border-opacity-50 rounded-xl hover:bg-opacity-40 transition">ç§»é™¤</button>`;
                list.appendChild(item);
            });
            document.getElementById('favorites-modal').style.display = 'flex';
            setTimeout(() => document.getElementById('favorites-card').classList.add('active'), 10);
        }

        function hideFavoritesModal() {
            document.getElementById('favorites-card').classList.remove('active');
            setTimeout(() => { document.getElementById('favorites-modal').style.display = 'none'; isTestPaused = false; }, 300);
        }

        // Global Exports
        window.startQuiz = startQuiz;
        window.nextQuestion = nextQuestion;
        window.backToWelcome = backToWelcome;
        window.restartMission = restartMission;
        window.speak = speak;
        window.showFavoritesModal = showFavoritesModal;
        window.hideFavoritesModal = hideFavoritesModal;
        window.toggleFavorite = toggleFavorite;
        window.pauseTest = pauseTest;
        window.requestExitConfirmation = requestExitConfirmation;
        window.cancelExit = cancelExit;
        window.confirmExit = confirmExit;
        window.handleWordClick = handleWordClick;

        window.onload = initializeAppFirebase;
    </script>
</body>
</html>
