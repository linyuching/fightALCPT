<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALCPT 美軍英語能力測驗 練習</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .screen {
            display: none;
        }
        .active-screen {
            display: flex;
        }
        /* Custom styles for progress bar animation */
        .progress-bar-inner {
            transition: width 0.5s ease-in-out;
        }
        /* Custom styles for answer feedback */
        .correct-answer {
            background-color: #10B981 !important; /* Green-500 */
            border-color: #059669 !important;
        }
        .incorrect-answer {
            background-color: #EF4444 !important; /* Red-500 */
            border-color: #DC2626 !important;
        }
        .selected-answer {
             background-color: #3B82F6; /* Blue-500 */
             border-color: #2563EB;
        }
        
        /* Styles for Favorites Modal */
        #favorites-card {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        #favorites-card.active {
            transform: scale(1);
            opacity: 1;
        }
        /* NEW: Styles for Exit Confirm Modal */
        #exit-confirm-card {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        #exit-confirm-card.active {
            transform: scale(1);
            opacity: 1;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #FCD34D; /* yellow-400 */
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-2 sm:p-4">

    <div class="w-full max-w-3xl mx-auto">

        <!-- Screen 0: Loading (NEW) -->
        <div id="loading-screen" class="screen active-screen flex-col items-center text-center p-6 sm:p-8 bg-gray-800 rounded-2xl shadow-2xl">
            <h1 class="text-3xl sm:text-4xl font-bold text-yellow-400 mb-6">ALCPT 自我訓練</h1>
            <div class="spinner mb-4"></div>
            <p id="loading-text" class="text-base sm:text-lg text-gray-300">
                正在載入並自動登入...
            </p>
        </div>

        <!-- Screen 1: Welcome -->
        <div id="welcome-screen" class="screen flex-col items-center text-center p-6 sm:p-8 bg-gray-800 rounded-2xl shadow-2xl">
            <h1 class="text-3xl sm:text-4xl font-bold text-yellow-400 mb-4">ALCPT 自我訓練</h1>
            <p class="text-base sm:text-lg text-gray-300 mb-8 leading-relaxed">
                請選擇一個測驗題庫 (題庫一: 30題, 其餘: 20題)<br>每個題庫必須達到 80% 才算通過。
            </p>
            <!-- NEW: 3 Quiz Banks -->
            <div class="space-y-4 w-full max-w-sm">
                <button onclick="startQuiz('quiz1')" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-lg text-lg sm:text-xl transition duration-300 transform hover:scale-105">
                    題庫 (一)：詞彙練習 (30題)
                </button>
                <button onclick="startQuiz('quiz2')" class="w-full bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-3 px-6 rounded-lg text-lg sm:text-xl transition duration-300 transform hover:scale-105">
                    題庫 (二)：文法結構
                </button>
                <button onclick="startQuiz('quiz3')" class="w-full bg-teal-500 hover:bg-teal-600 text-gray-900 font-bold py-3 px-6 rounded-lg text-lg sm:text-xl transition duration-300 transform hover:scale-105">
                    題庫 (三)：模擬聽力
                </button>
            </div>
            
            <hr class="border-gray-600 my-6 w-full max-w-sm">
            
            <div class="space-y-4 w-full max-w-sm">
                <button onclick="showFavoritesModal()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg text-lg sm:text-xl transition duration-300">
                    我的最愛單字
                </button>
            </div>
             <p class="text-sm text-gray-400 mt-8">給自己更上一層的機會！ You can make it</p>
        </div>

        <!-- Screen 2: Test -->
        <div id="test-screen" class="screen flex-col w-full">
            <div class="bg-gray-800 rounded-2xl shadow-2xl p-4 sm:p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="test-title" class="text-xl sm:text-2xl font-bold text-yellow-400"></h2>
                    <div class="flex items-center space-x-2 sm:space-x-4">
                        <div id="question-counter" class="text-sm sm:text-lg text-gray-400 font-mono"></div>
                        <!-- NEW: Favorites Button during test -->
                        <button id="review-favorites-btn" onclick="pauseTest()" class="text-purple-300 hover:text-purple-200 flex items-center space-x-1 p-2 bg-gray-700 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg>
                            <span class="text-sm sm:text-lg font-mono">收藏</span>
                        </button>
                        <div id="timer" class="text-base sm:text-xl font-mono bg-gray-700 px-3 sm:px-4 py-2 rounded-lg">--:--</div>
                    </div>
                </div>
                <!-- Progress Bar -->
                <div class="w-full bg-gray-700 rounded-full h-4 mb-6">
                    <div id="progress-bar" class="bg-green-500 h-4 rounded-full progress-bar-inner" style="width: 0%"></div>
                </div>

                <div id="question-container" class="text-left">
                    <div id="question-text" class="text-lg sm:text-xl mb-6 text-gray-200 min-h-[60px]"></div>
                    <div id="audio-player" class="mb-6"></div> 
                    <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Options will be injected here -->
                    </div>
                    <div id="difficulty-actions" class="mt-4 flex justify-center space-x-4"></div>
                    <div id="post-answer-actions" class="mt-4 flex flex-wrap gap-2"></div>
                    <div id="post-answer-display" class="mt-4"></div>
                    <div id="keywords-display" class="mt-4"></div>
                </div>
                
                <!-- UPDATED: Changed justify-end to justify-between and added Exit button -->
                <div class="mt-8 flex justify-between items-center">
                    <!-- NEW: Exit Button -->
                    <button onclick="requestExitConfirmation()" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
                        &larr; 放棄測驗
                    </button>
                    <button id="next-button" onclick="nextQuestion()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        下一題
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Screen 5: Practice Complete (Renamed from Module Complete) -->
        <div id="practice-complete-screen" class="screen flex-col items-center text-center p-6 sm:p-8 bg-gray-800 rounded-2xl shadow-2xl">
            <h2 id="module-complete-title" class="text-2xl sm:text-3xl font-bold text-green-400 mb-4">測驗完成！</h2>
            <p id="module-complete-message" class="text-base sm:text-lg text-gray-300 mb-6"></p>
            <div class="text-lg sm:text-xl mb-8">本次成績 / Score: <span id="module-score" class="text-xl sm:text-2xl font-bold text-yellow-400"></span></div>
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                <button onclick="backToWelcome()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                    回題庫選單
                </button>
                <button onclick="restartMission()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                    重置收藏並回首頁
                </button>
            </div>
        </div>

    </div>
    
    <!-- Favorites Modal (NEW) -->
    <div id="favorites-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4" style="display: none; z-index: 998;">
        <div class="bg-gray-800 border-2 border-purple-400 rounded-2xl shadow-2xl p-6 sm:p-8 text-left transform transition-all scale-95 opacity-0 w-full max-w-2xl" id="favorites-card">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-purple-300">我的最愛單字</h3>
                <button onclick="hideFavoritesModal()" class="text-gray-300 hover:text-white text-3xl font-bold">&times;</button>
            </div>
            <div id="favorites-list" class="max-h-[60vh] overflow-y-auto space-y-3 p-1">
                <!-- Favorite keywords will be injected here from Firestore -->
            </div>
        </div>
    </div>

    <!-- NEW: Exit Confirmation Modal -->
    <div id="exit-confirm-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4" style="display: none; z-index: 999;">
        <div class="bg-gray-800 border-2 border-red-500 rounded-2xl shadow-2xl p-6 sm:p-8 text-center transform transition-all scale-95 opacity-0 w-full max-w-md" id="exit-confirm-card">
            <h3 class="text-2xl font-bold text-red-400 mb-4">即將離開測驗！</h3>
            <p class="text-lg text-gray-300 mb-6">
                您確定要放棄目前的測驗進度嗎？<br>
                <span class="text-yellow-400 mt-2 block">再堅持一下，別放棄挑戰！</span>
            </p>
            <div class="flex justify-center space-x-4">
                <button onclick="cancelExit()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                    繼續挑戰 (取消)
                </button>
                <button onclick="confirmExit()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                    確定放棄 (離開)
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- 導入 Firebase SDKs ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithCustomToken, 
            signInAnonymously 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            setLogLevel, 
            doc, 
            setDoc, 
            deleteDoc, 
            collection, 
            onSnapshot,
            getDocs, // Import getDocs for batch delete
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 全域 Firebase 變數 ---
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let favoriteKeywords = []; // 這將由 Firestore 即時更新
        let firestoreUnsubscribe = null; // 用於取消訂閱監聽器

        // --- 核心 Firebase 初始化 (MANDATORY) ---
        async function initializeAppFirebase() {
            try {
                // 1. 取得 Canvas 環境提供的設定
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                
                // --- !! 重要 !! ---
                // 這是您在上一個檔案中提供的 Firebase 設定。
                // 我將保留它，以便您的收藏功能可以繼續運作。
                const userProvidedConfig = {
                    apiKey: "AIzaSyDQSAW63lnKd3aCCiCt7pSmRa6ZPqOiIZI",
                    authDomain: "alcpt-f9d8d.firebaseapp.com",
                    projectId: "alcpt-f9d8d",
                    storageBucket: "alcpt-f9d8d.firebasestorage.app",
                    messagingSenderId: "885828022963",
                    appId: "1:885828022963:web:b18d3e49a19d3840d5b6c6"
                    };
                
                /*
                 * 這段邏輯會優先使用環境自動提供的 'firebaseConfig' (如果存在)。
                 * 否則, 它會回退到您上方貼上的 'userProvidedConfig'。
                 */
                const firebaseConfig = (typeof __firebase_config !== 'undefined') 
                    ? JSON.parse(__firebase_config) 
                    : userProvidedConfig;

                if (!firebaseConfig) {
                    document.getElementById('loading-text').innerText = '錯誤：Firebase 設定未提供。請編輯 HTML 檔案並填入您自己的 `userProvidedConfig`。';
                    console.error("Firebase config is missing.");
                    return; // 停止執行
                }
                
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                // 2. 初始化 Firebase
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // 開啟詳細日誌
                console.log("Firebase Initializing...");

                // 3. 監聽認證狀態
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("Authenticated User ID:", userId);
                        
                        // 認證成功，載入使用者的收藏
                        loadFavoriteKeywords(appId, userId);
                        
                        // 顯示主歡迎畫面
                        showScreen('welcome-screen');
                    } else {
                        // 登出或未登入
                        userId = null;
                        isAuthReady = false;
                        if (firestoreUnsubscribe) firestoreUnsubscribe(); // 停止監聽
                        favoriteKeywords = [];
                        console.log("User logged out.");
                        // 保持在載入畫面 (或顯示錯誤)
                        showScreen('loading-screen'); 
                    }
                });

                // 4. 執行登入 (MANDATORY)
                if (initialAuthToken) {
                    console.log("Signing in with Custom Token...");
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    console.log("Signing in Anonymously...");
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase Initialization Failed:", error);
                document.getElementById('loading-text').innerText = '錯誤：無法載入應用程式。請檢查控制台日誌。';
            }
        }

        // --- 載入使用者的收藏 (Firestore) ---
        function loadFavoriteKeywords(appId, uid) {
            if (!isAuthReady || !uid) return;
            if (firestoreUnsubscribe) firestoreUnsubscribe(); // 清除舊的監聽

            const favsColRef = collection(db, 'artifacts', appId, 'users', uid, 'favorites');
            
            // 使用 onSnapshot 建立即時監聽
            firestoreUnsubscribe = onSnapshot(favsColRef, (snapshot) => {
                favoriteKeywords = [];
                snapshot.forEach((doc) => {
                    favoriteKeywords.push(doc.data());
                });
                console.log("Firestore: Favorites loaded:", favoriteKeywords.length);

                // 如果彈窗正開著，即時刷新它
                if (favoritesModal.style.display === 'flex') {
                    showFavoritesModal();
                }

                // 如果關鍵單字卡正開著，也即時刷新它
                const keywordsButton = document.querySelector('#post-answer-actions button');
                if (keywordsButton && keywordsDisplay.innerHTML !== '') {
                    keywordsButton.click(); // 重新觸發點擊以刷新
                }
            });
        }

        // --- 更新版：切換收藏 (寫入/刪除 Firestore) ---
        async function toggleFavoriteKeyword(kw, buttonEl) {
            if (!isAuthReady || !userId) {
                console.error("Auth not ready. Cannot toggle favorite.");
                return;
            }
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            // FIX: Replace invalid characters (like '/') from the word before using it as a doc ID.
            const docId = kw.word.replace(/[\/]/g, '_'); // 移除會造成路徑錯誤的斜線
            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'favorites', docId);

            const isCurrentlyFavorite = favoriteKeywords.some(favKw => favKw.word === kw.word);

            try {
                if (isCurrentlyFavorite) {
                    // 存在，所以刪除
                    await deleteDoc(docRef);
                    console.log(`Firestore: Removed "${docId}"`);
                } else {
                    // 不存在，所以新增
                    await setDoc(docRef, kw);
                    console.log(`Firestore: Added "${docId}"`);
                }
                // UI (愛心) 的更新將由 onSnapshot 自動處理，無需手動
            } catch (e) {
                console.error("Favorite toggle failed:", e);
            }
        }

        // --- 更新版：重置任務 (包含清空 Firestore 收藏) ---
        async function restartMission() {
            if (!isAuthReady || !userId) {
                backToWelcome();
                return;
            }
            
            // 0. 取得 user ID
            const uid = auth.currentUser.uid;
            
            // 1. 清空 Firestore 上的收藏 (使用 batch write)
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const favsColRef = collection(db, 'artifacts', appId, 'users', uid, 'favorites');
                
                // 為了安全，我們先讀取一次
                const snapshot = await getDocs(favsColRef); // Use getDocs for one-time read
                const batch = writeBatch(db);
                snapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                console.log("Firestore: All favorites cleared.");
            } catch (e) {
                console.error("Failed to clear Firestore favorites:", e);
            }

            // 2. 清空本地狀態
            if (firestoreUnsubscribe) firestoreUnsubscribe();
            isAuthReady = false;
            userId = null;
            favoriteKeywords = [];
            quizPassStatus = { quiz1: false, quiz2: false, quiz3: false }; // NEW: 重置通關狀態
            
            // 3. 顯示載入畫面並重新認證
            showScreen('loading-screen');
            await auth.signOut(); // 登出
            initializeAppFirebase(); // 重新執行登入流程
        }

        // --- NEW ALCPT DATA ---
        // 我無法存取真實的 ALCPT 歷屆試題，因此這裡提供了模擬的 ALCPT 題型，
        // 包含詞彙、文法和模擬聽力腳本。
        const alcptQuizBanks = {
            // --- 題庫 1: 詞彙 --- (20 題)
            'quiz1': [
                { type: 'reading', difficulty: 1, question: "The soldier must ____ his orders immediately.", translation: "士兵必須立即____他的命令。", options: ["obey", "object", "offer", "open"], answer: 0, keywords: [
                    { word: 'obey', translation: '服從', example: 'You must obey the rules.', example_translation: '你必須服從規則。' }
                ]},
                { type: 'reading', difficulty: 1, question: "What is the ____ of this meeting? We need to know why we are here.", translation: "這次會議的____是什麼？我們需要知道我們為什麼在這裡。", options: ["purpose", "problem", "price", "permit"], answer: 0, keywords: [
                    { word: 'purpose', translation: '目的', example: 'The purpose of the visit is to inspect the site.', example_translation: '這次訪問的目的是視察現場。' }
                ]},
                { type: 'reading', difficulty: 2, question: "The mechanic needs to ____ the engine to see what's wrong.", translation: "技工需要____引擎來查看出了什麼問題。", options: ["inspect", "inject", "invite", "invent"], answer: 0, keywords: [
                    { word: 'inspect', translation: '檢查；視察', example: 'He inspected the vehicle for damage.', example_translation: '他檢查了車輛的損壞情況。' }
                ]},
                { type: 'reading', difficulty: 2, question: "This is a restricted area; ____ is not allowed.", translation: "這是管制區域；不允許____。", options: ["entry", "exit", "error", "effort"], answer: 0, keywords: [
                    { word: 'entry', translation: '進入', example: 'Entry is forbidden.', example_translation: '禁止進入。' }
                ]},
                { type: 'reading', difficulty: 2, question: "The storm caused ____ damage to the base.", translation: "暴風雨對基地造成了____的損害。", options: ["considerable", "considerate", "constant", "conscious"], answer: 0, keywords: [
                    { word: 'considerable', translation: '相當大的', example: 'The project requires a considerable amount of time.', example_translation: '這個計畫需要相當多的時間。' }
                ]},
                { type: 'reading', difficulty: 1, question: "You need a special ____ to enter this building.", translation: "你需要特別的____才能進入這棟大樓。", options: ["permit", "person", "pencil", "party"], answer: 0, keywords: [
                    { word: 'permit', translation: '許可證', example: 'Do you have a parking permit?', example_translation: '你有停車許可證嗎？' }
                ]},
                { type: 'reading', difficulty: 2, question: "The mission was successful ____ the bad weather.", translation: "____天氣惡劣，任務還是成功了。", options: ["in spite of", "because of", "instead of", "thanks to"], answer: 0, keywords: [
                    { word: 'in spite of', translation: '儘管', example: 'He went out in spite of the rain.', example_translation: '儘管下雨，他還是出去了。' }
                ]},
                { type: 'reading', difficulty: 3, question: "All personnel must ____ in the assembly area at 0800 hours.", translation: "所有人員必須在 0800 時在集合區____。", options: ["assemble", "assign", "assist", "assume"], answer: 0, keywords: [
                    { word: 'assemble', translation: '集合', example: 'The troops assembled on the parade ground.', example_translation: '部隊在閱兵場集合。' }
                ]},
                { type: 'reading', difficulty: 2, question: "A good leader should be able to ____ his team.", translation: "一個好的領導者應該能夠____他的團隊。", options: ["motivate", "mention", "measure", "mix"], answer: 0, keywords: [
                    { word: 'motivate', translation: '激勵', example: 'The coach motivated the players.', example_translation: '教練激勵了球員。' }
                ]},
                { type: 'reading', difficulty: 1, question: "A ____ is a large, heavy vehicle used by the military.", translation: "____是一種軍用的大型重型車輛。", options: ["tank", "task", "tape", "tax"], answer: 0, keywords: [
                    { word: 'tank', translation: '坦克；水箱', example: 'The tank moved across the field.', example_translation: '坦克駛過田野。' }
                ]},
                { type: 'reading', difficulty: 2, question: "It is ____ to wear your seatbelt in a moving car.", translation: "在行駛的汽車上繫安全帶是____的。", options: ["mandatory", "manual", "modest", "major"], answer: 0, keywords: [
                    { word: 'mandatory', translation: '強制的；義務的', example: 'Attendance is mandatory.', example_translation: '出席是強制的。' }
                ]},
                { type: 'reading', difficulty: 3, question: "The sergeant gave a ____ description of the suspect.", translation: "中士對嫌疑人進行了____的描述。", options: ["vivid", "vague", "various", "virtual"], answer: 0, keywords: [
                    { word: 'vivid', translation: '生動的', example: 'He has a vivid imagination.', example_translation: '他有豐富的想像力。' },
                    { word: 'vague', translation: '模糊的', example: 'His instructions were vague.', example_translation: '他的指示很模糊。' }
                ]},
                { type: 'reading', difficulty: 1, question: "Please ____ the main gate at 0600.", translation: "請於 0600 時在正門____。", options: ["report to", "report on", "run into", "run out of"], answer: 0, keywords: [
                    { word: 'report to', translation: '向...報到', example: 'Please report to Sergeant Miller.', example_translation: '請向米勒中士報到。' }
                ]},
                { type: 'reading', difficulty: 2, question: "The equipment is not working ____. It needs to be fixed.", translation: "設備運作不____。它需要修理。", options: ["properly", "partially", "privately", "previously"], answer: 0, keywords: [
                    { word: 'properly', translation: '正確地；妥善地', example: 'Make sure the machine is working properly.', example_translation: '確保機器正常運作。' }
                ]},
                { type: 'reading', difficulty: 2, question: "We must ____ the enemy from advancing.", translation: "我們必須____敵人前進。", options: ["prevent", "protect", "promote", "provide"], answer: 0, keywords: [
                    { word: 'prevent', translation: '阻止；預防', example: 'We must prevent the fire from spreading.', example_translation: '我們必須防止火勢蔓延。' }
                ]},
                { type: 'reading', difficulty: 3, question: "The operation was a ____ failure; everything went wrong.", translation: "這次行動是一次____的失敗；一切都出了差錯。", options: ["complete", "complex", "common", "calm"], answer: 0, keywords: [
                    { word: 'complete', translation: '完全的', example: 'It was a complete surprise.', example_translation: '這真是個十足的驚喜。' }
                ]},
                { type: 'reading', difficulty: 1, question: "What is your ____ of rank?", translation: "你的____是什麼？", options: ["grade", "grass", "glue", "gas"], answer: 0, keywords: [
                    { word: 'grade', translation: '等級；階級', example: 'He is a high-grade officer.', example_translation: '他是一名高級軍官。' }
                ]},
                { type: 'reading', difficulty: 2, question: "The supplies will ____ tomorrow morning.", translation: "補給品將在明天早上____。", options: ["arrive", "achieve", "attack", "affect"], answer: 0, keywords: [
                    { word: 'arrive', translation: '到達', example: 'The train will arrive at 10 AM.', example_translation: '火車將於上午 10 點到達。' }
                ]},
                { type: 'reading', difficulty: 2, question: "The new rules will ____ all military personnel.", translation: "新規定將____所有軍事人員。", options: ["apply to", "apply for", "ask for", "account for"], answer: 0, keywords: [
                    { word: 'apply to', translation: '適用於', example: 'The rule applies to everyone.', example_translation: '這規則適用於所有人。' }
                ]},
                { type: 'reading', difficulty: 3, question: "The mission was ____ due to a security breach.", translation: "由於安全漏洞，任務被____了。", options: ["terminated", "translated", "transferred", "transformed"], answer: 0, keywords: [
                    { word: 'terminated', translation: '終止 (v. 過去式)', example: 'The contract was terminated.', example_translation: '合約被終止了。' }
                ]},
                // --- NEW 10 Vocab/Phrasal Questions Added ---
                { type: 'reading', difficulty: 2, question: "The commander will ____ the soldier's complaint.", translation: "指揮官將會____這名士兵的投訴。", options: ["look into", "look over", "look up to", "look down on"], answer: 0, keywords: [
                    { word: 'look into', translation: '調查', example: 'We will look into the matter.', example_translation: '我們會調查這件事。' }
                ]},
                { type: 'reading', difficulty: 2, question: "They had to ____ the training exercise due to the storm.", translation: "由於暴風雨，他們不得不____訓練演習。", options: ["call off", "call on", "call for", "call out"], answer: 0, keywords: [
                    { word: 'call off', translation: '取消', example: 'They called off the meeting.', example_translation: '他們取消了會議。' }
                ]},
                { type: 'reading', difficulty: 2, question: "I cannot ____ this noise any longer.", translation: "我再也無法____這種噪音了。", options: ["put up with", "put on", "put off", "put out"], answer: 0, keywords: [
                    { word: 'put up with', translation: '忍受', example: 'I can\'t put up with his attitude.', example_translation: '我無法忍受他的態度。' }
                ]},
                { type: 'reading', difficulty: 2, question: "We need ____ equipment that won't break in the field.", translation: "我們需要不會在現場故障的____設備。", options: ["reliable", "reluctant", "relative", "religious"], answer: 0, keywords: [
                    { word: 'reliable', translation: '可靠的', example: 'He is a reliable source of information.', example_translation: '他是個可靠的資訊來源。' }
                ]},
                { type: 'reading', difficulty: 2, question: "The patrol is in danger of ____ ammunition.", translation: "巡邏隊有____彈藥的危險。", options: ["running out of", "running into", "running over", "running away"], answer: 0, keywords: [
                    { word: 'run out of', translation: '用完', example: 'We are running out of time.', example_translation: '我們的時間快用完了。' }
                ]},
                { type: 'reading', difficulty: 1, question: "The map must be ____ to be useful.", translation: "地圖必須____才有用。", options: ["accurate", "ancient", "anxious", "active"], answer: 0, keywords: [
                    { word: 'accurate', translation: '精確的', example: 'The report is accurate.', example_translation: '這份報告是精確的。' }
                ]},
                { type: 'reading', difficulty: 2, question: "Our vehicle ____ in the middle of the desert.", translation: "我們的車輛在沙漠中央____了。", options: ["broke down", "broke into", "broke up", "broke out"], answer: 0, keywords: [
                    { word: 'broke down', translation: '故障 (break down的過去式)', example: 'My car broke down.', example_translation: '我的車拋錨了。' }
                ]},
                { type: 'reading', difficulty: 1, question: "It is ____ that all personnel follow safety procedures.", translation: "所有人員遵守安全程序是____的。", options: ["essential", "expensive", "extra", "easy"], answer: 0, keywords: [
                    { word: 'essential', translation: '必要的', example: 'Water is essential for life.', example_translation: '水是生命所必需的。' }
                ]},
                { type: 'reading', difficulty: 2, question: "The soldiers were ordered to ____ the mission at dawn.", translation: "士兵們被命令在黎明時____任務。", options: ["carry out", "carry on", "carry off", "carry over"], answer: 0, keywords: [
                    { word: 'carry out', translation: '執行', example: 'They will carry out the plan.', example_translation: '他們將執行這項計畫。' }
                ]},
                { type: 'reading', difficulty: 1, question: "Do we have ____ food for the next three days?", translation: "我們未來三天有____的食物嗎？", options: ["sufficient", "specific", "secure", "separate"], answer: 0, keywords: [
                    { word: 'sufficient', translation: '足夠的', example: 'We have sufficient time.', example_translation: '我們有足夠的時間。' }
                ]},
            ],
            // --- 題庫 2: 文法 --- (20 題)
            'quiz2': [
                { type: 'reading', difficulty: 1, question: "The soldier ____ on duty right now.", translation: "那位士兵現在正在____。", options: ["is", "are", "was", "be"], answer: 0, keywords: [
                    { word: 'is', translation: '是 (be動詞第三人稱單數)', example: 'He is a doctor.', example_translation: '他是一名醫生。' }
                ]},
                { type: 'reading', difficulty: 1, question: "He ____ to the training center yesterday.", translation: "他昨天____訓練中心。", options: ["went", "goes", "has gone", "will go"], answer: 0, keywords: [
                    { word: 'went', translation: '去 (go的過去式)', example: 'I went home early.', example_translation: '我很早就回家了。' }
                ]},
                { type: 'reading', difficulty: 2, question: "If you study hard, you ____ the test.", translation: "如果你努力學習，你____考試。", options: ["will pass", "passed", "would pass", "pass"], answer: 0, keywords: [
                    { word: 'will pass', translation: '將會通過 (未來式)', example: 'If it doesn\'t rain, we will go.', example_translation: '如果不下雨，我們就去。' }
                ]},
                { type: 'reading', difficulty: 2, question: "He has been a soldier ____ five years.", translation: "他當兵____五年了。", options: ["for", "since", "at", "in"], answer: 0, keywords: [
                    { word: 'for', translation: '持續 (一段時間)', example: 'I have lived here for two years.', example_translation: '我已經在這裡住了兩年。' }
                ]},
                { type: 'reading', difficulty: 2, question: "The report must be finished ____ Friday.", translation: "報告必須在週五____完成。", options: ["by", "on", "at", "until"], answer: 0, keywords: [
                    { word: 'by', translation: '不晚於；藉由', example: 'Please finish it by 5 PM.', example_translation: '請在下午 5 點前完成。' }
                ]},
                { type: 'reading', difficulty: 1, question: "This is the ____ rifle I have ever used.", translation: "這是我用過____的步槍。", options: ["best", "good", "better", "well"], answer: 0, keywords: [
                    { word: 'best', translation: '最好的 (good的最高級)', example: 'This is the best movie.', example_translation: '這是最棒的電影。' }
                ]},
                { type: 'reading', difficulty: 2, question: "You ____ smoke in this building. It's forbidden.", translation: "你____在這棟大樓裡吸煙。這是被禁止的。", options: ["must not", "do not", "should", "can"], answer: 0, keywords: [
                    { word: 'must not', translation: '絕不可以', example: 'You must not cheat.', example_translation: '你絕不可作弊。' }
                ]},
                { type: 'reading', difficulty: 2, question: "Listen! Someone ____ for help.", translation: "聽！有人在____求救。", options: ["is crying", "cries", "cried", "has cried"], answer: 0, keywords: [
                    { word: 'is crying', translation: '正在哭 (現在進行式)', example: 'The baby is crying.', example_translation: '嬰兒正在哭。' }
                ]},
                { type: 'reading', difficulty: 3, question: "The supplies ____ by the aircraft this morning.", translation: "補給品今天早上由飛機____。", options: ["were delivered", "delivered", "was delivering", "deliver"], answer: 0, keywords: [
                    { word: 'were delivered', translation: '被運送 (被動語態，過去式)', example: 'The packages were delivered yesterday.', example_translation: '包裹昨天被送達了。' }
                ]},
                { type: 'reading', difficulty: 2, question: "He asked me ____ I knew the way.", translation: "他問我____是否知道路。", options: ["if", "that", "what", "which"], answer: 0, keywords: [
                    { word: 'if', translation: '是否 (間接問句)', example: 'He asked if I was ready.', example_translation: '他問我是否準備好了。' }
                ]},
                { type: 'reading', difficulty: 1, question: "There isn't ____ water left in the bottle.", translation: "瓶子裡沒有____水了。", options: ["any", "some", "no", "many"], answer: 0, keywords: [
                    { word: 'any', translation: '任何 (用於否定句/疑問句)', example: 'I don\'t have any money.', example_translation: '我沒有任何錢。' }
                ]},
                { type: 'reading', difficulty: 2, question: "The captain, ____ all his men, was ready for inspection.", translation: "上尉，____他所有的士兵，都準備好接受檢查了。", options: ["as well as", "as good as", "as soon as", "as far as"], answer: 0, keywords: [
                    { word: 'as well as', translation: '以及', example: 'He is smart as well as kind.', example_translation: '他又聰明又善良。' }
                ]},
                { type: 'reading', difficulty: 3, question: "By the time the reinforcements arrived, the battle ____.", translation: "當援軍到達時，戰鬥已經____。", options: ["had ended", "ended", "will end", "ends"], answer: 0, keywords: [
                    { word: 'had ended', translation: '已經結束 (過去完成式)', example: 'By the time I got there, the movie had started.', example_translation: '當我到那裡時，電影已經開始了。' }
                ]},
                { type: 'reading', difficulty: 1, question: "The new recruit is ____ than the others.", translation: "這位新兵比其他人____。", options: ["taller", "tall", "tallest", "more tall"], answer: 0, keywords: [
                    { word: 'taller', translation: '更高的 (比較級)', example: 'He is taller than me.', example_translation: '他比我高。' }
                ]},
                { type: 'reading', difficulty: 2, question: "He drives very ____. He might have an accident.", translation: "他開車非常____。他可能會出意外。", options: ["dangerously", "dangerous", "danger", "in danger"], answer: 0, keywords: [
                    { word: 'dangerously', translation: '危險地 (副詞)', example: 'He lives dangerously.', example_translation: '他過著危險的生活。' }
                ]},
                { type: 'reading', difficulty: 2, question: "He is responsible ____ cleaning the barracks.", translation: "他負責____營房。", options: ["for", "to", "at", "with"], answer: 0, keywords: [
                    { word: 'responsible for', translation: '對...負責', example: 'Who is responsible for this mess?', example_translation: '誰該為這一團亂負責？' }
                ]},
                { type: 'reading', difficulty: 3, question: "____ it was raining, the soldiers continued their training.", translation: "____下著雨，士兵們繼續他們的訓練。", options: ["Although", "Because", "So", "However"], answer: 0, keywords: [
                    { word: 'Although', translation: '雖然', example: 'Although he was tired, he kept working.', example_translation: '雖然他很累，他仍繼續工作。' }
                ]},
                { type: 'reading', difficulty: 2, question: "He spends a lot of time ____ his rifle.", translation: "他花很多時間____他的步槍。", options: ["cleaning", "clean", "to clean", "cleaned"], answer: 0, keywords: [
                    { word: 'spend time (V-ing)', translation: '花時間做...', example: 'I spend time reading books.', example_translation: '我花時間讀書。' }
                ]},
                { type: 'reading', difficulty: 2, question: "The General ordered the bridge ____.", translation: "將軍下令____這座橋。", options: ["to be destroyed", "destroy", "destroyed", "destroying"], answer: 0, keywords: [
                    { word: 'order (sb/sth) to be (Vpp)', translation: '命令(某物)被...', example: 'He ordered the room to be cleaned.', example_translation: '他下令房間要被打掃。' }
                ]},
                { type: 'reading', difficulty: 3, question: "____ have you been stationed at this base?", translation: "你駐紮在這個基地____了？", options: ["How long", "How much", "How often", "How far"], answer: 0, keywords: [
                    { word: 'How long', translation: '多久 (詢問時間長度)', example: 'How long have you been here?', example_translation: '你在這裡多久了？' }
                ]},
            ],
            // --- 題庫 3: 模擬聽力 --- (20 題)
            'quiz3': [
                { type: 'listening', difficulty: 1, question: "Man: Do you know where the mess hall is?\nWoman: It's the building on your left.\n\n(Narrator): What does the woman tell the man?", translation: "男：你知道餐廳在哪嗎？\n女：它在你左邊那棟建築物。\n\n(旁白)：這位女士告訴了男士什麼？", options: ["(A) The location of the mess hall.", "(B) What is on the menu.", "(C) The building is closed.", "(D) He left his building."], answer: 0, keywords: [
                    { word: 'mess hall', translation: '餐廳 (軍用)', example: 'Soldiers eat in the mess hall.', example_translation: '士兵們在餐廳吃飯。' },
                    { word: 'location', translation: '位置', example: 'What is your current location?', example_translation: '你目前的位置在哪？' }
                ]},
                { type: 'listening', difficulty: 1, question: "Woman: What time is the briefing?\nMan: It starts at 0900 sharp.\n\n(Narrator): What did the man say about the briefing?", translation: "女：簡報是什麼時候？\n男：九點準時開始。\n\n(旁白)：關於簡報，這位男士說了什麼？", options: ["(A) It begins exactly at 9 AM.", "(B) It is a very sharp briefing.", "(C) It has been canceled.", "(D) It is at 9 PM."], answer: 0, keywords: [
                    { word: 'briefing', translation: '簡報', example: 'The daily briefing is at 0800.', example_translation: '每日簡報在 0800。' },
                    { word: 'sharp', translation: '準時；鋒利的', example: 'The meeting is at 3 PM sharp.', example_translation: '會議在下午 3 點準時開始。' }
                ]},
                { type: 'listening', difficulty: 2, question: "Man: I can't find my ID card.\nWoman: You'd better report it immediately.\n\n(Narrator): What does the woman suggest the man do?", translation: "男：我找不到我的識別證。\n女：你最好立刻回報。\n\n(旁白)：這位女士建議男士做什麼？", options: ["(A) Report the loss right away.", "(B) Look for it in his room.", "(C) Get a new ID card tomorrow.", "(D) Go to the new building."], answer: 0, keywords: [
                    { word: 'ID card', translation: '識別證', example: 'You need an ID card to enter.', example_translation: '你需要識別證才能進入。' },
                    { word: 'report', translation: '回報；報告', example: 'He reported the incident.', example_translation: '他回報了這起事件。' }
                ]},
                { type: 'listening', difficulty: 2, question: "Man: How's the weather for tomorrow's training?\nWoman: They said it's going to be extremely hot.\n\n(Narrator): What did the woman say about the weather?", translation: "男：明天的訓練天氣如何？\n女：他們說將會非常熱。\n\n(旁白)：關於天氣，這位女士說了什麼？", options: ["(A) It will be very hot.", "(B) It will be cold.", "(C) It will rain.", "(D) The training is cancelled."], answer: 0, keywords: [
                    { word: 'extremely', translation: '極度地', example: 'It is extremely important.', example_translation: '這極度重要。' }
                ]},
                { type: 'listening', difficulty: 1, question: "Man: Did you finish the report?\nWoman: No, I need more time.\n\n(Narrator): What does the woman mean?", translation: "男：你完成報告了嗎？\n女：還沒，我需要更多時間。\n\n(旁白)：這位女士是什麼意思？", options: ["(A) She has not completed the report.", "(B) The report was too long.", "(C) She finished it on time.", "(D) She will report the man."], answer: 0, keywords: [
                    { word: 'complete', translation: '完成', example: 'Please complete this form.', example_translation: '請完成這張表格。' }
                ]},
                { type: 'listening', difficulty: 2, question: "Woman: This vehicle needs fuel.\nMan: Let's take it to the gas station.\n\n(Narrator): Why are they going to the gas station?", translation: "女：這台車需要燃料了。\n男：我們把它開去加油站吧。\n\n(旁白)：他們為什麼要去加油站？", options: ["(A) The vehicle is out of gas.", "(B) The vehicle is broken.", "(C) They need to buy snacks.", "(D) They are going to the station."], answer: 0, keywords: [
                    { word: 'vehicle', translation: '車輛', example: 'a military vehicle', example_translation: '一輛軍車。' },
                    { word: 'fuel', translation: '燃料', example: 'The car needs fuel.', example_translation: '車子需要燃料。' }
                ]},
                { type: 'listening', difficulty: 2, question: "Man: I have a severe headache.\nWoman: You should go to the clinic.\n\n(Narrator): Where does the woman tell the man to go?", translation: "男：我頭痛得很嚴重。\n女：你應該去診所。\n\n(旁白)：女士叫男士去哪裡？", options: ["(A) To the medical facility.", "(B) To the dining hall.", "(C) To his room.", "(D) To the training field."], answer: 0, keywords: [
                    { word: 'severe', translation: '嚴重的', example: 'a severe storm', example_translation: '一場嚴重的暴風雨。' },
                    { word: 'clinic', translation: '診所', example: 'The base clinic is open.', example_translation: '基地診所是開放的。' }
                ]},
                { type: 'listening', difficulty: 3, question: "Woman: The commander wants this done by tomorrow.\nMan: That's impossible, we don't have enough personnel.\n\n(Narrator): Why does the man think it's impossible?", translation: "女：指揮官希望這件事明天完成。\n男：那不可能，我們沒有足夠的人員。\n\n(旁白)：為什麼男士認為這不可能？", options: ["(A) They are short-staffed.", "(B) The commander is wrong.", "(C) It is too easy.", "(D) They have enough time."], answer: 0, keywords: [
                    { word: 'commander', translation: '指揮官', example: 'The commander gave the order.', example_translation: '指揮官下達了命令。' },
                    { word: 'personnel', translation: '人員 (總稱)', example: 'All personnel must attend.', example_translation: '所有人員都必須參加。' }
                ]},
                { type: 'listening', difficulty: 1, question: "Man: Turn right at the next intersection.\nWoman: Roger that.\n\n(Narrator): What does the woman mean?", translation: "男：在下個交叉口右轉。\n女：收到。\n\n(旁白)：這位女士是什麼意思？", options: ["(A) She understands the instruction.", "(B) Her name is Roger.", "(C) She will turn left.", "(D) She does not understand."], answer: 0, keywords: [
                    { word: 'intersection', translation: '交叉口', example: 'Stop at the intersection.', example_translation: '在交叉口停下。' },
                    { word: 'Roger that', translation: '收到 (無線電用語)', example: '"Roger that," the pilot said.', example_translation: '「收到。」飛行員說。' }
                ]},
                { type: 'listening', difficulty: 2, question: "Man: The drill is scheduled for 1400.\nWoman: Has it been confirmed?\n\n(Narrator): What does the woman want to know?", translation: "男：演習預定在 1400 進行。\n女：已經確認了嗎？\n\n(旁白)：這位女士想知道什麼？", options: ["(A) If the time is definite.", "(B) If the drill is cancelled.", "(C) What the drill is for.", "(D) Where the drill is."], answer: 0, keywords: [
                    { word: 'drill', translation: '演習', example: 'a fire drill', example_translation: '消防演習。' },
                    { word: 'confirmed', translation: '已確認的', example: 'The schedule is confirmed.', example_translation: '行程已確認。' }
                ]},
                { type: 'listening', difficulty: 2, question: "Man: It's freezing in here.\nWoman: I'll turn up the heat.\n\n(Narrator): What will the woman do?", translation: "男：這裡冷死了。\n女：我把暖氣調高一點。\n\n(旁白)：這位女士將會做什麼？", options: ["(A) Make the room warmer.", "(B) Make the room colder.", "(C) Go outside.", "(D) Open the window."], answer: 0, keywords: [
                    { word: 'freezing', translation: '極冷的', example: 'It\'s freezing outside.', example_translation: '外面冷死了。' },
                    { word: 'turn up', translation: '調高 (音量、溫度)', example: 'Turn up the music.', example_translation: '把音樂開大聲點。' }
                ]},
                { type: 'listening', difficulty: 2, question: "Woman: Are these your belongings?\nMan: Yes, they are. Thank you.\n\n(Narrator): What did the woman find?", translation: "女：這些是你的私人物品嗎？\n男：是的，是我的。謝謝你。\n\n(旁白)：這位女士找到了什麼？", options: ["(A) The man's personal items.", "(B) The man's uniform.", "(C) The man's orders.", "(D) The man's friend."], answer: 0, keywords: [
                    { word: 'belongings', translation: '所有物；行李', example: 'Please take all your belongings.', example_translation: '請帶上你所有的物品。' }
                ]},
                { type: 'listening', difficulty: 3, question: "Man: Did you calibrate the equipment?\nWoman: I'm still working on it.\n\n(Narrator): What is the woman doing?", translation: "男：你校準設備了嗎？\n女：我還在處理。\n\n(旁白)：這位女士正在做什麼？", options: ["(A) She is adjusting the equipment.", "(B) She is buying new equipment.", "(C) She is finished with her work.", "(D) She is celebrating."], answer: 0, keywords: [
                    { word: 'calibrate', translation: '校準', example: 'You must calibrate the tools.', example_translation: '你必須校準這些工具。' }
                ]},
                { type: 'listening', difficulty: 1, question: "Man: Please stand by.\nWoman: Standing by.\n\n(Narrator): What did the man tell the woman to do?", translation: "男：請待命。\n女：待命中。\n\n(旁白)：男士叫女士做什麼？", options: ["(A) To wait.", "(B) To stand up.", "(C) To leave.", "(D) To sit down."], answer: 0, keywords: [
                    { word: 'stand by', translation: '待命', example: 'The rescue team is standing by.', example_translation: '救援隊正在待命。' }
                ]},
                { type: 'listening', difficulty: 2, question: "Woman: What are your duties today?\nMan: I'm on guard duty tonight.\n\n(Narrator): What is the man's task?", translation: "女：你今天的職責是什麼？\n男：我今晚站衛兵。\n\n(旁白)：這位男士的任務是什麼？", options: ["(A) He will be a guard.", "(B) He will be sleeping.", "(C) He will be off duty.", "(D) He will be driving."], answer: 0, keywords: [
                    { word: 'guard duty', translation: '衛兵勤務', example: 'He has guard duty from 12 to 4.', example_translation: '他 12 點到 4 點站衛兵。' }
                ]},
                { type: 'listening', difficulty: 2, question: "Man: This mission is hazardous.\nWoman: I know, we must be careful.\n\n(Narrator): What did the man say about the mission?", translation: "男：這項任務很危險。\n女：我知道，我們必須小心。\n\n(旁白)：關於這項任務，男士說了什麼？", options: ["(A) It is dangerous.", "(B) It is easy.", "(C) It is finished.", "(D) It is boring."], answer: 0, keywords: [
                    { word: 'hazardous', translation: '危險的', example: 'hazardous materials', example_translation: '危險物質。' }
                ]},
                { type: 'listening', difficulty: 3, question: "Woman: Did you read the memorandum?\nMan: Not yet, I just got here.\n\n(Narrator): What has the man not read?", translation: "女：你讀了那份備忘錄嗎？\n男：還沒，我剛到。\n\n(旁白)：這位男士還沒讀什麼？", options: ["(A) The official note.", "(B) The newspaper.", "(C) The menu.", "(D) The book."], answer: 0, keywords: [
                    { word: 'memorandum', translation: '備忘錄', example: 'A memorandum was sent to all staff.', example_translation: '一份備忘錄已發給所有員工。' }
                ]},
                { type: 'listening', difficulty: 2, question: "Man: Are you familiar with this weapon?\nWoman: Yes, I've trained with it extensively.\n\n(Narrator): What does the woman mean?", translation: "男：你熟悉這款武器嗎？\n女：是的，我用它做過密集的訓練。\n\n(旁白)：這位女士是什麼意思？", options: ["(A) She has used it a lot.", "(B) She has never seen it.", "(C) It is a new weapon.", "(D) She does not like it."], answer: 0, keywords: [
                    { word: 'familiar with', translation: '熟悉', example: 'Are you familiar with this area?', example_translation: '你對這個地區熟悉嗎？' },
                    { word: 'extensively', translation: '廣泛地；密集地', example: 'He traveled extensively.', example_translation: '他遊歷甚廣。' }
                ]},
                { type: 'listening', difficulty: 1, question: "Man: What's your rank?\nWoman: I'm a private.\n\n(Narrator): What did the man ask the woman?", translation: "男：你是什麼階級？\n女：我是一名二等兵。\n\n(旁白)：男士問了女士什麼？", options: ["(A) Her military grade.", "(B) Her bank account.", "(C) Her name.", "(D) Her job."], answer: 0, keywords: [
                    { word: 'rank', translation: '階級', example: 'He holds the rank of Captain.', example_translation: '他是上尉軍銜。' },
                    { word: 'private', translation: '二等兵', example: 'He is a Private First Class.', example_translation: '他是一等兵。' }
                ]},
                { type: 'listening', difficulty: 3, question: "Woman: The coordinates are 34 North, 118 West.\nMan: I've got it. Proceeding to target.\n\n(Narrator): What did the woman provide?", translation: "女：座標是北緯 34 度，西經 118 度。\n男：我收到了。正前往目標。\n\n(旁白)：這位女士提供了什麼？", options: ["(A) A specific location.", "(B) The time of day.", "(C) The weather report.", "(D) The name of the target."], answer: 0, keywords: [
                    { word: 'coordinates', translation: '座標', example: 'Give me your coordinates.', example_translation: '給我你的座標。' },
                    { word: 'proceeding', translation: '前進 (v-ing)', example: 'The plan is proceeding well.', example_translation: '計畫進展順利。' }
                ]},
            ]
        };


        // --- STATE MANAGEMENT ---
        let currentTest = '';
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0; // Simplified score
        let timerInterval;
        let currentTimerValue = 0; // NEW: For timer pause
        let isTestPaused = false; // NEW: For timer pause
        let diagnosticResults = null;
        let learnedKeywords = [];
        let quizPassStatus = { quiz1: false, quiz2: false, quiz3: false }; // NEW: 追蹤三個題庫的通關狀態
        // 'favoriteKeywords' is now a global, Firestore-synced variable
        
        // --- UI ELEMENTS ---
        const screens = document.querySelectorAll('.screen');
        const testTitle = document.getElementById('test-title');
        const progressBar = document.getElementById('progress-bar');
        const questionText = document.getElementById('question-text');
        const audioPlayerContainer = document.getElementById('audio-player');
        const optionsContainer = document.getElementById('options-container');
        const nextButton = document.getElementById('next-button');
        const timerDisplay = document.getElementById('timer');
        const questionCounter = document.getElementById('question-counter');
        const difficultyActions = document.getElementById('difficulty-actions');
        const postAnswerActions = document.getElementById('post-answer-actions');
        const postAnswerDisplay = document.getElementById('post-answer-display');
        const keywordsDisplay = document.getElementById('keywords-display');
        const favoritesModal = document.getElementById('favorites-modal');
        const favoritesCard = document.getElementById('favorites-card');
        const favoritesList = document.getElementById('favorites-list');
        // NEW: Exit Modal UI Elements
        const exitConfirmModal = document.getElementById('exit-confirm-modal');
        const exitConfirmCard = document.getElementById('exit-confirm-card');

        // --- SOUND EFFECTS ---
        let soundsReady = false;
        const synth = new Tone.Synth().toDestination();

        function playSound(type) {
            if (!soundsReady) return;
            try {
                if (type === 'correct') synth.triggerAttackRelease("C5", "8n", Tone.now());
                else if (type === 'incorrect') synth.triggerAttackRelease("A3", "8n", Tone.now());
                else if (type === 'success') {
                    synth.triggerAttackRelease("C4", "8n", Tone.now());
                    synth.triggerAttackRelease("E4", "8n", Tone.now() + 0.1);
                    synth.triggerAttackRelease("G4", "8n", Tone.now() + 0.2);
                } 
            } catch(e) {
                console.error("Sound play failed:", e);
            }
        }
        
        document.body.addEventListener('click', async () => {
            if (Tone.context.state !== 'running') {
                await Tone.start();
                console.log("Audio context started.");
            }
            soundsReady = true;
        }, { once: true });


        // --- CORE LOGIC ---
        function showScreen(screenId) {
            screens.forEach(s => s.style.display = 'none');
            const activeScreen = document.getElementById(screenId);
            activeScreen.style.display = 'flex';
            activeScreen.classList.add('active-screen');
        }

        function resetState() {
            currentQuestionIndex = 0;
            score = 0; 
            clearInterval(timerInterval);
            learnedKeywords = [];
            isTestPaused = false;
            currentTimerValue = 0;
            // Favorites are NOT reset
        }
        
        // NEW: startQuiz function
        function startQuiz(quizId) {
            if (!isAuthReady) {
                console.error("Authentication not ready. Please wait.");
                return;
            }
            resetState();
            currentTest = quizId;
            
            if (!alcptQuizBanks[quizId]) {
                console.error("Invalid quiz ID:", quizId);
                return;
            }
            
            // 複製並隨機排序題庫
            let bank = [...alcptQuizBanks[quizId]];
            for (let i = bank.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [bank[i], bank[j]] = [bank[j], bank[i]];
            }

            // NEW: 題庫一(30題)和題庫二/三(20題)
            currentQuestions = bank;
            
            let quizName = "";
            if (quizId === 'quiz1') quizName = '題庫 (一)：詞彙';
            else if (quizId === 'quiz2') quizName = '題庫 (二)：文法';
            else if (quizId === 'quiz3') quizName = '題庫 (三)：模擬聽力';
            
            testTitle.textContent = `ALCPT 練習: ${quizName}`;
            
            loadQuestion();
            startTimer(currentQuestions.length * 45); // 每題 45 秒
            showScreen('test-screen');
        }

        // 'startPracticeVersion' and 'startTest' functions are removed

        function loadQuestion() {
            nextButton.disabled = true;
            optionsContainer.innerHTML = '';
            audioPlayerContainer.innerHTML = ''; 
            difficultyActions.innerHTML = ''; // Difficulty change is removed
            postAnswerActions.innerHTML = '';
            postAnswerDisplay.innerHTML = '';
            keywordsDisplay.innerHTML = ''; 

            const q = currentQuestions[currentQuestionIndex];
            const progress = ((currentQuestionIndex) / currentQuestions.length) * 100;
            progressBar.style.width = `${progress}%`;
            questionCounter.textContent = `第 ${currentQuestionIndex + 1} / ${currentQuestions.length} 題`;

            // NEW: Handle listening script formatting
            if (q.type === 'listening') {
                questionText.innerHTML = q.question.replace(/\n/g, '<br>');
                audioPlayerContainer.innerHTML = `
                    <div class="flex items-center space-x-2 p-3 bg-gray-700 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072M20 4a9 9 0 010 16M4 4a9 9 0 0116 0" /></svg>
                        <span class="text-gray-300 italic">模擬聽力題 (請閱讀腳本)</span>
                    </div>
                `;
            } else {
                questionText.textContent = q.question;
                audioPlayerContainer.innerHTML = ''; // Clear for reading questions
            }
            
            q.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'w-full p-4 text-left bg-gray-700 hover:bg-gray-600 rounded-lg transition duration-200 border-2 border-gray-600';
                button.onclick = () => selectAnswer(index);
                optionsContainer.appendChild(button);
            });
        }
        
        function selectAnswer(selectedIndex) {
            difficultyActions.innerHTML = '';
            const q = currentQuestions[currentQuestionIndex];
            const isCorrect = selectedIndex === q.answer;
            
            if (isCorrect) {
                score++; 
            }
            playSound(isCorrect ? 'correct' : 'incorrect');

            const optionButtons = optionsContainer.querySelectorAll('button');
            optionButtons.forEach((btn, index) => {
                btn.disabled = true;
                if (index === q.answer) btn.classList.add('correct-answer');
                else if (index === selectedIndex) btn.classList.add('incorrect-answer');
            });

            postAnswerActions.innerHTML = '';
            postAnswerDisplay.innerHTML = ''; 
            keywordsDisplay.innerHTML = ''; 

            const correctOptionText = q.options[q.answer];
            
            // 處理聽力題的 ____ 替換 (如果有的話)
            let filledQuestion, filledTranslation;
            if (q.question.includes('____')) {
                 filledQuestion = q.question.replace(/____/g, `<span class='font-bold text-yellow-300'>${correctOptionText}</span>`);
                 filledTranslation = q.translation.replace(/____/g, `<span class='font-bold text-cyan-300'>${correctOptionText}</span>`);
            } else {
                // 聽力題沒有 ____，直接顯示
                filledQuestion = q.question.replace(/\n/g, '<br>');
                filledTranslation = q.translation.replace(/\n/g, '<br>');
            }

            postAnswerDisplay.innerHTML = `
                <div class="p-4 bg-gray-900 rounded-lg border border-gray-700">
                    <p class="font-bold text-yellow-400">題目原文 (含正解)：</p>
                    <p class="text-gray-300 mb-2">${filledQuestion}</p>
                    <button onclick="this.nextElementSibling.style.display='block'; this.style.display='none';" class="mt-2 text-sm text-cyan-400 hover:text-cyan-300 font-semibold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="inline h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C3.732 4.943 9.522 3 10 3s6.268 1.943 9.542 7c-3.274 5.057-9.064 7-9.542 7S3.732 15.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                        顯示中文翻譯
                    </button>
                    <p style="display:none;" class="mt-1 text-gray-400">${filledTranslation}</p>
                </div>
            `;

            if (q.keywords && q.keywords.length > 0) {
                q.keywords.forEach(kw => learnedKeywords.push(kw));
                const keywordsButton = document.createElement('button');
                keywordsButton.textContent = '關鍵單字';
                keywordsButton.className = 'bg-teal-600 hover:bg-teal-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300';

                keywordsButton.onclick = () => {
                    let keywordsHTML = '<div class="space-y-3">';
                    q.keywords.forEach(kw => {
                        const escapedWord = kw.word.replace(/'/g, "\\'");
                        const escapedExample = kw.example.replace(/'/g, "\\'");
                        
                        // 即時從 Firestore 同步的 favoriteKeywords 陣列中檢查
                        const isFavorited = favoriteKeywords.some(favKw => favKw.word === kw.word);
                        
                        const favIconHTML = isFavorited
                            ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg>`
                            : `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 hover:text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.5l1.318-1.182a4.5 4.5 0 116.364 6.364L12 20.06l-7.682-7.378a4.5 4.5 0 010-6.364z" /></svg>`;
                        const kwString = JSON.stringify(kw).replace(/'/g, "\\'");

                        // FIX: Use sanitized word for the button ID as well, just in case, although it's not the source of the error.
                        const buttonId = kw.word.replace(/[\/]/g, '_');

                        keywordsHTML += `
                            <div class="p-4 bg-gray-900 rounded-lg border border-gray-700">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="flex items-center space-x-2">
                                            <p class="text-lg font-bold text-teal-300">${kw.word}</p>
                                            <button onclick="speak('${escapedWord}')" class="text-gray-400 p-1 rounded-full hover:bg-gray-700 hover:text-white transition-colors">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>
                                            </button>
                                        </div>
                                        <p class="text-gray-400">${kw.translation}</p>
                                    </div>
                                    <button id="fav-btn-${buttonId}" onclick='toggleFavoriteKeyword(${kwString}, this)' class="p-1 rounded-full transition-colors duration-200">
                                        ${favIconHTML}
                                    </button>
                                </div>
                                <div class="mt-2 flex items-center space-x-2">
                                    <p class="text-sm text-gray-500 italic flex-grow">用法: ${kw.example}</p>
                                    <button onclick="speak('${escapedExample}')" class="text-gray-400 p-1 rounded-full hover:bg-gray-700 hover:text-white transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>
                                    </button>
                                </div>
                                <p class="text-sm text-gray-400 italic">翻譯: ${kw.example_translation}</p>
                            </div>
                        `;
                    });
                    keywordsHTML += '</div>';
                    keywordsDisplay.innerHTML = keywordsHTML; 
                };
                postAnswerActions.appendChild(keywordsButton);
            }

            nextButton.disabled = false;
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < currentQuestions.length) loadQuestion();
            else endTest();
        }

        // Simplified calculateScores function
        function calculateScores(questions, currentScore) {
            const totalCorrect = currentScore;
            const totalQuestions = questions.length;
            const totalAccuracy = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;
            
            return {
                totalAccuracy,
                totalCorrect,
                totalQuestions
            };
        }

        function endTest() {
            clearInterval(timerInterval);
            progressBar.style.width = '100%';
            
            const results = calculateScores(currentQuestions, score);
            showPracticeComplete(results); // Changed to new function name
        }
        
        // NEW: Updated function to show pass/fail based on 80%
        function showPracticeComplete(results) {
            const titleEl = document.getElementById('module-complete-title');
            const messageEl = document.getElementById('module-complete-message');
            
            const isPassed = results.totalAccuracy >= 80;

            // NEW: 更新全域通關狀態
            if (isPassed) {
                quizPassStatus[currentTest] = true;
                console.log("Updated pass status:", quizPassStatus);
            }

            // NEW: 檢查是否所有題庫都已通關
            const allPassed = quizPassStatus.quiz1 && quizPassStatus.quiz2 && quizPassStatus.quiz3;
            
            titleEl.textContent = isPassed ? "測驗通過！(Passed!)" : "測驗未通過 (Failed)";
            titleEl.classList.remove('text-green-400', 'text-red-400'); // Clear previous colors
            titleEl.classList.add(isPassed ? 'text-green-400' : 'text-red-400');
            
            messageEl.innerHTML = `你的分數是 ${results.totalAccuracy}%. (${results.totalCorrect} / ${results.totalQuestions} 題)`;
            
            if (isPassed) {
                messageEl.innerHTML += '<br>恭喜！你已達到 80% 的通過標準。';
                playSound('success'); // Play success sound

                // NEW: 如果全部通關，顯示最終的恭喜訊息
                if (allPassed) {
                    messageEl.innerHTML += '<br><br><span class="text-lg font-bold text-yellow-300">恭喜你通過本日所有練習！<br>不要忘記到「我的最愛」區加強複習喔！</span>';
                }

            } else {
                messageEl.innerHTML += '<br>很遺憾，你需要達到 80% (或更高) 才能通過。<br>請再測驗一次 加強練習！';
                playSound('incorrect'); // Play fail sound (using 'incorrect' sound)
            }
            
            document.getElementById('module-score').textContent = `${results.totalCorrect} / ${results.totalQuestions} (${results.totalAccuracy}%)`;
            showScreen('practice-complete-screen');
        }

        /* 'restartMission' is now defined in the Firebase init block */

        function backToWelcome() {
            // NEW: 根據通關狀態更新按鈕樣式
            const quiz1Button = document.querySelector('button[onclick="startQuiz(\'quiz1\')"]');
            const quiz2Button = document.querySelector('button[onclick="startQuiz(\'quiz2\')"]');
            const quiz3Button = document.querySelector('button[onclick="startQuiz(\'quiz3\')"]');

            // 1. 重置所有按鈕樣式
            quiz1Button.classList.remove('bg-green-600', 'hover:bg-green-700', 'text-white');
            quiz1Button.classList.add('bg-yellow-500', 'hover:bg-yellow-600', 'text-gray-900');
            quiz1Button.textContent = '題庫 (一)：詞彙練習 (30題)';
            
            quiz2Button.classList.remove('bg-green-600', 'hover:bg-green-700', 'text-white');
            quiz2Button.classList.add('bg-cyan-500', 'hover:bg-cyan-600', 'text-gray-900');
            quiz2Button.textContent = '題庫 (二)：文法結構';

            quiz3Button.classList.remove('bg-green-600', 'hover:bg-green-700', 'text-white');
            quiz3Button.classList.add('bg-teal-500', 'hover:bg-teal-600', 'text-gray-900');
            quiz3Button.textContent = '題庫 (三)：模擬聽力';

            // 2. 應用已通關的樣式
            if (quizPassStatus.quiz1) {
                quiz1Button.classList.remove('bg-yellow-500', 'hover:bg-yellow-600', 'text-gray-900');
                quiz1Button.classList.add('bg-green-600', 'hover:bg-green-700', 'text-white');
                quiz1Button.textContent = '題庫 (一)：詞彙練習 (30題) (已通過)';
            }
            if (quizPassStatus.quiz2) {
                quiz2Button.classList.remove('bg-cyan-500', 'hover:bg-cyan-600', 'text-gray-900');
                quiz2Button.classList.add('bg-green-600', 'hover:bg-green-700', 'text-white');
                quiz2Button.textContent = '題庫 (二)：文法結構 (已通過)';
            }
            if (quizPassStatus.quiz3) {
                quiz3Button.classList.remove('bg-teal-500', 'hover:bg-teal-600', 'text-gray-900');
                quiz3Button.classList.add('bg-green-600', 'hover:bg-green-700', 'text-white');
                quiz3Button.textContent = '題庫 (三)：模擬聽力 (已通過)';
            }

            showScreen('welcome-screen');
        }

        function speak(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 0.9;
            window.speechSynthesis.speak(utterance);
        }

        // --- NEW Timer Functions with Pause/Resume ---
        function startTimer(duration) {
            currentTimerValue = duration;
            updateTimerDisplay(); // Set initial display
            clearInterval(timerInterval); // Clear any existing
            timerInterval = setInterval(runTimerTick, 1000);
        }

        function runTimerTick() {
            if (isTestPaused) return; // Don't tick if paused
            
            currentTimerValue--;
            updateTimerDisplay();
            
            if (currentTimerValue < 0) {
                clearInterval(timerInterval);
                timerDisplay.textContent = '0:00';
                endTest();
            }
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(Math.max(0, currentTimerValue) / 60);
            let seconds = Math.max(0, currentTimerValue) % 60;
            seconds = seconds < 10 ? '0' + seconds : seconds;
            timerDisplay.textContent = `${minutes}:${seconds}`;
        }

        function pauseTest() {
            isTestPaused = true;
            // We don't need to clear interval here, runTimerTick will just return
            showFavoritesModal();
        }

        // --- END NEW Timer Functions ---

        // --- NEW: Functions for Exit Confirmation ---
        function requestExitConfirmation() {
            isTestPaused = true; // Pause the timer
            exitConfirmModal.style.display = 'flex';
            setTimeout(() => exitConfirmCard.classList.add('active'), 10);
        }

        function cancelExit() {
            exitConfirmCard.classList.remove('active');
            setTimeout(() => exitConfirmModal.style.display = 'none', 500);
            isTestPaused = false; // Resume the timer
        }

        function confirmExit() {
            exitConfirmCard.classList.remove('active');
            setTimeout(() => exitConfirmModal.style.display = 'none', 500);
            isTestPaused = false; // Reset pause state
            clearInterval(timerInterval); // Stop the timer completely
            backToWelcome(); // Go back to the main menu
        }
        // --- END NEW Exit Confirmation Functions ---


        /* 'toggleFavoriteKeyword' is now defined in the Firebase init block */
        
        // --- NEW: Functions for Favorites Modal ---
        function showFavoritesModal() {
            favoritesList.innerHTML = ''; 
            
            // 讀取
            const uniqueFavorites = Array.from(new Map(favoriteKeywords.map(kw => [kw.word, kw])).values());
            
            if (uniqueFavorites.length === 0) {
                favoritesList.innerHTML = '<p class="text-gray-400 text-center">您尚未收藏任何單字。</p>';
            } else {
                uniqueFavorites.forEach(kw => {
                    const escapedWord = kw.word.replace(/'/g, "\\'");
                    const escapedExample = kw.example.replace(/'/g, "\\'");
                    
                    const favItem = document.createElement('div');
                    favItem.className = 'p-4 bg-gray-900 rounded-lg border border-gray-700';
                    favItem.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="flex items-center space-x-2">
                                    <p class="text-lg font-bold text-teal-300">${kw.word}</p>
                                    <button onclick="speak('${escapedWord}')" class="text-gray-400 p-1 rounded-full hover:bg-gray-700 hover:text-white transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>
                                    </button>
                                </div>
                                <p class="text-gray-400">${kw.translation}</p>
                            </div>
                            <button onclick='toggleFavoriteKeyword(${JSON.stringify(kw).replace(/'/g, "\\'")}, this)' class="p-1 rounded-full transition-colors duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                        <div class="mt-2 flex items-center space-x-2">
                             <p class="text-sm text-gray-500 italic flex-grow">用法: ${kw.example}</p>
                             <button onclick="speak('${escapedExample}')" class="text-gray-400 p-1 rounded-full hover:bg-gray-700 hover:text-white transition-colors">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>
                             </button>
                        </div>
                        <p class="text-sm text-gray-400 italic">翻譯: ${kw.example_translation}</p>
                    `;
                    favoritesList.appendChild(favItem);
                });
            }
            
            favoritesModal.style.display = 'flex';
            setTimeout(() => favoritesCard.classList.add('active'), 10);
        }

        function hideFavoritesModal() {
            favoritesCard.classList.remove('active');
            setTimeout(() => favoritesModal.style.display = 'none', 500);
            
            // NEW: Resume test if it was paused
            if (isTestPaused) {
                isTestPaused = false;
                // Timer is already running (it just skips ticks), no need to restart
            }
            
            // (onSnapshot will handle refreshing the keyword list if needed)
        }
        
        // --- 將函式暴露到 window，以便 HTML onclick 可以呼叫 ---
        // (必須在函式被定義 *之後* 才暴露)
        window.startQuiz = startQuiz; // NEW
        // window.startPracticeVersion = startPracticeVersion; // REMOVED
        window.showFavoritesModal = showFavoritesModal;
        window.hideFavoritesModal = hideFavoritesModal;
        window.pauseTest = pauseTest;
        window.nextQuestion = nextQuestion;
        window.backToWelcome = backToWelcome;
        window.restartMission = restartMission;
        window.speak = speak;
        window.toggleFavoriteKeyword = toggleFavoriteKeyword;
        // NEW: Expose exit functions
        window.requestExitConfirmation = requestExitConfirmation;
        window.cancelExit = cancelExit;
        window.confirmExit = confirmExit;


        // 啟動 Firebase
        window.onload = initializeAppFirebase;

    </script>
</body>
</html>
