<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECL è‹±èªèƒ½åŠ›æ¨¡æ“¬æ¸¬é©—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .screen {
            display: none;
        }
        .active-screen {
            display: flex;
        }
        .progress-bar-inner {
            transition: width 0.5s ease-in-out;
        }
        .correct-answer {
            background-color: #10B981 !important; /* Green-500 */
            border-color: #059669 !important;
        }
        .incorrect-answer {
            background-color: #EF4444 !important; /* Red-500 */
            border-color: #DC2626 !important;
        }
        .selected-answer {
             background-color: #3B82F6; /* Blue-500 */
             border-color: #2563EB;
        }
        #favorites-card, #exit-confirm-card {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        #favorites-card.active, #exit-confirm-card.active {
            transform: scale(1);
            opacity: 1;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #FCD34D;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* ç™¼éŸ³æŒ‰éˆ•å¼·åŒ– */
        .speaker-btn {
            background-color: #3B82F6;
            color: white;
            border-radius: 50%;
            padding: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }
        .speaker-btn:hover {
            background-color: #2563EB;
            transform: scale(1.1);
        }
        .speaker-btn svg {
            width: 18px;
            height: 18px;
        }
        /* äº’å‹•å¼å–®å­— */
        .clickable-word {
            cursor: pointer;
            padding: 0 2px;
            border-radius: 4px;
            transition: all 0.2s;
            display: inline-block;
        }
        .clickable-word:hover {
            background-color: rgba(59, 130, 246, 0.3);
            text-decoration: underline;
            color: #60A5FA;
        }
        .word-highlight {
            background-color: #F59E0B !important;
            color: #000 !important;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-2 sm:p-4">

    <div class="w-full max-w-3xl mx-auto">

        <!-- Screen 0: Loading -->
        <div id="loading-screen" class="screen active-screen flex-col items-center text-center p-6 sm:p-8 bg-gray-800 rounded-2xl shadow-2xl">
            <h1 class="text-3xl sm:text-4xl font-bold text-yellow-400 mb-6">ECL æ¨¡æ“¬æ¸¬é©—ç³»çµ±</h1>
            <div class="spinner mb-4"></div>
            <p id="loading-text" class="text-base sm:text-lg text-gray-300">æ­£åœ¨åŒæ­¥é›²ç«¯é€²åº¦...</p>
        </div>

        <!-- Screen 1: Welcome -->
        <div id="welcome-screen" class="screen flex-col items-center text-center p-6 sm:p-8 bg-gray-800 rounded-2xl shadow-2xl">
            <h1 class="text-3xl sm:text-4xl font-bold text-yellow-400 mb-4">ECL è‹±èªèƒ½åŠ›æ¸¬é©—</h1>
            <p class="text-base sm:text-lg text-gray-300 mb-8 leading-relaxed">
                è«‹é¸æ“‡æ¸¬é©—é¡Œåº«ã€‚é€šéæ¨™æº–ç‚º <span class="text-yellow-400 font-bold text-xl">80%</span>ã€‚<br>
                <span class="text-blue-300">ğŸ’¡ æç¤ºï¼šæ¸¬é©—æ™‚å¯é»é¸é¡Œç›®ä¸­çš„å–®å­—æŸ¥çœ‹ç¿»è­¯èˆ‡è½ç™¼éŸ³ã€‚</span>
            </p>
            
            <div class="space-y-4 w-full max-w-sm">
                <button id="btn-quiz1" onclick="startQuiz('quiz1')" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-lg text-lg transition duration-300 transform hover:scale-105">
                    é¡Œåº« (ä¸€)ï¼šè©å½™èˆ‡ç‰‡èª (30é¡Œ)
                </button>
                <button id="btn-quiz2" onclick="startQuiz('quiz2')" class="w-full bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-3 px-6 rounded-lg text-lg transition duration-300 transform hover:scale-105">
                    é¡Œåº« (äºŒ)ï¼šæ–‡æ³•çµæ§‹ (20é¡Œ)
                </button>
                <button id="btn-quiz3" onclick="startQuiz('quiz3')" class="w-full bg-teal-500 hover:bg-teal-600 text-gray-900 font-bold py-3 px-6 rounded-lg text-lg transition duration-300 transform hover:scale-105">
                    é¡Œåº« (ä¸‰)ï¼šè½åŠ›æ¸¬é©—è…³æœ¬ (20é¡Œ)
                </button>
            </div>
            
            <hr class="border-gray-600 my-6 w-full max-w-sm">
            
            <div class="space-y-4 w-full max-w-sm">
                <button onclick="showFavoritesModal()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300">
                    æŸ¥çœ‹æˆ‘çš„æœ€æ„›å–®å­—ç°¿
                </button>
            </div>
        </div>

        <!-- Screen 2: Test -->
        <div id="test-screen" class="screen flex-col w-full">
            <div class="bg-gray-800 rounded-2xl shadow-2xl p-4 sm:p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="test-title" class="text-xl sm:text-2xl font-bold text-yellow-400"></h2>
                    <div class="flex items-center space-x-2 sm:space-x-4">
                        <div id="question-counter" class="text-sm sm:text-lg text-gray-400 font-mono"></div>
                        <button onclick="pauseTest()" class="text-purple-300 hover:text-purple-200 flex items-center space-x-1 p-2 bg-gray-700 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg>
                            <span class="text-sm sm:text-lg font-mono">æ”¶è—</span>
                        </button>
                        <div id="timer" class="text-base sm:text-xl font-mono bg-gray-700 px-3 sm:px-4 py-2 rounded-lg">--:--</div>
                    </div>
                </div>
                
                <div class="w-full bg-gray-700 rounded-full h-4 mb-6">
                    <div id="progress-bar" class="bg-green-500 h-4 rounded-full progress-bar-inner" style="width: 0%"></div>
                </div>

                <div id="question-container" class="text-left">
                    <!-- Tooltip for interactive word translation -->
                    <div id="word-tooltip" class="hidden mb-4 p-3 bg-blue-900 border-l-4 border-blue-400 rounded shadow-lg text-sm text-blue-100 flex justify-between items-center animate-pulse">
                        <span id="tooltip-content"></span>
                        <button onclick="document.getElementById('word-tooltip').classList.add('hidden')" class="text-blue-300 hover:text-white ml-2 font-bold">&times;</button>
                    </div>

                    <div id="question-text" class="text-lg sm:text-xl mb-6 text-gray-200 min-h-[60px] leading-relaxed"></div>
                    <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    <div id="post-answer-actions" class="mt-6 flex flex-wrap gap-2"></div>
                    <div id="post-answer-display" class="mt-4"></div>
                    <div id="keywords-display" class="mt-4"></div>
                </div>
                
                <div class="mt-8 flex justify-between items-center">
                    <button onclick="requestExitConfirmation()" class="bg-gray-700 hover:bg-gray-600 text-gray-300 font-bold py-2 px-6 rounded-lg transition duration-300">
                        &larr; æ”¾æ£„æ¸¬é©—
                    </button>
                    <button id="next-button" onclick="nextQuestion()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-10 rounded-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        ä¸‹ä¸€é¡Œ
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Screen 3: Practice Complete -->
        <div id="practice-complete-screen" class="screen flex-col items-center text-center p-6 sm:p-8 bg-gray-800 rounded-2xl shadow-2xl">
            <h2 id="module-complete-title" class="text-2xl sm:text-3xl font-bold text-green-400 mb-4">æ¸¬é©—å®Œæˆï¼</h2>
            <p id="module-complete-message" class="text-base sm:text-lg text-gray-300 mb-6"></p>
            <div class="text-lg sm:text-xl mb-8 p-4 bg-gray-700 rounded-lg">æœ¬æ¬¡å¾—åˆ† / Score: <span id="module-score" class="text-xl sm:text-2xl font-bold text-yellow-400"></span></div>
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                <button onclick="backToWelcome()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                    å›é¡Œåº«é¸å–®
                </button>
                <button onclick="restartMission()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                    é‡ç½®é€²åº¦èˆ‡æˆ‘çš„æœ€æ„›
                </button>
            </div>
        </div>

    </div>
    
    <!-- Favorites Modal -->
    <div id="favorites-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4" style="display: none; z-index: 998;">
        <div class="bg-gray-800 border-2 border-purple-400 rounded-2xl shadow-2xl p-6 sm:p-8 text-left transform transition-all scale-95 opacity-0 w-full max-w-2xl" id="favorites-card">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-purple-300">æˆ‘çš„æœ€æ„›å–®å­—ç°¿</h3>
                <button onclick="hideFavoritesModal()" class="text-gray-300 hover:text-white text-3xl font-bold">&times;</button>
            </div>
            <div id="favorites-list" class="max-h-[60vh] overflow-y-auto space-y-3 p-1"></div>
        </div>
    </div>

    <!-- Exit Confirmation Modal -->
    <div id="exit-confirm-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4" style="display: none; z-index: 999;">
        <div class="bg-gray-800 border-2 border-red-500 rounded-2xl shadow-2xl p-6 sm:p-8 text-center transform transition-all scale-95 opacity-0 w-full max-w-md" id="exit-confirm-card">
            <h3 class="text-2xl font-bold text-red-400 mb-4">ç¢ºå®šè¦æ”¾æ£„å—ï¼Ÿ</h3>
            <p class="text-lg text-gray-300 mb-6">
                ç›®å‰çš„æ¸¬é©—é€²åº¦å°‡ä¸æœƒè¢«å„²å­˜ã€‚<br>
                <span class="text-yellow-400 mt-2 block font-bold">å†å …æŒä¸€ä¸‹ï¼Œæ‚¨ä¸€å®šå¯ä»¥é€šéçš„ï¼</span>
            </p>
            <div class="flex flex-col space-y-3">
                <button onclick="cancelExit()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                    ç¹¼çºŒæŒ‘æˆ° (ä¸æ”¾æ£„)
                </button>
                <button onclick="confirmExit()" class="bg-gray-600 hover:bg-gray-500 text-gray-300 font-bold py-2 px-6 rounded-lg transition duration-300">
                    æ”¾æ£„æœ¬æ¬¡æ¸¬é©—ä¸¦è¿”å›
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, collection, onSnapshot, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- å…¨åŸŸè®Šæ•¸ ---
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let favoriteKeywords = [];
        let currentTest = '';
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let timerInterval;
        let currentTimerValue = 0;
        let isTestPaused = false;
        let quizPassStatus = { quiz1: false, quiz2: false, quiz3: false };
        let firestoreUnsubscribe = null;

        // é¡Œåº«è³‡æ–™ (éš¨æ©Ÿåˆ†ä½ˆæ­£ç¢ºç­”æ¡ˆ A, B, C, D)
        const alcptQuizBanks = {
            'quiz1': [
                { type: 'reading', question: "The officer wants to ____ the security procedures.", translation: "è»å®˜æƒ³è¦____å®‰å…¨ç¨‹åºã€‚", options: ["review", "remove", "reverse", "receive"], answer: 0, all_keywords: [
                    { word: 'review', translation: 'è¤‡æŸ¥ï¼›å¯©æŸ¥', example: 'We must review the plan.', example_translation: 'æˆ‘å€‘å¿…é ˆå¯©æŸ¥é€™é …è¨ˆç•«ã€‚' },
                    { word: 'remove', translation: 'ç§»é™¤', example: 'Remove the battery.', example_translation: 'ç§»é™¤é›»æ± ã€‚' },
                    { word: 'reverse', translation: 'åè½‰ï¼›å€’è»Š', example: 'Reverse the car.', example_translation: 'å°‡è»Šå€’é€€ã€‚' },
                    { word: 'receive', translation: 'æ¥æ”¶', example: 'I received the signal.', example_translation: 'æˆ‘æ”¶åˆ°äº†è¨Šè™Ÿã€‚' }
                ]},
                { type: 'reading', question: "He has a very ____ schedule this week.", translation: "ä»–é€™é€±çš„è¡Œç¨‹éå¸¸____ã€‚", options: ["thick", "tight", "thin", "tidy"], answer: 1, all_keywords: [
                    { word: 'thick', translation: 'åšçš„', example: 'a thick book.', example_translation: 'ä¸€æœ¬åšæ›¸ã€‚' },
                    { word: 'tight', translation: 'ç·Šæ¹Šçš„ï¼›ç·Šçš„', example: 'I have a tight schedule.', example_translation: 'æˆ‘çš„è¡Œç¨‹å¾ˆç·Šæ¹Šã€‚' },
                    { word: 'thin', translation: 'è–„çš„ï¼›ç˜¦çš„', example: 'a thin layer.', example_translation: 'è–„è–„çš„ä¸€å±¤ã€‚' },
                    { word: 'tidy', translation: 'æ•´æ½”çš„', example: 'Keep your room tidy.', example_translation: 'ä¿æŒæˆ¿é–“æ•´æ½”ã€‚' }
                ]},
                { type: 'reading', question: "The mechanic said the engine is beyond ____.", translation: "æŠ€å·¥èªªé€™å¼•æ“å·²ç¶“ç„¡æ³•____äº†ã€‚", options: ["report", "repeat", "repair", "reply"], answer: 2, all_keywords: [
                    { word: 'report', translation: 'å ±å‘Š', example: 'Report to your post.', example_translation: 'å›åˆ°ä½ çš„å´—ä½å ±åˆ°ã€‚' },
                    { word: 'repeat', translation: 'é‡è¤‡', example: 'Repeat the instruction.', example_translation: 'é‡è¤‡æŒ‡ä»¤ã€‚' },
                    { word: 'repair', translation: 'ä¿®ç†', example: 'It is beyond repair.', example_translation: 'å®ƒå·²ç„¡æ³•ä¿®ç†ã€‚' },
                    { word: 'reply', translation: 'å›è¦†', example: 'Reply to the message.', example_translation: 'å›è¦†è¨Šæ¯ã€‚' }
                ]},
                { type: 'reading', question: "We need to ____ the problem immediately.", translation: "æˆ‘å€‘éœ€è¦ç«‹å³____é€™å€‹å•é¡Œã€‚", options: ["adjust", "advise", "advance", "address"], answer: 3, all_keywords: [
                    { word: 'adjust', translation: 'èª¿æ•´', example: 'Adjust your seat.', example_translation: 'èª¿æ•´ä½ çš„åº§ä½ã€‚' },
                    { word: 'advise', translation: 'å»ºè­°', example: 'I advise you to wait.', example_translation: 'æˆ‘å»ºè­°ä½ ç­‰å¾…ã€‚' },
                    { word: 'advance', translation: 'å‰é€²ï¼›æå‰', example: 'They advanced slowly.', example_translation: 'ä»–å€‘ç·©æ…¢å‰é€²ã€‚' },
                    { word: 'address', translation: 'è™•ç†(å•é¡Œ)ï¼›åœ°å€', example: 'Address the issue now.', example_translation: 'ç¾åœ¨è™•ç†é€™é …è­°é¡Œã€‚' }
                ]},
                { type: 'reading', question: "The commander will ____ the soldier's complaint.", translation: "æŒ‡æ®å®˜å°‡æœƒ____é€™åå£«å…µçš„æŠ•è¨´ã€‚", options: ["look into", "look over", "look up to", "look down on"], answer: 0, all_keywords: [
                    { word: 'look into', translation: 'èª¿æŸ¥ (ç‰‡èª)', example: 'The police are looking into the case.', example_translation: 'è­¦æ–¹æ­£åœ¨èª¿æŸ¥é€™èµ·æ¡ˆä»¶ã€‚' },
                    { word: 'look over', translation: 'å¿«é€Ÿç€è¦½', example: 'Look over the report.', example_translation: 'ç€è¦½é€™ä»½å ±å‘Šã€‚' },
                    { word: 'look up to', translation: 'å°Šæ•¬', example: 'I look up to my father.', example_translation: 'æˆ‘å°Šæ•¬æˆ‘çš„çˆ¶è¦ªã€‚' },
                    { word: 'look down on', translation: 'è¼•è¦–', example: 'Don\'t look down on others.', example_translation: 'ä¸è¦è¼•è¦–ä»–äººã€‚' }
                ]},
                { type: 'reading', question: "They had to ____ the exercise due to the storm.", translation: "ç”±æ–¼æš´é¢¨é›¨ï¼Œä»–å€‘ä¸å¾—ä¸____æ¼”ç¿’ã€‚", options: ["call on", "call off", "call for", "call out"], answer: 1, all_keywords: [
                    { word: 'call on', translation: 'æ‹œè¨ªï¼›å‘¼ç±²', example: 'He called on me yesterday.', example_translation: 'ä»–æ˜¨å¤©æ‹œè¨ªäº†æˆ‘ã€‚' },
                    { word: 'call off', translation: 'å–æ¶ˆ (ç‰‡èª)', example: 'The game was called off.', example_translation: 'æ¯”è³½è¢«å–æ¶ˆäº†ã€‚' },
                    { word: 'call for', translation: 'è¦æ±‚ï¼›éœ€è¦', example: 'This situation calls for action.', example_translation: 'é€™ç¨®æƒ…æ³éœ€è¦æ¡å–è¡Œå‹•ã€‚' },
                    { word: 'call out', translation: 'å¤§å–Šï¼›å¬é›†', example: 'He called out my name.', example_translation: 'ä»–å¤§å–Šæˆ‘çš„åå­—ã€‚' }
                ]},
                { type: 'reading', question: "I cannot ____ this noise any longer.", translation: "æˆ‘å†ä¹Ÿç„¡æ³•____é€™ç¨®å™ªéŸ³äº†ã€‚", options: ["put on", "put off", "put up with", "put out"], answer: 2, all_keywords: [
                    { word: 'put on', translation: 'ç©¿ä¸Šï¼›å¢åŠ ', example: 'Put on your coat.', example_translation: 'ç©¿ä¸Šä½ çš„å¤–å¥—ã€‚' },
                    { word: 'put off', translation: 'å»¶æœŸ', example: 'Don\'t put off your study.', example_translation: 'ä¸è¦å»¶é²ä½ çš„å­¸ç¿’ã€‚' },
                    { word: 'put up with', translation: 'å¿å— (ç‰‡èª)', example: 'I can\'t put up with it.', example_translation: 'æˆ‘ç„¡æ³•å¿å—é€™ä»¶äº‹ã€‚' },
                    { word: 'put out', translation: 'ç†„æ»…', example: 'Put out the fire.', example_translation: 'ç†„æ»…ç«ã€‚' }
                ]},
                { type: 'reading', question: "The patrol is in danger of ____ ammunition.", translation: "å·¡é‚éšŠæœ‰____å½ˆè—¥çš„å±éšªã€‚", options: ["running into", "running over", "running away", "running out of"], answer: 3, all_keywords: [
                    { word: 'running into', translation: 'å¶ç„¶é‡è¦‹', example: 'I ran into Tom today.', example_translation: 'æˆ‘ä»Šå¤©å·§é‡æ¹¯å§†ã€‚' },
                    { word: 'running over', translation: 'è¼¾é', example: 'The car ran over a can.', example_translation: 'è»Šå­è¼¾éä¸€å€‹ç½å­ã€‚' },
                    { word: 'running away', translation: 'é€ƒè·‘', example: 'The thief ran away.', example_translation: 'å°å·è·‘èµ°äº†ã€‚' },
                    { word: 'running out of', translation: 'ç”¨å®Œ (ç‰‡èª)', example: 'We are running out of time.', example_translation: 'æˆ‘å€‘çš„æ™‚é–“å¿«ç”¨å®Œäº†ã€‚' }
                ]},
                { type: 'reading', question: "Our vehicle ____ in the middle of the desert.", translation: "æˆ‘å€‘çš„è»Šè¼›åœ¨æ²™æ¼ ä¸­å¤®____äº†ã€‚", options: ["broke down", "broke into", "broke up", "broke out"], answer: 0, all_keywords: [
                    { word: 'broke down', translation: 'æ•…éšœ (ç‰‡èª)', example: 'My car broke down.', example_translation: 'æˆ‘çš„è»Šæ‹‹éŒ¨äº†ã€‚' },
                    { word: 'broke into', translation: 'é—–å…¥', example: 'Someone broke into my house.', example_translation: 'æœ‰äººé—–å…¥æˆ‘çš„æˆ¿å­ã€‚' },
                    { word: 'broke up', translation: 'åˆ†æ‰‹ï¼›è§£æ•£', example: 'The band broke up.', example_translation: 'é‚£å€‹æ¨‚åœ˜è§£æ•£äº†ã€‚' },
                    { word: 'broke out', translation: 'çˆ†ç™¼', example: 'War broke out.', example_translation: 'æˆ°çˆ­çˆ†ç™¼äº†ã€‚' }
                ]},
                { type: 'reading', question: "The soldiers were ordered to ____ the mission at dawn.", translation: "å£«å…µå€‘è¢«å‘½ä»¤åœ¨é»æ˜æ™‚____ä»»å‹™ã€‚", options: ["carry on", "carry out", "carry off", "carry over"], answer: 1, all_keywords: [
                    { word: 'carry on', translation: 'ç¹¼çºŒ', example: 'Carry on with your work.', example_translation: 'ç¹¼çºŒä½ çš„å·¥ä½œã€‚' },
                    { word: 'carry out', translation: 'åŸ·è¡Œ (ç‰‡èª)', example: 'Carry out the order.', example_translation: 'åŸ·è¡Œå‘½ä»¤ã€‚' },
                    { word: 'carry off', translation: 'æˆåŠŸå®Œæˆ', example: 'She carried off the win.', example_translation: 'å¥¹æˆåŠŸå¥ªå† ã€‚' },
                    { word: 'carry over', translation: 'å»¶çºŒ', example: 'The meeting carried over.', example_translation: 'æœƒè­°å»¶çºŒäº†ã€‚' }
                ]},
                { type: 'reading', question: "We need to ____ the security at the front gate.", translation: "æˆ‘å€‘éœ€è¦____å‰é–€çš„å®‰å…¨ã€‚", options: ["beef up", "back down", "break in", "blow up"], answer: 0, all_keywords: [
                    { word: 'beef up', translation: 'åŠ å¼· (ç‰‡èª)', example: 'We need to beef up security.', example_translation: 'æˆ‘å€‘éœ€è¦åŠ å¼·å®‰ä¿ã€‚' },
                    { word: 'back down', translation: 'é€€è®“', example: 'He never backs down.', example_translation: 'ä»–å¾ä¸é€€è®“ã€‚' },
                    { word: 'break in', translation: 'é—–å…¥', example: 'Try to break in.', example_translation: 'è©¦åœ–é—–å…¥ã€‚' },
                    { word: 'blow up', translation: 'çˆ†ç‚¸', example: 'The bridge blew up.', example_translation: 'æ©‹çˆ†ç‚¸äº†ã€‚' }
                ]},
                { type: 'reading', question: "Please ____ the lights when you leave.", options: ["turn on", "turn off", "turn up", "turn down"], answer: 1, all_keywords: [
                    { word: 'turn on', translation: 'æ‰“é–‹', example: 'Turn on the TV.', example_translation: 'æ‰“é–‹é›»è¦–ã€‚' },
                    { word: 'turn off', translation: 'é—œæ‰ (ç‰‡èª)', example: 'Turn off the lights.', example_translation: 'é—œç‡ˆã€‚' },
                    { word: 'turn up', translation: 'èª¿é«˜éŸ³é‡', example: 'Turn it up.', example_translation: 'é–‹å¤§è²é»ã€‚' },
                    { word: 'turn down', translation: 'æ‹’çµ•ï¼›èª¿å°è²', example: 'He turned down the offer.', example_translation: 'ä»–æ‹’çµ•äº†é‚£å€‹æè­°ã€‚' }
                ]},
                { type: 'reading', question: "The mechanic will ____ the old parts.", options: ["take over", "take apart", "take back", "take off"], answer: 1, all_keywords: [
                    { word: 'take over', translation: 'æ¥ç®¡', example: 'He took over the company.', example_translation: 'ä»–æ¥ç®¡äº†å…¬å¸ã€‚' },
                    { word: 'take apart', translation: 'æ‹†é–‹ (ç‰‡èª)', example: 'He took apart the engine.', example_translation: 'ä»–æ‹†é–‹äº†å¼•æ“ã€‚' },
                    { word: 'take back', translation: 'æ‹¿å›', example: 'Take it back.', example_translation: 'æŠŠå®ƒæ‹¿å›å»ã€‚' },
                    { word: 'take off', translation: 'èµ·é£›ï¼›è„«ä¸‹', example: 'The plane took off.', example_translation: 'é£›æ©Ÿèµ·é£›äº†ã€‚' }
                ]},
                { type: 'reading', question: "I didn't mean to ____ your secret.", options: ["give in", "give up", "give away", "give back"], answer: 2, all_keywords: [
                    { word: 'give in', translation: 'è®“æ­¥', example: 'I won\'t give in.', example_translation: 'æˆ‘ä¸æœƒè®“æ­¥ã€‚' },
                    { word: 'give up', translation: 'æ”¾æ£„', example: 'Don\'t give up.', example_translation: 'åˆ¥æ”¾æ£„ã€‚' },
                    { word: 'give away', translation: 'æ´©æ¼ (ç‰‡èª)', example: 'Don\'t give away my secret.', example_translation: 'åˆ¥æ´©æ¼æˆ‘çš„ç§˜å¯†ã€‚' },
                    { word: 'give back', translation: 'æ­¸é‚„', example: 'Give back my pen.', example_translation: 'æŠŠç­†é‚„æˆ‘ã€‚' }
                ]},
                { type: 'reading', question: "We can ____ the results on the board.", options: ["get by", "get up", "check out", "check in"], answer: 2, all_keywords: [
                    { word: 'get by', translation: 'éå¾—å»', example: 'I can get by with my salary.', example_translation: 'æˆ‘çš„è–ªæ°´é‚„éå¾—å»ã€‚' },
                    { word: 'get up', translation: 'èµ·åºŠ', example: 'Get up early.', example_translation: 'æ—©é»èµ·åºŠã€‚' },
                    { word: 'check out', translation: 'æŸ¥çœ‹ (ç‰‡èª)', example: 'Check out the new car.', example_translation: 'çœ‹çœ‹é‚£å°æ–°è»Šã€‚' },
                    { word: 'check in', translation: 'ç™»è¨˜', example: 'Check in at the hotel.', example_translation: 'åœ¨æ—…é¤¨ç™»è¨˜ã€‚' }
                ]},
                { type: 'reading', question: "The truck ____ speed as it went downhill.", options: ["picked up", "picked on", "picked out", "picked off"], answer: 0, all_keywords: [
                    { word: 'picked up', translation: 'å¢åŠ  (ç‰‡èª)', example: 'The car picked up speed.', example_translation: 'è»Šå­åŠ é€Ÿäº†ã€‚' },
                    { word: 'picked on', translation: 'æ‰¾ç¢´', example: 'Don\'t pick on me.', example_translation: 'åˆ¥å°æˆ‘æ‰¾ç¢´ã€‚' },
                    { word: 'picked out', translation: 'æŒ‘é¸', example: 'She picked out a dress.', example_translation: 'å¥¹æŒ‘äº†ä¸€ä»¶è£™å­ã€‚' },
                    { word: 'picked off', translation: 'æ‘˜æ‰', example: 'Pick off the leaves.', example_translation: 'æ‘˜æ‰è‘‰å­ã€‚' }
                ]},
                { type: 'reading', question: "The soldiers were told to ____ the area.", options: ["fill in", "clear out", "clear up", "fill up"], answer: 1, all_keywords: [
                    { word: 'fill in', translation: 'å¡«å¯«', example: 'Fill in the form.', example_translation: 'å¡«å¯«è¡¨æ ¼ã€‚' },
                    { word: 'clear out', translation: 'æ¸…ç† (ç‰‡èª)', example: 'Clear out your locker.', example_translation: 'æ¸…ç†ä½ çš„ç½®ç‰©æ«ƒã€‚' },
                    { word: 'clear up', translation: 'æ¾„æ¸…ï¼›æ”¾æ™´', example: 'The weather cleared up.', example_translation: 'å¤©æ°£æ”¾æ™´äº†ã€‚' },
                    { word: 'fill up', translation: 'å¡«æ»¿', example: 'Fill up the tank.', example_translation: 'åŠ æ»¿æ²¹ç®±ã€‚' }
                ]},
                { type: 'reading', question: "He will ____ for the missing soldier.", options: ["look for", "look after", "look at", "look like"], answer: 0, all_keywords: [
                    { word: 'look for', translation: 'å°‹æ‰¾ (ç‰‡èª)', example: 'Look for your keys.', example_translation: 'æ‰¾ä½ çš„é‘°åŒ™ã€‚' },
                    { word: 'look after', translation: 'ç…§é¡§', example: 'Look after the baby.', example_translation: 'ç…§é¡§å¯¶å¯¶ã€‚' },
                    { word: 'look at', translation: 'çœ‹è‘—', example: 'Look at the map.', example_translation: 'çœ‹åœ°åœ–ã€‚' },
                    { word: 'look like', translation: 'çœ‹èµ·ä¾†åƒ', example: 'He looks like his father.', example_translation: 'ä»–é•·å¾—åƒä»–çˆ¶è¦ªã€‚' }
                ]},
                { type: 'reading', question: "The supplies will ____ by tomorrow.", options: ["go on", "run out", "run in", "go back"], answer: 1, all_keywords: [
                    { word: 'go on', translation: 'ç¹¼çºŒ', example: 'Go on with your story.', example_translation: 'ç¹¼çºŒä½ çš„æ•…äº‹ã€‚' },
                    { word: 'run out', translation: 'ç”¨å®Œ (ç‰‡èª)', example: 'Supplies are running out.', example_translation: 'ç‰©è³‡å¿«ç”¨å®Œäº†ã€‚' },
                    { word: 'run in', translation: 'è·‘é€²', example: 'Run in the rain.', example_translation: 'åœ¨é›¨ä¸­è·‘æ­¥ã€‚' },
                    { word: 'go back', translation: 'å›å»', example: 'Go back home.', example_translation: 'å›å®¶å§ã€‚' }
                ]},
                { type: 'reading', question: "We should ____ the meeting until Monday.", options: ["put on", "put out", "put off", "put away"], answer: 2, all_keywords: [
                    { word: 'put on', translation: 'ç©¿ä¸Š', example: 'Put on your shoes.', example_translation: 'ç©¿é‹ã€‚' },
                    { word: 'put out', translation: 'ç†„æ»…', example: 'Put out the light.', example_translation: 'é—œç‡ˆã€‚' },
                    { word: 'put off', translation: 'å»¶æœŸ (ç‰‡èª)', example: 'Don\'t put off the task.', example_translation: 'åˆ¥å»¶èª¤ä»»å‹™ã€‚' },
                    { word: 'put away', translation: 'æ”¶å¥½', example: 'Put away your toys.', example_translation: 'æŠŠç©å…·æ”¶å¥½ã€‚' }
                ]},
                { type: 'reading', question: "He needs to ____ his resume before the interview.", options: ["fix up", "follow up", "fill up", "face up"], answer: 0, all_keywords: [
                    { word: 'fix up', translation: 'æ•´ç†ï¼›ä¿®ç† (ç‰‡èª)', example: 'I need to fix up my car.', example_translation: 'æˆ‘éœ€è¦ä¿®ç†æˆ‘çš„è»Šã€‚' },
                    { word: 'follow up', translation: 'è·Ÿé€²', example: 'Follow up the email.', example_translation: 'è·Ÿé€²é‚£å°éƒµä»¶ã€‚' },
                    { word: 'fill up', translation: 'åŠ æ»¿', example: 'Fill up the tank.', example_translation: 'åŠ æ»¿æ²¹ã€‚' },
                    { word: 'face up', translation: 'é¢å°', example: 'Face up to the truth.', example_translation: 'é¢å°ç¾å¯¦ã€‚' }
                ]},
                { type: 'reading', question: "The airplane is about to ____.", options: ["take over", "take in", "take off", "take out"], answer: 2, all_keywords: [
                    { word: 'take over', translation: 'æ¥æ‰‹', example: 'Take over the controls.', example_translation: 'æ¥ç®¡æ§åˆ¶æ¬Šã€‚' },
                    { word: 'take in', translation: 'å¸æ”¶', example: 'Take in the view.', example_translation: 'é£½è¦½æ™¯è‰²ã€‚' },
                    { word: 'take off', translation: 'èµ·é£› (ç‰‡èª)', example: 'The plane took off.', example_translation: 'é£›æ©Ÿèµ·é£›äº†ã€‚' },
                    { word: 'take out', translation: 'æ‹¿å‡º', example: 'Take out the trash.', example_translation: 'å€’åƒåœ¾ã€‚' }
                ]},
                { type: 'reading', question: "You should ____ the form and sign it.", options: ["fill out", "find out", "figure out", "fall out"], answer: 0, all_keywords: [
                    { word: 'fill out', translation: 'å¡«å¯« (ç‰‡èª)', example: 'Fill out the form.', example_translation: 'å¡«å¯«é€™å¼µè¡¨ã€‚' },
                    { word: 'find out', translation: 'ç™¼ç¾', example: 'Find out the truth.', example_translation: 'æŸ¥æ˜çœŸç›¸ã€‚' },
                    { word: 'figure out', translation: 'ç†è§£', example: 'Figure out the math.', example_translation: 'è§£é–‹é€™é¡Œæ•¸å­¸ã€‚' },
                    { word: 'fall out', translation: 'çˆ­åµï¼›æ‰å‡º', example: 'They fell out.', example_translation: 'ä»–å€‘åµæ¶äº†ã€‚' }
                ]},
                { type: 'reading', question: "Can you ____ what happened yesterday?", options: ["point at", "point out", "point to", "point off"], answer: 1, all_keywords: [
                    { word: 'point at', translation: 'æŒ‡è‘—', example: 'Don\'t point at people.', example_translation: 'åˆ¥ç”¨æ‰‹æŒ‡äººã€‚' },
                    { word: 'point out', translation: 'æŒ‡å‡º (ç‰‡èª)', example: 'He pointed out my error.', example_translation: 'ä»–æŒ‡å‡ºäº†æˆ‘çš„éŒ¯èª¤ã€‚' },
                    { word: 'point to', translation: 'æŒ‡å‘', example: 'Point to the map.', example_translation: 'æŒ‡å‘åœ°åœ–ã€‚' },
                    { word: 'point off', translation: 'ç„¡æ­¤ç”¨æ³•', example: 'N/A', example_translation: 'N/A' }
                ]},
                { type: 'reading', question: "The General will ____ the base next week.", options: ["stop by", "stop at", "stop off", "stop in"], answer: 0, all_keywords: [
                    { word: 'stop by', translation: 'é †é“æ‹œè¨ª (ç‰‡èª)', example: 'Stop by my office.', example_translation: 'é †ä¾¿ä¾†æˆ‘è¾¦å…¬å®¤ã€‚' },
                    { word: 'stop at', translation: 'åœåœ¨', example: 'Stop at the sign.', example_translation: 'åœ¨æ¨™èªŒå‰åœä¸‹ã€‚' },
                    { word: 'stop off', translation: 'ä¸­é€”åœç•™', example: 'Stop off at the shop.', example_translation: 'åœ¨ä¸­é€”å•†åº—åœä¸€ä¸‹ã€‚' },
                    { word: 'stop in', translation: 'çŸ­æš«è¨ªå•', example: 'He stopped in.', example_translation: 'ä»–çŸ­æš«é€ è¨ªã€‚' }
                ]},
                { type: 'reading', question: "I will ____ the data one more time.", options: ["go through", "go over", "go in", "go by"], answer: 1, all_keywords: [
                    { word: 'go through', translation: 'ç¶“æ­·ï¼›å¯©æŸ¥', example: 'Go through the list.', example_translation: 'çœ‹éæ¸…å–®ã€‚' },
                    { word: 'go over', translation: 'è¤‡ç¿’ï¼›æª¢æŸ¥ (ç‰‡èª)', example: 'Go over your notes.', example_translation: 'è¤‡ç¿’ç­†è¨˜ã€‚' },
                    { word: 'go in', translation: 'é€²å…¥', example: 'Go in the room.', example_translation: 'é€²æˆ¿ã€‚' },
                    { word: 'go by', translation: 'ç¶“é', example: 'Time goes by.', example_translation: 'æ™‚é–“é£›é€ã€‚' }
                ]},
                { type: 'reading', question: "The mission was ____ because of the weather.", options: ["called off", "called out", "called on", "called for"], answer: 0, all_keywords: [
                    { word: 'called off', translation: 'å–æ¶ˆ (ç‰‡èª)', example: 'The trip was called off.', example_translation: 'æ—…è¡Œå–æ¶ˆäº†ã€‚' },
                    { word: 'called out', translation: 'å‘¼å«', example: 'He called out.', example_translation: 'ä»–å¤§å–Šã€‚' },
                    { word: 'called on', translation: 'é»åï¼›è¨ªå•', example: 'The teacher called on me.', example_translation: 'è€å¸«é»æˆ‘åã€‚' },
                    { word: 'called for', translation: 'éœ€è¦', example: 'It calls for help.', example_translation: 'é€™éœ€è¦å¹«åŠ©ã€‚' }
                ]},
                { type: 'reading', question: "You need to ____ the engine before you drive.", options: ["warm up", "wake up", "wash up", "write up"], answer: 0, all_keywords: [
                    { word: 'warm up', translation: 'ç†±æ©Ÿ (ç‰‡èª)', example: 'Warm up the car.', example_translation: 'å…ˆç†±è»Šã€‚' },
                    { word: 'wake up', translation: 'é†’ä¾†', example: 'Wake up early.', example_translation: 'æ—©é»é†’ä¾†ã€‚' },
                    { word: 'wash up', translation: 'æ´—æ‰‹', example: 'Wash up for dinner.', example_translation: 'æ´—æ‰‹åƒæ™šé¤ã€‚' },
                    { word: 'write up', translation: 'å¯«æˆå ±å‘Š', example: 'Write up the report.', example_translation: 'æŠŠå ±å‘Šå¯«å¥½ã€‚' }
                ]},
                { type: 'reading', question: "He finally ____ a good idea.", options: ["came up with", "came across", "came back", "came on"], answer: 0, all_keywords: [
                    { word: 'came up with', translation: 'æƒ³å‡º (ç‰‡èª)', example: 'He came up with a plan.', example_translation: 'ä»–æƒ³å‡ºäº†ä¸€å€‹è¨ˆç•«ã€‚' },
                    { word: 'came across', translation: 'å¶ç„¶ç™¼ç¾', example: 'I came across a photo.', example_translation: 'æˆ‘å¶ç„¶ç™¼ç¾ä¸€å¼µç…§ç‰‡ã€‚' },
                    { word: 'came back', translation: 'å›ä¾†', example: 'Come back soon.', example_translation: 'å¿«é»å›ä¾†ã€‚' },
                    { word: 'came on', translation: 'åŠ æ²¹', example: 'Come on!', example_translation: 'åŠ æ²¹ï¼' }
                ]},
                { type: 'reading', question: "Don't ____! You can do it.", options: ["give up", "give in", "give away", "give back"], answer: 0, all_keywords: [
                    { word: 'give up', translation: 'æ”¾æ£„ (ç‰‡èª)', example: 'Never give up.', example_translation: 'æ°¸ä¸æ”¾æ£„ã€‚' },
                    { word: 'give in', translation: 'å±ˆæœ', example: 'Don\'t give in.', example_translation: 'åˆ¥å±ˆæœã€‚' },
                    { word: 'give away', translation: 'è´ˆé€', example: 'Give away books.', example_translation: 'è´ˆæ›¸ã€‚' },
                    { word: 'give back', translation: 'æ­¸é‚„', example: 'Give back the pen.', example_translation: 'æ­¸é‚„é€™æ”¯ç­†ã€‚' }
                ]}
            ],
            'quiz2': [
                { type: 'reading', question: "If the reinforcements ____ on time, we would have won.", translation: "å¦‚æœæ´è»æº–æ™‚____ï¼Œæˆ‘å€‘æœ¬ä¾†æœƒè´çš„ã€‚", options: ["have arrived", "arrived", "had arrived", "would arrive"], answer: 2, all_keywords: [
                    { word: 'have arrived', translation: 'å·²ç¶“åˆ°é”', example: 'They have arrived.', example_translation: 'ä»–å€‘åˆ°äº†ã€‚' },
                    { word: 'arrived', translation: 'åˆ°é”', example: 'They arrived late.', example_translation: 'ä»–å€‘é²åˆ°äº†ã€‚' },
                    { word: 'had arrived', translation: 'å·²ç¶“åˆ°é” (éå»å®Œæˆ)', example: 'If he had arrived earlier...', example_translation: 'å¦‚æœä»–æ—©é»åˆ°...' },
                    { word: 'would arrive', translation: 'å°‡æœƒåˆ°é”', example: 'He would arrive soon.', example_translation: 'ä»–å¿«åˆ°äº†ã€‚' }
                ]}
            ],
            'quiz3': [
                { type: 'listening', question: "Man: Is the fuel truck ready?\nWoman: Not yet, it's being inspected.\n\n(Narrator): What is happening to the truck?", translation: "ç”·ï¼šæ²¹ç½è»Šæº–å‚™å¥½äº†å—ï¼Ÿ\nå¥³ï¼šé‚„æ²’ï¼Œæ­£åœ¨æ¥å—æª¢æŸ¥ã€‚\n\n(æ—ç™½)ï¼šé€™è¼›å¡è»Šæ­£åœ¨ç™¼ç”Ÿä»€éº¼äº‹ï¼Ÿ", options: ["(A) It is being filled.", "(B) It is being checked.", "(C) It is being washed.", "(D) It is being driven."], answer: 1, all_keywords: [
                    { word: 'inspected', translation: 'æª¢æŸ¥ (å–®å­—)', example: 'The car was inspected.', example_translation: 'è»Šå­å—æª¢äº†ã€‚' },
                    { word: 'checked', translation: 'æ ¸å° (å–®å­—)', example: 'Check the list.', example_translation: 'æ ¸å°æ¸…å–®ã€‚' }
                ]}
            ]
        };

        const synth = new Tone.Synth().toDestination();

        // --- Core Functions ---
        async function initializeAppFirebase() {
            try {
                const userProvidedConfig = {
                    apiKey: "AIzaSyDQSAW63lnKd3aCCiCt7pSmRa6ZPqOiIZI",
                    authDomain: "alcpt-f9d8d.firebaseapp.com",
                    projectId: "alcpt-f9d8d",
                    storageBucket: "alcpt-f9d8d.firebasestorage.app",
                    messagingSenderId: "885828022963",
                    appId: "1:885828022963:web:b18d3e49a19d3840d5b6c6"
                };

                const config = (typeof __firebase_config !== 'undefined' && __firebase_config) 
                    ? JSON.parse(__firebase_config) 
                    : userProvidedConfig;

                app = initializeApp(config);
                db = getFirestore(app);
                auth = getAuth(app);
                const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'github-ecl-app';

                await signInAnonymously(auth);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        loadFavoriteKeywords(currentAppId, userId);
                        showScreen('welcome-screen');
                    }
                });

            } catch (error) {
                console.error("Firebase Init Error:", error);
                document.getElementById('loading-text').innerHTML = `è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª Firebase è¨­å®šã€‚<br><small>${error.message}</small>`;
            }
        }

        function loadFavoriteKeywords(id, uid) {
            if (firestoreUnsubscribe) firestoreUnsubscribe();
            const colRef = collection(db, 'artifacts', id, 'users', uid, 'favorites');
            firestoreUnsubscribe = onSnapshot(colRef, (snap) => {
                favoriteKeywords = snap.docs.map(doc => doc.data());
                // å³æ™‚é‡æ–°æ¸²æŸ“è§£ææ¸…å–®ä¸­çš„æ„›å¿ƒ
                const currentQ = currentQuestions[currentQuestionIndex];
                if (currentQ && document.getElementById('keywords-display').innerHTML !== '') {
                    renderKeywords(currentQ.all_keywords);
                }
                if (document.getElementById('favorites-modal').style.display === 'flex') showFavoritesModal();
            }, (err) => console.error("Firestore Listen Error:", err));
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => {
                s.style.display = 'none';
                s.classList.remove('active-screen');
            });
            const target = document.getElementById(id);
            if (target) {
                target.style.display = 'flex';
                target.classList.add('active-screen');
            }
        }

        function startQuiz(quizId) {
            if (!isAuthReady) return;
            currentTest = quizId;
            currentQuestionIndex = 0;
            score = 0;
            currentQuestions = [...alcptQuizBanks[quizId]].sort(() => Math.random() - 0.5);
            
            const titles = { quiz1: 'é¡Œåº«(ä¸€): è©å½™ç‰‡èª', quiz2: 'é¡Œåº«(äºŒ): æ–‡æ³•çµæ§‹', quiz3: 'é¡Œåº«(ä¸‰): è½åŠ›è…³æœ¬' };
            document.getElementById('test-title').textContent = titles[quizId];
            
            loadQuestion();
            startTimer(currentQuestions.length * 45);
            showScreen('test-screen');
        }

        // æ™ºæ…§å‹å–®å­—åŒ…è£ï¼šå°‡é¡Œç›®ä¸­çš„è‹±æ–‡å–®å­—è½‰ç‚ºå¯é»é¸é€£çµ
        function wrapWords(text) {
            return text.split(' ').map(word => {
                const cleanWord = word.replace(/[.,!?;:()]/g, "").toLowerCase();
                return `<span class="clickable-word" data-word="${cleanWord}" onclick="handleWordClick(this, '${cleanWord}')">${word}</span>`;
            }).join(' ');
        }

        // é»é¸é¡Œç›®å–®å­—è™•ç†é‚è¼¯
        function handleWordClick(element, word) {
            document.querySelectorAll('.clickable-word').forEach(el => el.classList.remove('word-highlight'));
            element.classList.add('word-highlight');

            const tooltip = document.getElementById('word-tooltip');
            const content = document.getElementById('tooltip-content');
            const currentQ = currentQuestions[currentQuestionIndex];

            // ç‰‡èªåŒ¹é…é‚è¼¯ï¼šæª¢æŸ¥é»é¸çš„å­—æ˜¯å¦ç‚ºé¡Œåº«ç‰‡èªçš„ä¸€éƒ¨åˆ†
            let found = currentQ.all_keywords?.find(kw => kw.word.toLowerCase() === word);
            
            // å¦‚æœæ²’ç›´æ¥åŒ¹é…ï¼Œå˜—è©¦æ¨¡ç³ŠåŒ¹é…ç‰‡èª (å¦‚é»é¸ "look" åŒ¹é… "look into")
            if (!found) {
                found = currentQ.all_keywords?.find(kw => kw.word.toLowerCase().includes(word));
            }

            if (found) {
                content.innerHTML = `<strong>${found.word}</strong>: ${found.translation}`;
            } else {
                content.innerHTML = `<strong>${word}</strong>: (é»é¸ä¸‹æ–¹ã€Œå…¨é¸é …è§£æã€æŸ¥çœ‹å®Œæ•´å…§å®¹)`;
            }
            
            tooltip.classList.remove('hidden');
            speak(word); // è‡ªå‹•æ’­æ”¾ç™¼éŸ³
        }

        function loadQuestion() {
            document.getElementById('next-button').disabled = true;
            document.getElementById('options-container').innerHTML = '';
            document.getElementById('post-answer-actions').innerHTML = '';
            document.getElementById('post-answer-display').innerHTML = '';
            document.getElementById('keywords-display').innerHTML = '';
            document.getElementById('word-tooltip').classList.add('hidden');
            
            const q = currentQuestions[currentQuestionIndex];
            const progress = (currentQuestionIndex / currentQuestions.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('question-counter').textContent = `Q: ${currentQuestionIndex + 1}/${currentQuestions.length}`;
            
            document.getElementById('question-text').innerHTML = wrapWords(q.question).replace(/\n/g, '<br>');
            
            q.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = 'w-full p-4 text-left bg-gray-700 hover:bg-gray-600 rounded-lg border-2 border-gray-600 transition duration-200';
                btn.textContent = opt;
                btn.onclick = () => selectAnswer(idx);
                document.getElementById('options-container').appendChild(btn);
            });
        }

        function selectAnswer(idx) {
            const q = currentQuestions[currentQuestionIndex];
            const isCorrect = idx === q.answer;
            if (isCorrect) score++;
            
            const btns = document.getElementById('options-container').querySelectorAll('button');
            btns.forEach((b, i) => {
                b.disabled = true;
                if (i === q.answer) b.classList.add('correct-answer');
                else if (i === idx) b.classList.add('incorrect-answer');
            });

            const correctText = q.options[q.answer];
            const ttsText = q.type === 'listening' ? q.question.split('(Narrator):')[1]?.trim() || q.question : q.question.replace('____', correctText);
            const escapedTTS = ttsText.replace(/'/g, "\\'").replace(/\n/g, ' ');

            document.getElementById('post-answer-display').innerHTML = `
                <div class="p-4 bg-gray-900 rounded-xl border border-gray-700 shadow-inner">
                    <div class="flex justify-between items-center mb-3">
                         <p class="font-bold text-yellow-400">è§£ç­”è§£æ (å¯è½é¡Œç›®ç™¼éŸ³)ï¼š</p>
                         <button onclick="speak('${escapedTTS}')" class="speaker-btn" title="è½å…¨å¥ç™¼éŸ³">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072M20 4a9 9 0 010 16M4 4a9 9 0 0116 0" /></svg>
                         </button>
                    </div>
                    <p class="text-gray-300 italic mb-2">${q.type === 'listening' ? q.question.replace(/\n/g, '<br>') : q.question.replace('____', `<span class='text-yellow-400 font-bold underline'>${correctText}</span>`)}</p>
                    <button onclick="this.nextElementSibling.classList.toggle('hidden')" class="text-xs text-cyan-400 underline">é¡¯ç¤ºç¿»è­¯</button>
                    <p class="hidden text-gray-400 mt-2 text-sm">${q.translation ? q.translation.replace('____', correctText) : 'æš«ç„¡ç¿»è­¯'}</p>
                </div>
            `;

            const kwBtn = document.createElement('button');
            kwBtn.className = 'bg-teal-600 hover:bg-teal-500 text-white font-bold py-2 px-6 rounded-lg transition shadow-lg';
            kwBtn.textContent = 'æŸ¥çœ‹å…¨é¸é …è§£æèˆ‡ä¾‹å¥';
            kwBtn.onclick = () => renderKeywords(q.all_keywords);
            document.getElementById('post-answer-actions').appendChild(kwBtn);

            document.getElementById('next-button').disabled = false;
            playSound(isCorrect ? 'correct' : 'incorrect');
        }

        function renderKeywords(keywords) {
            if (!keywords) return;
            let html = '<div class="space-y-3 mt-4 animate-fade-in">';
            keywords.forEach(kw => {
                const isFav = favoriteKeywords.some(f => f.word === kw.word);
                const kwJSON = JSON.stringify(kw).replace(/'/g, "\\'");
                const escapedWord = kw.word.replace(/'/g, "\\'");
                const escapedExample = kw.example.replace(/'/g, "\\'");
                
                html += `
                    <div class="p-4 bg-gray-700 rounded-lg border border-gray-600 shadow-md">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center space-x-3">
                                <span class="text-teal-300 font-bold text-lg">${kw.word}</span>
                                <button onclick="speak('${escapedWord}')" class="speaker-btn p-1 h-7 w-7" title="å–®å­—ç™¼éŸ³">
                                    <svg fill="currentColor" viewBox="0 0 20 20"><path d="M11 5L6 9H2v2h4l5 4V5z"/></svg>
                                </button>
                                <span class="text-gray-300 font-medium">${kw.translation}</span>
                            </div>
                            <!-- æ”¹è‰¯ç‰ˆæ„›å¿ƒæ”¶è—æŒ‰éˆ• -->
                            <button onclick='toggleFavorite(${kwJSON})' class="hover:scale-110 transition p-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 ${isFav?'text-red-500':'text-gray-500 opacity-50'}" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                        </div>
                        <div class="bg-gray-800 p-2 rounded border border-gray-600 mt-2">
                            <div class="flex items-center space-x-2">
                                <p class="text-xs text-gray-400 italic flex-grow">${kw.example}</p>
                                <button onclick="speak('${escapedExample}')" class="text-blue-400 hover:text-blue-300" title="ä¾‹å¥ç™¼éŸ³">
                                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path d="M11 5L6 9H2v2h4l5 4V5z"/></svg>
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">${kw.example_translation}</p>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            document.getElementById('keywords-display').innerHTML = html;
        }

        async function toggleFavorite(kw) {
            const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'github-ecl-app';
            // å®‰å…¨è™•ç† IDï¼šç§»é™¤ç©ºæ ¼èˆ‡æ‰€æœ‰ç‰¹æ®Šç¬¦è™Ÿï¼Œç¢ºä¿ Firestore è·¯å¾‘åˆæ³•
            const docId = kw.word.replace(/[^a-zA-Z0-9]/g, '_');
            const docRef = doc(db, 'artifacts', currentAppId, 'users', userId, 'favorites', docId);
            
            const isAlreadyFav = favoriteKeywords.some(f => f.word === kw.word);
            try {
                if (isAlreadyFav) {
                    await deleteDoc(docRef);
                } else {
                    await setDoc(docRef, kw);
                }
            } catch (err) {
                console.error("æ”¶è—æ“ä½œå¤±æ•—:", err);
            }
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < currentQuestions.length) loadQuestion();
            else finishQuiz();
        }

        function finishQuiz() {
            clearInterval(timerInterval);
            const accuracy = Math.round((score / currentQuestions.length) * 100);
            if (accuracy >= 80) quizPassStatus[currentTest] = true;
            const allPassed = quizPassStatus.quiz1 && quizPassStatus.quiz2 && quizPassStatus.quiz3;
            const titleEl = document.getElementById('module-complete-title');
            const msgEl = document.getElementById('module-complete-message');
            titleEl.textContent = accuracy >= 80 ? "æ¸¬é©—é€šéï¼(Passed)" : "æœªé€šé (Failed)";
            titleEl.className = `text-2xl sm:text-3xl font-bold mb-4 ${accuracy >= 80?'text-green-400':'text-red-400'}`;
            let finalMsg = `å¾—åˆ†ç‡ï¼š${accuracy}%. (${score}/${currentQuestions.length} é¡Œ)`;
            if (accuracy >= 80) {
                finalMsg += `<br><span class="text-green-300 font-bold">æ­å–œï¼æ‚¨å·²é”æ¨™ã€‚</span>`;
                if (allPassed) finalMsg += `<br><br><div class="p-4 bg-yellow-900 border border-yellow-500 rounded-lg text-yellow-200 font-bold shadow-xl">æ­å–œé€šéæœ¬æ—¥æ‰€æœ‰ ECL ç·´ç¿’ï¼ä¸è¦å¿˜è¨˜åˆ°ã€Œæˆ‘çš„æœ€æ„›ã€å€è¤‡ç¿’å–”ï¼</div>`;
                playSound('success');
            } else {
                finalMsg += `<br><span class="text-red-300 font-bold">å¾ˆéºæ†¾ï¼ŒECL æ¨™æº–éœ€é” 80%ã€‚<br>è«‹å†æ¸¬é©—ä¸€æ¬¡ åŠ å¼·ç·´ç¿’ï¼</span>`;
            }
            msgEl.innerHTML = finalMsg;
            document.getElementById('module-score').textContent = `${accuracy}%`;
            showScreen('practice-complete-screen');
        }

        function startTimer(sec) {
            currentTimerValue = sec;
            updateTimerUI();
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (!isTestPaused) {
                    currentTimerValue--;
                    updateTimerUI();
                    if (currentTimerValue <= 0) { clearInterval(timerInterval); finishQuiz(); }
                }
            }, 1000);
        }

        function updateTimerUI() {
            const m = Math.floor(currentTimerValue / 60);
            const s = currentTimerValue % 60;
            document.getElementById('timer').textContent = `${m}:${s < 10 ? '0' + s : s}`;
        }

        function pauseTest() { isTestPaused = true; showFavoritesModal(); }
        
        function requestExitConfirmation() {
            isTestPaused = true;
            document.getElementById('exit-confirm-modal').style.display = 'flex';
            setTimeout(() => document.getElementById('exit-confirm-card').classList.add('active'), 10);
        }

        function cancelExit() {
            document.getElementById('exit-confirm-card').classList.remove('active');
            setTimeout(() => { document.getElementById('exit-confirm-modal').style.display = 'none'; isTestPaused = false; }, 300);
        }

        function confirmExit() {
            clearInterval(timerInterval);
            document.getElementById('exit-confirm-modal').style.display = 'none';
            backToWelcome();
        }

        function backToWelcome() {
            const updateBtn = (id, passed) => {
                const btn = document.getElementById(id);
                if (passed) {
                    btn.className = `w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300`;
                    if (!btn.textContent.includes('(å·²é€šé)')) btn.textContent += ' (å·²é€šé)';
                }
            };
            updateBtn('btn-quiz1', quizPassStatus.quiz1);
            updateBtn('btn-quiz2', quizPassStatus.quiz2);
            updateBtn('btn-quiz3', quizPassStatus.quiz3);
            showScreen('welcome-screen');
        }

        async function restartMission() {
            const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'github-ecl-app';
            const snaps = await getDocs(collection(db, 'artifacts', currentAppId, 'users', userId, 'favorites'));
            const batch = writeBatch(db);
            snaps.forEach(d => batch.delete(d.ref));
            await batch.commit();
            location.reload();
        }

        function speak(txt) {
            if (!txt) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(txt);
            u.lang = 'en-US';
            u.rate = 0.85;
            window.speechSynthesis.speak(u);
        }

        function playSound(type) {
            try {
                if (type === 'correct') synth.triggerAttackRelease("C5", "8n");
                else if (type === 'incorrect') synth.triggerAttackRelease("A3", "8n");
                else if (type === 'success') {
                    const now = Tone.now();
                    synth.triggerAttackRelease("C4", "8n", now);
                    synth.triggerAttackRelease("E4", "8n", now + 0.1);
                    synth.triggerAttackRelease("G4", "8n", now + 0.2);
                }
            } catch(e) {}
        }

        function showFavoritesModal() {
            const list = document.getElementById('favorites-list');
            list.innerHTML = favoriteKeywords.length === 0 ? '<p class="text-gray-500 text-center py-10">å°šç„¡æ”¶è—å–®å­—</p>' : '';
            favoriteKeywords.forEach(kw => {
                const item = document.createElement('div');
                item.className = 'p-4 bg-gray-900 rounded-lg border border-gray-700 mb-2 flex justify-between items-center';
                item.innerHTML = `
                    <div>
                        <div class="flex items-center space-x-2">
                            <p class="text-teal-300 font-bold text-lg">${kw.word}</p>
                            <button onclick="speak('${kw.word.replace(/'/g, "\\'")}')" class="text-blue-400 hover:text-blue-300"><svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path d="M11 5L6 9H2v2h4l5 4V5z"/></svg></button>
                        </div>
                        <p class="text-gray-400 text-sm">${kw.translation}</p>
                    </div>
                    <button onclick='toggleFavorite(${JSON.stringify(kw).replace(/'/g, "\\'")})' class="text-red-500 font-bold px-3 py-1 bg-red-900 bg-opacity-30 rounded hover:bg-opacity-50 transition">ç§»é™¤</button>`;
                list.appendChild(item);
            });
            document.getElementById('favorites-modal').style.display = 'flex';
            setTimeout(() => document.getElementById('favorites-card').classList.add('active'), 10);
        }

        function hideFavoritesModal() {
            document.getElementById('favorites-card').classList.remove('active');
            setTimeout(() => { document.getElementById('favorites-modal').style.display = 'none'; isTestPaused = false; }, 300);
        }

        // Global exports for HTML attributes
        window.startQuiz = startQuiz;
        window.nextQuestion = nextQuestion;
        window.backToWelcome = backToWelcome;
        window.restartMission = restartMission;
        window.speak = speak;
        window.showFavoritesModal = showFavoritesModal;
        window.hideFavoritesModal = hideFavoritesModal;
        window.toggleFavorite = toggleFavorite;
        window.pauseTest = pauseTest;
        window.requestExitConfirmation = requestExitConfirmation;
        window.cancelExit = cancelExit;
        window.confirmExit = confirmExit;
        window.handleWordClick = handleWordClick;

        window.onload = initializeAppFirebase;
    </script>
</body>
</html>
